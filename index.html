<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>â™  All In Poker Tracker</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

<style>
  :root {
    --gold: #C9A84C;
    --gold-light: #E8C97A;
    --gold-dark: #8A6B28;
    --green: #1A3A2A;
    --green-felt: #0D2B1A;
    --anthracite: #141416;
    --anthracite-light: #1E1E22;
    --surface: #1A1A1E;
    --surface-raised: #232328;
    --text-primary: #F0E6CC;
    --text-muted: #7A7060;
    --red-suit: #C0392B;
    --chip-red: #C0392B;
    --chip-blue: #2980B9;
    --chip-green: #1E8449;
    --chip-white: #D5D8DC;
    --chip-black: #212121;
  }

  /* â”€â”€ LIGHT MODE â”€â”€ */
  body.light-mode {
    --anthracite: #f5f5f5;
    --anthracite-light: #ebebeb;
    --surface: #ffffff;
    --surface-raised: #ffffff;
    --text-primary: #1a1a1a;
    --text-muted: #666666;
    --gold: #7a5c1e;
    --gold-light: #5a4010;
    --gold-dark: #c9a84c;
    --green: #f0f7f2;
    --green-felt: #e0f0e8;
  }
  body.light-mode {
    background-color: #f5f5f5;
    background-image: none;
  }
  body.light-mode .card,
  body.light-mode .card-raised {
    background: #ffffff;
    border-color: rgba(0,0,0,0.1);
    box-shadow: 0 2px 12px rgba(0,0,0,0.07);
  }
  body.light-mode .stat-card {
    background: #ffffff;
    border-color: rgba(0,0,0,0.1);
  }
  body.light-mode .session-night-card {
    background: #ffffff;
    border-color: rgba(0,0,0,0.1);
  }
  body.light-mode .player-row {
    border-color: rgba(0,0,0,0.08);
  }
  body.light-mode .input-field {
    background: #ffffff;
    border-color: rgba(0,0,0,0.2);
    color: #1a1a1a;
  }
  body.light-mode .tab-bar {
    background: #ffffff;
    border-color: rgba(0,0,0,0.1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  body.light-mode .tab-btn {
    color: #888;
  }
  body.light-mode .tab-btn.active {
    background: linear-gradient(160deg, rgba(201,168,76,0.15), rgba(201,168,76,0.05));
    border-color: rgba(122,92,30,0.4);
    color: #5a4010;
  }
  body.light-mode .badge-card.unlocked {
    background: #fff8ee;
    border-color: rgba(122,92,30,0.3);
  }
  body.light-mode .badge-card.locked {
    background: #f5f5f5;
    border-color: rgba(0,0,0,0.08);
  }
  body.light-mode .suit-watermark {
    opacity: 0.06;
  }
  body.light-mode #statusBadge {
    background: rgba(255,255,255,0.9);
    border-color: rgba(0,0,0,0.12);
  }
  body.light-mode #themeToggle {
    background: rgba(255,255,255,0.9);
    border-color: rgba(0,0,0,0.12);
  }
  body.light-mode .session-detail-inner {
    background: #fafafa;
  }
  body.light-mode .pot-summary {
    background: #f5f5f5;
    border-color: rgba(0,0,0,0.08);
  }
  body.light-mode .year-pill {
    background: #ffffff;
    border-color: rgba(0,0,0,0.15);
    color: #444;
  }
  body.light-mode .year-pill.active {
    background: rgba(201,168,76,0.15);
    border-color: rgba(122,92,30,0.5);
    color: #5a4010;
  }


  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background-color: var(--anthracite);
    color: var(--text-primary);
    font-family: 'Crimson Text', Georgia, serif;
    min-height: 100vh;
    overflow-x: hidden;
    background-image:
      radial-gradient(ellipse at 15% 0%, rgba(13,43,26,0.55) 0%, transparent 45%),
      radial-gradient(ellipse at 85% 100%, rgba(201,168,76,0.07) 0%, transparent 45%),
      radial-gradient(ellipse at 50% 50%, rgba(26,58,42,0.15) 0%, transparent 70%),
      url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none'%3E%3Cg fill='%23C9A84C' fill-opacity='0.022'%3E%3Cpath d='M40 0 L42 14 L56 8 L46 20 L60 22 L48 30 L58 40 L46 42 L52 56 L40 48 L34 62 L32 48 L18 54 L26 42 L12 40 L24 30 L14 18 L28 22 L20 8 L34 16z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  }

  .font-display { font-family: 'Cinzel', serif; }
  .gold-text { color: var(--gold); }
  .gold-light-text { color: var(--gold-light); }

  .card {
    background: var(--surface);
    border: 1px solid rgba(201,168,76,0.18);
    border-radius: 14px;
    box-shadow:
      0 4px 24px rgba(0,0,0,0.5),
      inset 0 1px 0 rgba(201,168,76,0.12),
      inset 0 -1px 0 rgba(0,0,0,0.3);
    position: relative;
    overflow: hidden;
  }
  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(201,168,76,0.4), transparent);
  }

  .card-raised {
    background: var(--surface-raised);
    border: 1px solid rgba(201,168,76,0.25);
    border-radius: 12px;
    box-shadow:
      0 8px 32px rgba(0,0,0,0.5),
      inset 0 1px 0 rgba(201,168,76,0.15),
      inset 0 -1px 0 rgba(0,0,0,0.3);
  }

  .btn-gold {
    background: linear-gradient(135deg, var(--gold-dark) 0%, var(--gold) 45%, var(--gold-light) 100%);
    color: #1a1400;
    font-family: 'Cinzel', serif;
    font-weight: 700;
    font-size: 0.85rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    padding: 13px 28px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 16px rgba(201,168,76,0.35), inset 0 1px 0 rgba(255,255,255,0.2);
  }
  .btn-gold:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 24px rgba(201,168,76,0.5), inset 0 1px 0 rgba(255,255,255,0.25);
    filter: brightness(1.08);
  }
  .btn-gold:active { transform: translateY(0); box-shadow: 0 1px 8px rgba(201,168,76,0.3); }

  .btn-danger {
    background: rgba(192,57,43,0.15);
    color: #e74c3c;
    border: 1px solid rgba(192,57,43,0.4);
    border-radius: 6px;
    padding: 4px 10px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.15s;
    font-family: 'Cinzel', serif;
  }
  .btn-danger:hover { background: rgba(192,57,43,0.3); }

  .input-field, .form-input {
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(201,168,76,0.25);
    border-radius: 8px;
    color: var(--text-primary);
    padding: 10px 14px;
    width: 100%;
    box-sizing: border-box;
    display: block;
    font-family: 'Crimson Text', serif;
    font-size: 1rem;
    transition: border-color 0.2s;
  }
  .input-field:focus, .form-input:focus {
    outline: none;
    border-color: var(--gold);
    box-shadow: 0 0 0 2px rgba(201,168,76,0.15);
  }
  .input-field option, .form-input option { background: #232325; }
  input[type="date"].input-field {
    -webkit-appearance: none;
    appearance: none;
    padding-right: 10px;
  }
  input[type="date"].input-field::-webkit-calendar-picker-indicator {
    filter: invert(0.7) sepia(1) saturate(3) hue-rotate(5deg);
    cursor: pointer;
  }

  .label {
    font-family: 'Cinzel', serif;
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--gold);
    display: block;
    margin-bottom: 6px;
  }

  .header-ornament {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .header-ornament::before, .header-ornament::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(201,168,76,0.6), transparent);
  }
  .suit { opacity: 0.15; font-size: 0.9rem; }

  /* â”€â”€ Poker chip SVG component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .poker-chip {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    flex-shrink: 0;
    position: relative;
  }

  /* â”€â”€ Felt table texture strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .felt-strip {
    background:
      radial-gradient(ellipse at center, rgba(13,43,26,0.9) 0%, rgba(8,28,18,0.95) 100%);
    border-top: 1px solid rgba(201,168,76,0.15);
    border-bottom: 1px solid rgba(201,168,76,0.15);
    position: relative;
    overflow: hidden;
  }
  .felt-strip::before {
    content: '';
    position: absolute;
    inset: 0;
    background: url("data:image/svg+xml,%3Csvg width='4' height='4' viewBox='0 0 4 4' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='1' cy='1' r='0.5' fill='%23ffffff' fill-opacity='0.03'/%3E%3C/svg%3E");
  }

  /* â”€â”€ Card suit watermarks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .suit-watermark {
    position: absolute;
    font-size: 6rem;
    opacity: 0.025;
    pointer-events: none;
    user-select: none;
    line-height: 1;
  }

  /* â”€â”€ Divider with suit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .suit-divider {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 16px 0;
    color: rgba(201,168,76,0.25);
    font-size: 0.75rem;
  }
  .suit-divider::before, .suit-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: rgba(201,168,76,0.12);
  }

  .tab-bar {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: auto auto;
    gap: 6px;
    margin-bottom: 0;
    padding: 10px;
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(201,168,76,0.18);
    border-bottom: none;
    border-radius: 12px 12px 0 0;
    box-shadow: 0 4px 16px rgba(0,0,0,0.4);
  }
  /* Tab content cards flush against tab-bar */
  #tab-form, #tab-chart, #tab-achievements, #tab-tournament {
    border-radius: 0 0 14px 14px !important;
  }
  #tab-sessions > .card,
  #tab-leaderboard > div > .card,
  #tab-leaderboard > .card {
    border-radius: 0 0 14px 14px !important;
  }
  /* Last row: 2 items centred */
  .tab-bar .tab-btn:nth-child(4),
  .tab-bar .tab-btn:nth-child(5) {
    grid-column: span 1;
  }
  .tab-bar-row2 {
    grid-column: 1 / -1;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 6px;
  }
  .tab-btn {
    font-family: 'Cinzel', serif;
    font-size: 0.68rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    padding: 9px 6px;
    border-radius: 9px;
    border: 1px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
    background: transparent;
    color: var(--text-muted);
    position: relative;
    line-height: 1.3;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    min-width: 0;
  }
  .tab-btn .tab-suit {
    font-size: 0.95rem;
    line-height: 1;
    display: block;
    transition: all 0.2s;
    opacity: 0.4;
  }
  .tab-btn .tab-label {
    display: block;
    font-size: 0.55rem;
    letter-spacing: 0.08em;
    white-space: nowrap;
  }
  .tab-btn:hover { color: var(--gold); }
  .tab-btn:hover .tab-suit { opacity: 0.8; transform: scale(1.15); }
  .tab-btn.active {
    background: linear-gradient(160deg, rgba(201,168,76,0.2), rgba(201,168,76,0.07));
    color: var(--gold-light);
    border-color: rgba(201,168,76,0.4);
    box-shadow: 0 2px 10px rgba(0,0,0,0.4), inset 0 1px 0 rgba(201,168,76,0.25);
  }
  .tab-btn.active .tab-suit { opacity: 1; }

  .profit-pos { color: #4ade80; }
  .profit-neg { color: #f87171; }
  .profit-neu { color: var(--text-muted); }

  .leaderboard-rank-1 { color: var(--gold-light); }
  .leaderboard-rank-2 { color: #C0C0C0; }
  .leaderboard-rank-3 { color: #CD7F32; }

  .chip {
    display: inline-block;
    width: 10px; height: 10px;
    border-radius: 50%;
    border: 2px dashed rgba(255,255,255,0.4);
    margin-right: 6px;
  }

  .toast {
    position: fixed;
    bottom: 24px; left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--surface-raised);
    border: 1px solid var(--gold);
    color: var(--gold-light);
    padding: 12px 24px;
    border-radius: 8px;
    font-family: 'Cinzel', serif;
    font-size: 0.8rem;
    z-index: 9999;
    transition: transform 0.3s ease;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6);
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  .scroll-table { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
  th {
    font-family: 'Cinzel', serif;
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--gold);
    padding: 10px 12px;
    text-align: left;
    border-bottom: 1px solid rgba(201,168,76,0.2);
  }
  td {
    padding: 10px 12px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    vertical-align: middle;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(201,168,76,0.04); }

  #chartContainer { position: relative; height: 320px; }

  .spinner {
    width: 20px; height: 20px;
    border: 2px solid rgba(201,168,76,0.3);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: inline-block;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
  }
  .status-dot.connected { background: #4ade80; box-shadow: 0 0 6px #4ade80; }
  .status-dot.disconnected { background: #f87171; }
  .status-dot.connecting { background: var(--gold); animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(201,168,76,0.3); border-radius: 4px; }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
    font-style: italic;
    font-size: 1.1rem;
  }

  .stat-card {
    background: linear-gradient(135deg, rgba(0,0,0,0.35), rgba(201,168,76,0.04));
    border: 1px solid rgba(201,168,76,0.18);
    border-radius: 10px;
    padding: 14px 10px;
    text-align: center;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
  }
  .stat-card::after {
    content: '';
    position: absolute;
    bottom: -10px; right: -10px;
    width: 40px; height: 40px;
    border-radius: 50%;
    border: 8px solid rgba(201,168,76,0.06);
  }
  .stat-value {
    font-family: 'Cinzel', serif;
    font-size: 1.15rem;
    font-weight: 700;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 2px;
  }
  .stat-label {
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
    font-family: 'Cinzel', serif;
  }

  /* Session List */
  .session-night-card {
    background: var(--surface-raised);
    border: 1px solid rgba(201,168,76,0.18);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.22s ease;
    margin-bottom: 10px;
    overflow: hidden;
    position: relative;
  }
  .session-night-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: linear-gradient(180deg, var(--gold-dark), var(--gold), var(--gold-dark));
    opacity: 0;
    transition: opacity 0.2s;
  }
  .session-night-card:hover {
    border-color: rgba(201,168,76,0.45);
    box-shadow: 0 6px 24px rgba(0,0,0,0.45);
    transform: translateY(-1px);
  }
  .session-night-card:hover::before { opacity: 1; }
  .session-night-header {
    padding: 14px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .session-night-chevron {
    transition: transform 0.25s ease;
    color: var(--gold);
    font-size: 0.75rem;
  }
  .session-night-chevron.open { transform: rotate(90deg); }

  /* Session Detail Panel */
  .session-detail-panel {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.35s ease;
    border-top: 0px solid rgba(201,168,76,0.15);
  }
  .session-detail-panel.open {
    max-height: 70vh;
    overflow-y: scroll;
    -webkit-overflow-scrolling: touch;
    border-top: 1px solid rgba(201,168,76,0.15);
  }
  .session-detail-inner { padding: 14px 16px 16px; }

  .player-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 11px 13px;
    border-radius: 9px;
    background: linear-gradient(135deg, rgba(0,0,0,0.25), rgba(201,168,76,0.03));
    margin-bottom: 8px;
    border: 1px solid rgba(255,255,255,0.05);
    transition: background 0.15s;
  }
  .player-row:hover { background: linear-gradient(135deg, rgba(0,0,0,0.3), rgba(201,168,76,0.06)); }
  .player-row:last-child { margin-bottom: 0; }

  .pot-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 14px;
    border-radius: 10px;
    background: linear-gradient(135deg, rgba(13,43,26,0.6), rgba(201,168,76,0.08));
    border: 1px solid rgba(201,168,76,0.25);
    margin-top: 12px;
    position: relative;
    overflow: hidden;
  }
  .pot-summary::before {
    content: 'â™ ';
    position: absolute;
    right: 14px; top: 50%;
    transform: translateY(-50%);
    font-size: 2.5rem;
    opacity: 0.05;
    pointer-events: none;
  }

  .back-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-family: 'Cinzel', serif;
    font-size: 0.7rem;
    letter-spacing: 0.08em;
    color: var(--gold);
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
    margin-bottom: 16px;
  }
  .back-btn:hover { color: var(--gold-light); }

  /* Player dropdown */
  .player-select-wrap { position: relative; }
  .player-select-wrap select {
    appearance: none;
    -webkit-appearance: none;
    background: rgba(0,0,0,0.3) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23C9A84C' d='M6 8L1 3h10z'/%3E%3C/svg%3E") no-repeat right 14px center;
    padding-right: 36px;
    cursor: pointer;
  }
  .btn-add-player {
    width: 44px; min-width: 44px; height: 44px;
    background: rgba(201,168,76,0.12);
    border: 1px solid rgba(201,168,76,0.4);
    border-radius: 8px;
    color: var(--gold);
    font-size: 1.3rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
    flex-shrink: 0;
  }
  .btn-add-player:hover { background: rgba(201,168,76,0.25); color: var(--gold-light); }

  /* Modal */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(4px);
    z-index: 1000;
    display: flex; align-items: center; justify-content: center;
    padding: 20px;
    opacity: 0; pointer-events: none;
    transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal-box {
    background: var(--surface-raised);
    border: 1px solid rgba(201,168,76,0.4);
    border-radius: 14px;
    padding: 28px 24px;
    width: 100%; max-width: 360px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.7);
    transform: translateY(20px);
    transition: transform 0.2s;
  }
  .modal-overlay.open .modal-box { transform: translateY(0); }
  .modal-title {
    font-family: 'Cinzel', serif;
    font-size: 0.9rem;
    letter-spacing: 0.12em;
    color: var(--gold-light);
    text-align: center;
    margin-bottom: 20px;
  }
  .modal-actions { display: flex; gap: 10px; margin-top: 18px; }
  .btn-cancel {
    flex: 1; padding: 11px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: var(--text-muted);
    font-family: 'Cinzel', serif;
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn-cancel:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
  .btn-confirm {
    flex: 1; padding: 11px;
    background: linear-gradient(135deg, var(--gold-dark), var(--gold));
    border: none;
    border-radius: 8px;
    color: #1a1400;
    font-family: 'Cinzel', serif;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn-confirm:hover { filter: brightness(1.1); }

  /* Achievement badges */
  .achievement-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
  }
  .badge-card {
    border-radius: 12px;
    padding: 14px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    text-align: center;
    border: 1px solid rgba(255,255,255,0.06);
    background: rgba(0,0,0,0.25);
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .badge-card.unlocked {
    background: linear-gradient(135deg, rgba(201,168,76,0.12), rgba(201,168,76,0.04));
    border-color: rgba(201,168,76,0.4);
    box-shadow: 0 0 12px rgba(201,168,76,0.1);
  }
  .badge-card.locked {
    opacity: 0.45;
    filter: grayscale(0.6);
  }
  .badge-icon { font-size: 2rem; line-height: 1; }
  .badge-name {
    font-family: 'Cinzel', serif;
    font-size: 0.8rem;
    letter-spacing: 0.08em;
    color: var(--gold-light);
    line-height: 1.3;
    font-weight: bold;
  }
  .badge-desc {
    font-size: 0.6rem;
    color: var(--text-muted);
    line-height: 1.4;
  }
  /* â”€â”€ HEAD TO HEAD â”€â”€ */
  .h2h-grid {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 0;
    margin-bottom: 16px;
  }
  .h2h-col {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .h2h-col.right { text-align: right; }
  .h2h-row-label {
    font-family: 'Cinzel', serif;
    font-size: 0.55rem;
    color: var(--text-muted);
    letter-spacing: 0.08em;
    text-align: center;
    padding: 4px 6px;
    white-space: nowrap;
  }
  .h2h-val {
    font-family: 'Cinzel', serif;
    font-size: 0.85rem;
    padding: 6px 8px;
    border-radius: 6px;
    background: rgba(255,255,255,0.03);
    text-align: right;
  }
  .h2h-val:nth-child(3n) {
    text-align: left;
  }
  .h2h-val.better {
    background: rgba(74,222,128,0.12);
    color: #4ade80;
  }
  .h2h-val.worse {
    background: rgba(248,113,113,0.08);
    color: #f87171;
  }
  .h2h-divider {
    width: 1px;
    background: rgba(201,168,76,0.2);
    margin: 0 8px;
  }
  .h2h-select {
    width: 100%;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(201,168,76,0.35);
    border-radius: 8px;
    color: var(--text-primary);
    font-family: 'Crimson Text', serif;
    font-size: 0.95rem;
    padding: 8px 10px;
    outline: none;
    cursor: pointer;
    margin-bottom: 16px;
  }

  /* â”€â”€ PLAYER AVATARS â”€â”€ */
  .player-avatar {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid rgba(201,168,76,0.4);
    cursor: pointer;
    transition: border-color 0.2s;
    flex-shrink: 0;
    background: rgba(0,0,0,0.3);
  }
  .player-avatar:hover { border-color: rgba(201,168,76,0.9); }
  .player-avatar-placeholder {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    border: 2px dashed rgba(201,168,76,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    cursor: pointer;
    flex-shrink: 0;
    background: rgba(0,0,0,0.2);
    transition: border-color 0.2s, background 0.2s;
  }
  .player-avatar-placeholder:hover {
    border-color: rgba(201,168,76,0.7);
    background: rgba(201,168,76,0.08);
  }

  /* â”€â”€ AVATAR CONTEXT MENU â”€â”€ */
  .avatar-menu {
    position: fixed;
    z-index: 2000;
    background: var(--surface-raised);
    border: 1px solid rgba(201,168,76,0.4);
    border-radius: 10px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.7);
    overflow: hidden;
    min-width: 160px;
    animation: fadeInScale 0.15s ease;
  }
  @keyframes fadeInScale {
    from { opacity: 0; transform: scale(0.92); }
    to   { opacity: 1; transform: scale(1); }
  }
  .avatar-menu-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    cursor: pointer;
    font-family: 'Cinzel', serif;
    font-size: 0.75rem;
    letter-spacing: 0.07em;
    color: var(--text-primary);
    transition: background 0.15s;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
  }
  .avatar-menu-item:hover { background: rgba(201,168,76,0.1); }
  .avatar-menu-item.danger { color: #f87171; }
  .avatar-menu-item.danger:hover { background: rgba(248,113,113,0.1); }
  .avatar-menu-divider { height: 1px; background: rgba(201,168,76,0.15); }

  /* â”€â”€ ACHIEVEMENT TIERS â”€â”€ */
  .tier-label {
    font-family: 'Cinzel', serif;
    font-size: 0.65rem;
    letter-spacing: 0.14em;
    padding: 4px 12px;
    border-radius: 20px;
    display: inline-block;
    margin-bottom: 10px;
    margin-top: 6px;
  }
  .tier-1 .badge-card.unlocked { border-color: rgba(74,222,128,0.5); box-shadow: 0 0 10px rgba(74,222,128,0.1); }
  .tier-2 .badge-card.unlocked { border-color: rgba(96,165,250,0.5); box-shadow: 0 0 10px rgba(96,165,250,0.1); }
  .tier-3 .badge-card.unlocked { border-color: rgba(201,168,76,0.6); box-shadow: 0 0 10px rgba(201,168,76,0.15); }
  .tier-4 .badge-card.unlocked { border-color: rgba(232,121,249,0.6); box-shadow: 0 0 12px rgba(232,121,249,0.2); }
  .tier-label-1 { background: rgba(74,222,128,0.15); color: #4ade80; border: 1px solid rgba(74,222,128,0.4); }
  .tier-label-2 { background: rgba(96,165,250,0.15); color: #60a5fa; border: 1px solid rgba(96,165,250,0.4); }
  .tier-label-3 { background: rgba(201,168,76,0.15); color: var(--gold-light); border: 1px solid rgba(201,168,76,0.4); }
  .tier-label-4 { background: rgba(232,121,249,0.15); color: #e879f9; border: 1px solid rgba(232,121,249,0.4); }

  .badge-holder {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    justify-content: center;
    margin-top: 6px;
  }
  .badge-holder-chip {
    background: linear-gradient(135deg, rgba(201,168,76,0.25), rgba(201,168,76,0.1));
    border: 1px solid rgba(201,168,76,0.5);
    border-radius: 20px;
    padding: 2px 9px;
    font-size: 0.65rem;
    font-family: 'Cinzel', serif;
    color: var(--gold-light);
    letter-spacing: 0.05em;
    white-space: nowrap;
  }
  .badge-lock {
    position: absolute;
    top: 6px; right: 8px;
    font-size: 0.7rem;
    opacity: 0.4;
  }
  .rebuy-row-item {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 6px;
  }
  .rebuy-row-item input {
    flex: 1;
  }
  .rebuy-row-item button {
    background: rgba(192,57,43,0.18);
    color: #e74c3c;
    border: 1px solid rgba(192,57,43,0.35);
    border-radius: 6px;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 0.8rem;
    flex-shrink: 0;
  }

  /* Settlement modal */
  /* â”€â”€ LIGHTBOX â”€â”€ */
  #lightbox {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: rgba(0,0,0,0.95);
    align-items: center;
    justify-content: center;
    cursor: zoom-out;
    animation: fadeIn 0.2s ease;
  }
  #lightbox.open { display: flex; }
  #lightbox img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 6px;
    user-select: none;
    pointer-events: none;
  }
  #lightbox-close {
    position: fixed;
    top: 16px;
    right: 16px;
    background: rgba(255,255,255,0.15);
    border: none;
    color: #fff;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    font-size: 1.1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }

  .settlement-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(5px);
    z-index: 2000;
    display: flex; align-items: center; justify-content: center;
    padding: 20px;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s;
  }
  .settlement-overlay.open { opacity: 1; pointer-events: all; }
  .settlement-box {
    background: var(--surface-raised);
    border: 1px solid rgba(201,168,76,0.45);
    border-radius: 16px;
    padding: 0;
    width: 100%; max-width: 400px;
    box-shadow: 0 24px 64px rgba(0,0,0,0.8);
    transform: translateY(24px) scale(0.97);
    transition: transform 0.25s;
    overflow: hidden;
    max-height: 85vh;
    display: flex; flex-direction: column;
  }
  .settlement-overlay.open .settlement-box { transform: translateY(0) scale(1); }
  .settlement-header {
    padding: 20px 22px 16px;
    border-bottom: 1px solid rgba(201,168,76,0.15);
    background: linear-gradient(135deg, rgba(13,43,26,0.7), rgba(201,168,76,0.06));
    flex-shrink: 0;
  }
  .settlement-body { padding: 18px 22px 22px; overflow-y: auto; flex: 1; }
  .transfer-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 13px 16px;
    border-radius: 10px;
    background: rgba(0,0,0,0.25);
    border: 1px solid rgba(255,255,255,0.06);
    margin-bottom: 10px;
  }
  .transfer-arrow {
    color: var(--gold);
    font-size: 1.1rem;
    flex-shrink: 0;
  }
  .transfer-amount {
    font-family: 'Cinzel', serif;
    font-weight: 700;
    font-size: 1.05rem;
    color: #4ade80;
    flex-shrink: 0;
    min-width: 70px;
    text-align: right;
  }

  /* Year filter pills */
  .year-pill {
    font-family: 'Cinzel', serif;
    font-size: 0.68rem;
    letter-spacing: 0.1em;
    padding: 7px 16px;
    border-radius: 20px;
    border: 1.5px solid rgba(201,168,76,0.3);
    background: rgba(0,0,0,0.2);
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s ease;
    white-space: nowrap;
  }
  .year-pill:hover { border-color: rgba(201,168,76,0.6); color: var(--gold); background: rgba(201,168,76,0.08); }
  .year-pill.active {
    background: linear-gradient(135deg, rgba(201,168,76,0.22), rgba(201,168,76,0.1));
    border-color: var(--gold);
    color: var(--gold-light);
    box-shadow: 0 2px 8px rgba(201,168,76,0.2);
  }

</style>
</head>
<body>

<!-- HEADER -->
<div style="position:relative;background:#0a1a0f;overflow:hidden;padding:0 16px 0">

<svg viewBox="0 0 420 240" xmlns="http://www.w3.org/2000/svg" style="width:100%;max-width:640px;display:block;margin:0 auto;">
  <defs>
    <radialGradient id="felt" cx="50%" cy="50%" r="58%">
      <stop offset="0%"  stop-color="#1e6b38"/>
      <stop offset="55%" stop-color="#0f3d1e"/>
      <stop offset="100%" stop-color="#071a0e"/>
    </radialGradient>
    <radialGradient id="wood" cx="50%" cy="35%" r="60%">
      <stop offset="0%"  stop-color="#6b3a12"/>
      <stop offset="60%" stop-color="#3d1f08"/>
      <stop offset="100%" stop-color="#1a0c02"/>
    </radialGradient>
    <radialGradient id="woodShine" cx="30%" cy="20%" r="70%">
      <stop offset="0%"  stop-color="rgba(255,200,120,0.18)"/>
      <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
    </radialGradient>
    <filter id="glow" x="-30%" y="-30%" width="160%" height="160%">
      <feGaussianBlur stdDeviation="2.5" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
    <filter id="chipShadow" x="-25%" y="-25%" width="150%" height="150%">
      <feDropShadow dx="1" dy="2" stdDeviation="2.5" flood-color="#000" flood-opacity="0.65"/>
    </filter>
    <filter id="cardShadow" x="-15%" y="-15%" width="130%" height="140%">
      <feDropShadow dx="1" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.7"/>
    </filter>
    <!-- Reusable chip clip -->
    <clipPath id="feltClip">
      <ellipse cx="210" cy="120" rx="183" ry="97"/>
    </clipPath>
  </defs>

  <!-- â•â• TABLE STRUCTURE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

  <!-- Outer wood rim -->
  <ellipse cx="210" cy="120" rx="207" ry="116" fill="url(#wood)"/>
  <ellipse cx="210" cy="120" rx="207" ry="116" fill="url(#woodShine)"/>
  <!-- Rim edge highlights -->
  <ellipse cx="210" cy="120" rx="207" ry="116" fill="none" stroke="#8b4f1a" stroke-width="1.5" opacity="0.7"/>
  <ellipse cx="210" cy="120" rx="205" ry="114" fill="none" stroke="#c07830" stroke-width="0.6" opacity="0.35"/>

  <!-- Padded rail (darker band) -->
  <ellipse cx="210" cy="120" rx="197" ry="107" fill="#180a02"/>
  <ellipse cx="210" cy="120" rx="197" ry="107" fill="none" stroke="#2e1204" stroke-width="4"/>

  <!-- Felt playing surface -->
  <ellipse cx="210" cy="120" rx="183" ry="97" fill="url(#felt)"/>

  <!-- Felt subtle texture lines -->
  <line x1="30"  y1="120" x2="390" y2="120" stroke="rgba(255,255,255,0.018)" stroke-width="0.5" clip-path="url(#feltClip)"/>
  <line x1="210" y1="25"  x2="210" y2="215" stroke="rgba(255,255,255,0.018)" stroke-width="0.5" clip-path="url(#feltClip)"/>

  <!-- Inner gold oval border (classic table detail) -->
  <ellipse cx="210" cy="120" rx="168" ry="84" fill="none" stroke="rgba(201,168,76,0.28)" stroke-width="1.3"/>
  <ellipse cx="210" cy="120" rx="166" ry="82" fill="none" stroke="rgba(201,168,76,0.07)" stroke-width="0.6"/>

  <!-- Suit watermarks in corners of felt -->
  <text x="52"  y="85"  font-size="18" fill="rgba(201,168,76,0.09)" font-family="serif" text-anchor="middle">â™ </text>
  <text x="368" y="85"  font-size="18" fill="rgba(201,168,76,0.09)" font-family="serif" text-anchor="middle">â™£</text>
  <text x="52"  y="170" font-size="18" fill="rgba(192,57,43,0.10)"  font-family="serif" text-anchor="middle">â™¥</text>
  <text x="368" y="170" font-size="18" fill="rgba(192,57,43,0.10)"  font-family="serif" text-anchor="middle">â™¦</text>

  <!-- â•â• TITLE AREA (top of table) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <ellipse cx="210" cy="50" rx="118" ry="24" fill="rgba(0,0,0,0.38)"/>
  <line x1="118" y1="63" x2="302" y2="63" stroke="rgba(201,168,76,0.4)" stroke-width="0.8"/>
  <text x="210" y="44" text-anchor="middle" font-size="18" fill="#E8C97A"
        font-family="Cinzel,serif" font-weight="bold" letter-spacing="4" filter="url(#glow)">ALL IN</text>
  <text x="210" y="61" text-anchor="middle" font-size="9" fill="#B08840"
        font-family="Cinzel,serif" letter-spacing="5.5">POKER TRACKER</text>

  <!-- â•â• DEALER BUTTON â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <g filter="url(#chipShadow)" transform="translate(298,83)">
    <circle r="9" fill="#d8d0b8"/>
    <circle r="9" fill="none" stroke="#a09078" stroke-width="1.2"/>
    <circle r="6.5" fill="#c0b89a"/>
    <circle r="6.5" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="0.7" stroke-dasharray="2 2"/>
    <circle r="3.5" fill="#a8a088"/>
    <text y="3.5" text-anchor="middle" font-size="5" fill="#333" font-family="Cinzel,serif" font-weight="bold">D</text>
  </g>

  <!-- â•â• CHIPS â€“ LEFT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <g filter="url(#chipShadow)">
    <circle cx="58" cy="128" r="13" fill="#7a0000"/>
    <circle cx="58" cy="124" r="13" fill="#a02020"/>
    <circle cx="58" cy="120" r="13" fill="#c0392b"/>
    <circle cx="58" cy="120" r="7.5" fill="rgba(0,0,0,0.22)"/>
    <circle cx="58" cy="120" r="7.5" fill="none" stroke="rgba(255,255,255,0.18)" stroke-width="0.8"/>
  </g>
  <g filter="url(#chipShadow)">
    <circle cx="80" cy="137" r="11" fill="#1a4f7a"/>
    <circle cx="80" cy="137" r="11" fill="#2471a3"/>
    <circle cx="80" cy="137" r="6.5" fill="rgba(0,0,0,0.2)"/>
    <circle cx="80" cy="137" r="6.5" fill="none" stroke="rgba(255,255,255,0.18)" stroke-width="0.7"/>
  </g>
  <g filter="url(#chipShadow)">
    <circle cx="67" cy="152" r="12" fill="#7a5a18"/>
    <circle cx="67" cy="152" r="12" fill="#c9a84c"/>
    <circle cx="67" cy="152" r="7" fill="rgba(0,0,0,0.25)"/>
    <circle cx="67" cy="152" r="7" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="0.8"/>
  </g>

  <!-- â•â• CHIPS â€“ RIGHT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <g filter="url(#chipShadow)">
    <circle cx="348" cy="118" r="12" fill="#7a5a18"/>
    <circle cx="348" cy="118" r="12" fill="#c9a84c"/>
    <circle cx="348" cy="118" r="7" fill="rgba(0,0,0,0.25)"/>
    <circle cx="348" cy="118" r="7" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="0.8"/>
  </g>
  <g filter="url(#chipShadow)">
    <circle cx="365" cy="132" r="13" fill="#7a0000"/>
    <circle cx="365" cy="128" r="13" fill="#a02020"/>
    <circle cx="365" cy="124" r="13" fill="#c0392b"/>
    <circle cx="365" cy="124" r="7.5" fill="rgba(0,0,0,0.22)"/>
    <circle cx="365" cy="124" r="7.5" fill="none" stroke="rgba(255,255,255,0.18)" stroke-width="0.8"/>
  </g>
  <g filter="url(#chipShadow)">
    <circle cx="345" cy="143" r="10" fill="#1a4f7a"/>
    <circle cx="345" cy="143" r="10" fill="#2471a3"/>
    <circle cx="345" cy="143" r="6" fill="rgba(0,0,0,0.2)"/>
    <circle cx="345" cy="143" r="6" fill="none" stroke="rgba(255,255,255,0.18)" stroke-width="0.7"/>
  </g>

  <!-- â•â• POT CHIPS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <g filter="url(#chipShadow)">
    <circle cx="196" cy="77" r="9" fill="#7a5a18"/>
    <circle cx="196" cy="77" r="9" fill="#c9a84c"/>
    <circle cx="196" cy="77" r="3.5" fill="rgba(0,0,0,0.3)"/>
  </g>
  <g filter="url(#chipShadow)">
    <circle cx="210" cy="75" r="9" fill="#7a0000"/>
    <circle cx="210" cy="75" r="9" fill="#c0392b"/>
    <circle cx="210" cy="75" r="3.5" fill="rgba(0,0,0,0.25)"/>
  </g>
  <g filter="url(#chipShadow)">
    <circle cx="222" cy="78" r="8" fill="#1a4f7a"/>
    <circle cx="222" cy="78" r="8" fill="#2471a3"/>
    <circle cx="222" cy="78" r="3" fill="rgba(0,0,0,0.22)"/>
  </g>

  <!-- â•â• COMMUNITY CARDS â€“ 4 open: 9â™  Kâ™¥ Qâ™¦ Jâ™£ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <g filter="url(#cardShadow)" transform="translate(141,91)">
    <rect width="26" height="38" rx="3" fill="#faf6ee"/>
    <rect x="0.5" y="0.5" width="25" height="37" rx="2.7" fill="none" stroke="rgba(0,0,0,0.15)" stroke-width="0.7"/>
    <text x="3.5" y="9"  font-size="7.5" fill="#111" font-family="Georgia,serif" font-weight="bold">9</text>
    <text x="3.5" y="16" font-size="6"   fill="#111" font-family="serif">&#9824;</text>
    <text x="13"  y="24" font-size="15"  fill="#111" font-family="serif" text-anchor="middle">&#9824;</text>
    <g transform="rotate(180,13,19)">
      <text x="3.5" y="9"  font-size="7.5" fill="#111" font-family="Georgia,serif" font-weight="bold">9</text>
      <text x="3.5" y="16" font-size="6"   fill="#111" font-family="serif">&#9824;</text>
    </g>
  </g>
  <g filter="url(#cardShadow)" transform="translate(169,91)">
    <rect width="26" height="38" rx="3" fill="#faf6ee"/>
    <rect x="0.5" y="0.5" width="25" height="37" rx="2.7" fill="none" stroke="rgba(0,0,0,0.15)" stroke-width="0.7"/>
    <text x="3.5" y="9"  font-size="7.5" fill="#b22020" font-family="Georgia,serif" font-weight="bold">K</text>
    <text x="3.5" y="16" font-size="6"   fill="#b22020" font-family="serif">&#9829;</text>
    <text x="13"  y="24" font-size="15"  fill="#b22020" font-family="serif" text-anchor="middle">&#9829;</text>
    <g transform="rotate(180,13,19)">
      <text x="3.5" y="9"  font-size="7.5" fill="#b22020" font-family="Georgia,serif" font-weight="bold">K</text>
      <text x="3.5" y="16" font-size="6"   fill="#b22020" font-family="serif">&#9829;</text>
    </g>
  </g>
  <g filter="url(#cardShadow)" transform="translate(197,91)">
    <rect width="26" height="38" rx="3" fill="#faf6ee"/>
    <rect x="0.5" y="0.5" width="25" height="37" rx="2.7" fill="none" stroke="rgba(0,0,0,0.15)" stroke-width="0.7"/>
    <text x="3.5" y="9"  font-size="7.5" fill="#b22020" font-family="Georgia,serif" font-weight="bold">Q</text>
    <text x="3.5" y="16" font-size="6"   fill="#b22020" font-family="serif">&#9830;</text>
    <text x="13"  y="24" font-size="15"  fill="#b22020" font-family="serif" text-anchor="middle">&#9830;</text>
    <g transform="rotate(180,13,19)">
      <text x="3.5" y="9"  font-size="7.5" fill="#b22020" font-family="Georgia,serif" font-weight="bold">Q</text>
      <text x="3.5" y="16" font-size="6"   fill="#b22020" font-family="serif">&#9830;</text>
    </g>
  </g>
  <g filter="url(#cardShadow)" transform="translate(225,91)">
    <rect width="26" height="38" rx="3" fill="#faf6ee"/>
    <rect x="0.5" y="0.5" width="25" height="37" rx="2.7" fill="none" stroke="rgba(0,0,0,0.15)" stroke-width="0.7"/>
    <text x="3.5" y="9"  font-size="7.5" fill="#111" font-family="Georgia,serif" font-weight="bold">J</text>
    <text x="3.5" y="16" font-size="6"   fill="#111" font-family="serif">&#9827;</text>
    <text x="13"  y="24" font-size="15"  fill="#111" font-family="serif" text-anchor="middle">&#9827;</text>
    <g transform="rotate(180,13,19)">
      <text x="3.5" y="9"  font-size="7.5" fill="#111" font-family="Georgia,serif" font-weight="bold">J</text>
      <text x="3.5" y="16" font-size="6"   fill="#111" font-family="serif">&#9827;</text>
    </g>
  </g>
  <!-- â•â• RIVER â€“ 10â™¥ face-down, clickable (completes Broadway!) â•â•â•â•â•â•â• -->
  <g id="river-back" filter="url(#cardShadow)" transform="translate(253,91)" onclick="flipRiver()" style="cursor:pointer">
    <rect width="26" height="38" rx="3" fill="#1c2d7c"/>
    <rect x="0.5" y="0.5" width="25" height="37" rx="2.7" fill="none" stroke="rgba(255,255,255,0.22)" stroke-width="0.7"/>
    <rect x="2.5" y="2.5" width="21" height="33" rx="2" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.6"/>
    <line x1="3" y1="3" x2="23" y2="35" stroke="rgba(255,255,255,0.07)" stroke-width="1"/>
    <line x1="23" y1="3" x2="3" y2="35" stroke="rgba(255,255,255,0.07)" stroke-width="1"/>
    <circle cx="13" cy="19" r="4" fill="rgba(201,168,76,0.3)">
      <animate attributeName="r" values="3;6;3" dur="2.2s" repeatCount="indefinite"/>
      <animate attributeName="opacity" values="0.5;0;0.5" dur="2.2s" repeatCount="indefinite"/>
    </circle>
  </g>
  <g id="river-front" filter="url(#cardShadow)" transform="translate(253,91)" onclick="flipRiver()" style="cursor:pointer;display:none">
    <rect width="26" height="38" rx="3" fill="#faf6ee"/>
    <rect x="0.5" y="0.5" width="25" height="37" rx="2.7" fill="none" stroke="rgba(0,0,0,0.15)" stroke-width="0.7"/>
    <text x="3.5" y="9"  font-size="6.5" fill="#b22020" font-family="Georgia,serif" font-weight="bold">10</text>
    <text x="3.5" y="16" font-size="6"   fill="#b22020" font-family="serif">&#9829;</text>
    <text x="13"  y="24" font-size="15"  fill="#b22020" font-family="serif" text-anchor="middle">&#9829;</text>
    <g transform="rotate(180,13,19)">
      <text x="3.5" y="9"  font-size="6.5" fill="#b22020" font-family="Georgia,serif" font-weight="bold">10</text>
      <text x="3.5" y="16" font-size="6"   fill="#b22020" font-family="serif">&#9829;</text>
    </g>
  </g>
  <!-- â•â• HOLE CARDS LEFT â€“ Aâ™¥ 10â™  face-down (Broadway with river!) â•â•â•â• -->
  <g id="hand-back-1" filter="url(#cardShadow)" transform="translate(94,158) rotate(-14,13,19)"
     onclick="flipHand()" style="cursor:pointer">
    <rect width="26" height="38" rx="3" fill="#1c2d7c"/>
    <rect x="0.5" y="0.5" width="25" height="37" rx="2.7" fill="none" stroke="rgba(255,255,255,0.22)" stroke-width="0.7"/>
    <rect x="2.5" y="2.5" width="21" height="33" rx="2" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.6"/>
    <line x1="3" y1="3" x2="23" y2="35" stroke="rgba(255,255,255,0.07)" stroke-width="1"/>
    <line x1="23" y1="3" x2="3" y2="35" stroke="rgba(255,255,255,0.07)" stroke-width="1"/>
  </g>
  <g id="hand-back-2" filter="url(#cardShadow)" transform="translate(102,155) rotate(-5,13,19)"
     onclick="flipHand()" style="cursor:pointer">
    <rect width="26" height="38" rx="3" fill="#1c2d7c"/>
    <rect x="0.5" y="0.5" width="25" height="37" rx="2.7" fill="none" stroke="rgba(255,255,255,0.22)" stroke-width="0.7"/>
    <rect x="2.5" y="2.5" width="21" height="33" rx="2" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.6"/>
    <line x1="3" y1="3" x2="23" y2="35" stroke="rgba(255,255,255,0.07)" stroke-width="1"/>
    <line x1="23" y1="3" x2="3" y2="35" stroke="rgba(255,255,255,0.07)" stroke-width="1"/>
    <circle cx="13" cy="19" r="4" fill="rgba(201,168,76,0.3)">
      <animate attributeName="r" values="3;6;3" dur="2.6s" repeatCount="indefinite"/>
      <animate attributeName="opacity" values="0.5;0;0.5" dur="2.6s" repeatCount="indefinite"/>
    </circle>
  </g>
  <g id="hand-front-1" filter="url(#cardShadow)" transform="translate(94,158) rotate(-14,13,19)"
     onclick="flipHand()" style="cursor:pointer;display:none">
    <rect width="26" height="38" rx="3" fill="#faf6ee"/>
    <rect x="0.5" y="0.5" width="25" height="37" rx="2.7" fill="none" stroke="rgba(0,0,0,0.15)" stroke-width="0.7"/>
    <text x="3.5" y="9"  font-size="7.5" fill="#b22020" font-family="Georgia,serif" font-weight="bold">A</text>
    <text x="3.5" y="16" font-size="6"   fill="#b22020" font-family="serif">&#9829;</text>
    <text x="13"  y="24" font-size="15"  fill="#b22020" font-family="serif" text-anchor="middle">&#9829;</text>
    <g transform="rotate(180,13,19)">
      <text x="3.5" y="9"  font-size="7.5" fill="#b22020" font-family="Georgia,serif" font-weight="bold">A</text>
      <text x="3.5" y="16" font-size="6"   fill="#b22020" font-family="serif">&#9829;</text>
    </g>
  </g>
  <g id="hand-front-2" filter="url(#cardShadow)" transform="translate(102,155) rotate(-5,13,19)"
     onclick="flipHand()" style="cursor:pointer;display:none">
    <rect width="26" height="38" rx="3" fill="#faf6ee"/>
    <rect x="0.5" y="0.5" width="25" height="37" rx="2.7" fill="none" stroke="rgba(0,0,0,0.15)" stroke-width="0.7"/>
    <text x="3.5" y="9"  font-size="6.5" fill="#111" font-family="Georgia,serif" font-weight="bold">10</text>
    <text x="3.5" y="16" font-size="6"   fill="#111" font-family="serif">&#9824;</text>
    <text x="13"  y="24" font-size="15"  fill="#111" font-family="serif" text-anchor="middle">&#9824;</text>
    <g transform="rotate(180,13,19)">
      <text x="3.5" y="9"  font-size="6.5" fill="#111" font-family="Georgia,serif" font-weight="bold">10</text>
      <text x="3.5" y="16" font-size="6"   fill="#111" font-family="serif">&#9824;</text>
    </g>
  </g>
  <!-- â•â• HOLE CARDS RIGHT â€“ Kâ™¦ Kâ™£ face-up (Three Kings, but loses!) â•â• -->
  <g filter="url(#cardShadow)" transform="translate(283,155) rotate(6,13,19)">
    <rect width="26" height="38" rx="3" fill="#faf6ee"/>
    <rect x="0.5" y="0.5" width="25" height="37" rx="2.7" fill="none" stroke="rgba(0,0,0,0.15)" stroke-width="0.7"/>
    <text x="3.5" y="9"  font-size="7.5" fill="#b22020" font-family="Georgia,serif" font-weight="bold">K</text>
    <text x="3.5" y="16" font-size="6"   fill="#b22020" font-family="serif">&#9830;</text>
    <text x="13"  y="24" font-size="15"  fill="#b22020" font-family="serif" text-anchor="middle">&#9830;</text>
    <g transform="rotate(180,13,19)">
      <text x="3.5" y="9"  font-size="7.5" fill="#b22020" font-family="Georgia,serif" font-weight="bold">K</text>
      <text x="3.5" y="16" font-size="6"   fill="#b22020" font-family="serif">&#9830;</text>
    </g>
  </g>
  <g filter="url(#cardShadow)" transform="translate(293,150) rotate(16,13,19)">
    <rect width="26" height="38" rx="3" fill="#faf6ee"/>
    <rect x="0.5" y="0.5" width="25" height="37" rx="2.7" fill="none" stroke="rgba(0,0,0,0.15)" stroke-width="0.7"/>
    <text x="3.5" y="9"  font-size="7.5" fill="#111" font-family="Georgia,serif" font-weight="bold">K</text>
    <text x="3.5" y="16" font-size="6"   fill="#111" font-family="serif">&#9827;</text>
    <text x="13"  y="24" font-size="15"  fill="#111" font-family="serif" text-anchor="middle">&#9827;</text>
    <g transform="rotate(180,13,19)">
      <text x="3.5" y="9"  font-size="7.5" fill="#111" font-family="Georgia,serif" font-weight="bold">K</text>
      <text x="3.5" y="16" font-size="6"   fill="#111" font-family="serif">&#9827;</text>
    </g>
  </g>

</svg>

<!-- Status badge below SVG -->
<div style="max-width:640px;margin:-4px auto 0;padding:0 0 10px;display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;">
  <div id="statusBadge" style="display:inline-flex;align-items:center;background:rgba(0,0,0,0.5);border:1px solid rgba(201,168,76,0.2);border-radius:20px;padding:4px 14px;">
    <span class="status-dot connecting" id="statusDot"></span>
    <span id="statusText" class="font-display" style="color:var(--text-muted);letter-spacing:0.1em;font-size:0.58rem">VERBINDE...</span>
  </div>
  <!-- Light/Dark toggle -->
  <button id="themeToggle" onclick="toggleTheme()"
    style="background:rgba(0,0,0,0.5);border:1px solid rgba(201,168,76,0.2);border-radius:20px;padding:4px 12px;cursor:pointer;font-size:0.9rem;line-height:1;transition:all 0.2s"
    title="Hell/Dunkel umschalten">ðŸŒ™</button>

</div>
</div>


<!-- MAIN -->
<div class="max-w-2xl mx-auto px-4 pb-24">

  <!-- TABS -->
  <div class="tab-bar">
    <button class="tab-btn active" onclick="showTab('form')">
      <span class="tab-suit">â™ </span>
      <span class="tab-label">Eintrag</span>
    </button>
    <button class="tab-btn" onclick="showTab('sessions')">
      <span class="tab-suit">â™¦</span>
      <span class="tab-label">Sessions</span>
    </button>
    <button class="tab-btn" onclick="showTab('leaderboard')">
      <span class="tab-suit">â™£</span>
      <span class="tab-label">Rangliste</span>
    </button>
    <button class="tab-btn" onclick="showTab('chart')">
      <span class="tab-suit">â™¥</span>
      <span class="tab-label">Graph</span>
    </button>
    <button class="tab-btn" onclick="showTab('achievements')">
      <span class="tab-suit">ðŸ†</span>
      <span class="tab-label">Awards</span>
    </button>
    <button class="tab-btn" onclick="showTab('tournament')">
      <span class="tab-suit">ðŸŽ°</span>
      <span class="tab-label">Turnier</span>
    </button>
  </div>

  <!-- ===== TAB: FORM ===== -->
  <div id="tab-form" class="card p-5" style="position:relative;overflow:hidden">
    <!-- Watermark suit -->
    <span class="suit-watermark" style="bottom:-10px;right:-10px;color:var(--gold)">â™ </span>
    <div class="header-ornament mb-5">
      <span class="font-display text-xs" style="color:var(--gold);letter-spacing:0.15em">NEUE SESSION</span>
    </div>

    <div class="grid grid-cols-1 gap-4">
      <div>
        <label class="label">Datum</label>
        <div style="width:100%;box-sizing:border-box;overflow:hidden;border-radius:8px">
          <input type="date" id="inputDate" class="input-field" style="margin:0">
        </div>
      </div>
      <div>
        <label class="label">Spieler</label>
        <div class="flex gap-2 items-center player-select-wrap">
          <select id="inputPlayer" class="input-field">
            <option value="">â€” Spieler auswÃ¤hlen â€”</option>
          </select>
          <button class="btn-add-player" onclick="openAddPlayerModal()" type="button" title="Neuen Spieler anlegen">+</button>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="label">Buy-In (â‚¬)</label>
          <input type="number" id="inputBuyin" class="input-field" placeholder="0.00" step="0.01" min="0">
        </div>
        <div>
          <label class="label">Cash-Out (â‚¬)</label>
          <input type="number" id="inputCashout" class="input-field" placeholder="0.00" step="0.01" min="0">
        </div>
      </div>
      <!-- Rebuy row -->
      <div id="rebuySection">
        <button type="button" onclick="addRebuyRow()"
          style="width:100%;background:rgba(201,168,76,0.12);color:var(--gold);border:1px solid rgba(201,168,76,0.4);border-radius:10px;padding:12px;font-size:0.85rem;font-family:'Cinzel',serif;cursor:pointer;letter-spacing:0.1em;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.15s;margin-bottom:8px"
          onmouseover="this.style.background='rgba(201,168,76,0.22)'" onmouseout="this.style.background='rgba(201,168,76,0.12)'">
          <span style="font-size:1.1rem">ðŸ”„</span> + REBUY HINZUFÃœGEN
        </button>
        <div id="rebuyRows"></div>
      </div>

      <!-- Live Profit Preview -->
      <div id="profitPreview" class="stat-card" style="display:none">
        <div class="stat-label">Profit dieser Session</div>
        <div id="profitPreviewValue" class="stat-value mt-1">â€”</div>
      </div>

      <button class="btn-gold w-full mt-1" onclick="addSession()" id="submitBtn" style="position:relative;overflow:hidden;">
        <span style="position:relative;z-index:1">â™  &nbsp;Eintrag speichern&nbsp; â™ </span>
      </button>
    </div>
  </div>

  <!-- ===== TAB: SESSIONS ===== -->
  <div id="tab-sessions" style="display:none">
    <div id="view-nights" class="card p-5" style="position:relative;overflow:visible">
      <span class="suit-watermark" style="bottom:-10px;right:0px;color:var(--red-suit)">â™¥</span>
      <div class="header-ornament mb-4">
        <span class="font-display text-xs" style="color:var(--gold);letter-spacing:0.15em">â™¦ &nbsp;SPIELABENDE&nbsp; â™¦</span>
      </div>
      <div id="quickStats" class="grid grid-cols-3 gap-2 mb-5"></div>
      <div style="margin-bottom:14px">
        <div class="label" style="margin-bottom:8px">Jahr</div>
        <div id="sessionsYearPills" style="display:flex;flex-wrap:wrap;gap:6px"></div>
      </div>
      <div id="nightsList"><div class="empty-state">Lade Daten...</div></div>
    </div>
  </div>

  <!-- ===== TAB: LEADERBOARD ===== -->
  <div id="tab-leaderboard" style="display:none">

    <!-- VIEW: Leaderboard List -->
    <div id="view-leaderboard" class="card p-5" style="position:relative;overflow:hidden">
      <span class="suit-watermark" style="bottom:-10px;right:0;color:var(--gold)">â™£</span>
      <div class="header-ornament mb-4">
        <span class="font-display text-xs" style="color:var(--gold);letter-spacing:0.15em">â™£ &nbsp;JAHRES-RANGLISTE&nbsp; â™£</span>
      </div>

      <!-- Year filter -->
      <div style="margin-bottom:14px">
        <div class="label" style="margin-bottom:8px">Jahr</div>
        <div id="lbYearPills" style="display:flex;flex-wrap:wrap;gap:6px"></div>
      </div>

      <!-- Sort Toggle -->
      <div class="flex gap-2 mb-4">
        <button id="sortBtnTop" class="tab-btn active flex-1" onclick="setLeaderboardSort('top')">â–² Meistes Plus</button>
        <button id="sortBtnBottom" class="tab-btn flex-1" onclick="setLeaderboardSort('bottom')">â–¼ Meistes Minus</button>
      </div>

      <div id="leaderboardBody"></div>
    </div>

    <!-- VIEW: Player Detail -->
    <div id="view-player-detail" class="card p-5" style="display:none">
      <button class="back-btn" onclick="closePlayerDetail()">&#x25C4; ZurÃ¼ck zur Rangliste</button>
      <div id="playerDetailContent"></div>
    </div>

  </div>

  <!-- ===== TAB: CHART ===== -->
  <div id="tab-chart" class="card p-5" style="display:none;position:relative;overflow:hidden">
    <span class="suit-watermark" style="bottom:-10px;right:0;color:var(--red-suit)">â™¥</span>
    <div class="header-ornament mb-4">
      <span class="font-display text-xs" style="color:var(--gold);letter-spacing:0.15em">â™¥ &nbsp;PECH &amp; GLÃœCK&nbsp; â™¥</span>
    </div>

    <!-- Year filter -->
    <div style="margin-bottom:14px">
      <div class="label" style="margin-bottom:8px">Jahr</div>
      <div id="chartYearPills" style="display:flex;flex-wrap:wrap;gap:6px"></div>
    </div>

    <!-- Chart type selector -->
    <div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap">
      <button id="chartType-cumulative" class="tab-btn active flex-1" onclick="setChartType('cumulative')" style="font-size:0.68rem">ðŸ“ˆ Profit-Verlauf</button>
      <button id="chartType-winrate" class="tab-btn flex-1" onclick="setChartType('winrate')" style="font-size:0.68rem">ðŸ† Win-Rate</button>
      <button id="chartType-rebuy" class="tab-btn flex-1" onclick="setChartType('rebuy')" style="font-size:0.68rem">ðŸ”„ Rebuys</button>
    </div>

    <!-- Player filter (only for cumulative) -->
    <div id="chartPlayerFilter" style="margin-bottom:16px">
      <label class="label">Spieler anzeigen</label>
      <div style="display:flex;gap:8px;align-items:flex-start">
        <select id="chartPlayerSelect" multiple
          onchange="onChartSelectChange()"
          style="flex:1;background:rgba(0,0,0,0.35);border:1px solid rgba(201,168,76,0.3);
                 border-radius:8px;color:var(--text-primary);font-family:'Crimson Text',serif;
                 font-size:0.95rem;padding:6px 4px;min-height:80px;max-height:140px;
                 outline:none;cursor:pointer;">
        </select>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button onclick="selectAllChartPlayers()"
            style="font-family:Cinzel,serif;font-size:0.62rem;letter-spacing:0.07em;
                   background:rgba(201,168,76,0.12);border:1px solid rgba(201,168,76,0.35);
                   color:var(--gold);border-radius:6px;padding:7px 10px;cursor:pointer;
                   white-space:nowrap;">Alle</button>
          <button onclick="selectNoChartPlayers()"
            style="font-family:Cinzel,serif;font-size:0.62rem;letter-spacing:0.07em;
                   background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);
                   color:var(--text-muted);border-radius:6px;padding:7px 10px;cursor:pointer;
                   white-space:nowrap;">Einer</button>
        </div>
      </div>
      <div style="color:var(--text-muted);font-size:0.75rem;margin-top:5px;font-style:italic">
        Mehrere auswÃ¤hlen: Strg/Cmd gedrÃ¼ckt halten
      </div>
    </div>

    <div id="chartContainer" style="border:1px solid rgba(201,168,76,0.12);border-radius:10px;padding:10px;background:rgba(0,0,0,0.2)">
      <canvas id="profitChart"></canvas>
    </div>
  </div>

</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- AVATAR UPLOAD INPUT (hidden) -->
<input type="file" id="avatarFileInput" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)">

<!-- LIGHTBOX -->
<div id="lightbox" onclick="closeLightbox()">
  <button id="lightbox-close" onclick="closeLightbox()">âœ•</button>
  <img id="lightbox-img" src="" alt="Foto Vollbild">
</div>

<!-- CONFIRM DIALOG -->
<div id="confirmDialog" style="display:none;position:fixed;inset:0;z-index:9998;background:rgba(0,0,0,0.75);align-items:center;justify-content:center;padding:20px">
  <div style="background:var(--surface-raised);border:1px solid rgba(201,168,76,0.3);border-radius:14px;padding:24px;max-width:320px;width:100%;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.6)">
    <div id="confirmTitle" style="font-family:'Cinzel',serif;font-size:1rem;color:var(--gold-light);margin-bottom:10px"></div>
    <div id="confirmText" style="font-size:0.85rem;color:var(--text-muted);margin-bottom:22px;line-height:1.5"></div>
    <div style="display:flex;gap:10px">
      <button onclick="resolveConfirm(false)" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.06);color:var(--text-primary);font-family:'Cinzel',serif;font-size:0.75rem;cursor:pointer;letter-spacing:0.08em">ABBRECHEN</button>
      <button id="confirmOkBtn" onclick="resolveConfirm(true)" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(192,57,43,0.5);background:rgba(192,57,43,0.2);color:#e74c3c;font-family:'Cinzel',serif;font-size:0.75rem;cursor:pointer;letter-spacing:0.08em">ðŸ—‘ï¸ LÃ–SCHEN</button>
    </div>
  </div>
</div>

<!-- TOURNAMENT TAB -->
  <div id="tab-tournament" class="card p-5" style="display:none;position:relative;overflow:hidden;border-radius:0 0 14px 14px">
    <span class="suit-watermark" style="bottom:-10px;right:-5px;color:var(--gold)">ðŸŽ°</span>
    <div id="tournamentContent"></div>
  </div>
  <div id="tab-achievements" class="card p-5" style="display:none;position:relative;overflow:hidden;border-radius:0 0 14px 14px">
    <span class="suit-watermark" style="bottom:-10px;right:-5px;color:var(--gold)">ðŸ†</span>
    <div style="margin-bottom:14px">
      <div class="label" style="margin-bottom:8px">Jahr</div>
      <div id="achYearPills" style="display:flex;flex-wrap:wrap;gap:6px"></div>
    </div>
    <div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap">
      <button id="achFilter-difficulty" class="tab-btn active" onclick="setAchFilter('difficulty')" style="flex:1;font-size:0.7rem">ðŸ… Nach Schwierigkeit</button>
      <button id="achFilter-unlocked" class="tab-btn" onclick="setAchFilter('unlocked')" style="flex:1;font-size:0.7rem">âœ¦ Freigeschaltet zuerst</button>
    </div>
    <div style="margin-bottom:14px">
      <div class="label" style="margin-bottom:8px">Spieler</div>
      <select id="achPlayerFilter" onchange="renderAchievements()"
        style="width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(201,168,76,0.3);border-radius:8px;color:var(--text-primary);font-family:'Crimson Text',serif;font-size:0.95rem;padding:8px 10px;outline:none;cursor:pointer">
        <option value="">â€” Alle Spieler â€”</option>
      </select>
    </div>
    <div id="achievementsContent">
      <div class="empty-state">Lade Achievements...</div>
    </div>
  </div>

<!-- SETTLEMENT MODAL -->
<div class="settlement-overlay" id="settlementModal" onclick="closeSettlement(event)">
  <div class="settlement-box" onclick="event.stopPropagation()">
    <div class="settlement-header">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div class="font-display text-xs" style="color:var(--text-muted);letter-spacing:0.15em;margin-bottom:4px">SCHULDENAUSGLEICH</div>
          <div class="font-display" style="color:var(--gold-light);font-size:1rem;letter-spacing:0.08em" id="settlementDate"></div>
        </div>
        <button onclick="closeSettlement()" style="background:none;border:none;color:var(--text-muted);font-size:1.2rem;cursor:pointer;padding:4px">âœ•</button>
      </div>
      <div style="margin-top:10px;font-size:0.82rem;color:var(--text-muted);font-style:italic">
        Jeder Ã¼berweist maximal an eine Person â€“ danach sind alle quitt.
      </div>
    </div>
    <div class="settlement-body" id="settlementBody"></div>
  </div>
</div>

<!-- ADD PLAYER MODAL -->
<div class="modal-overlay" id="addPlayerModal" onclick="closeAddPlayerModal(event)">
  <div class="modal-box" style="position:relative;overflow:hidden">
    <span style="position:absolute;top:-15px;right:5px;font-size:5rem;opacity:0.04;pointer-events:none">â™ </span>
    <div class="modal-title">â™  &nbsp;NEUEN SPIELER &nbsp;â™ </div>
    <label class="label">Name</label>
    <input type="text" id="newPlayerName" class="input-field" placeholder="Name eingeben..."
      onkeydown="if(event.key==='Enter') confirmAddPlayer()">
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeAddPlayerModal()">Abbrechen</button>
      <button class="btn-confirm" onclick="confirmAddPlayer()">Anlegen</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// KONFIGURATION â€“ hier deine Supabase-Daten eintragen
// ============================================================
const SUPABASE_URL  = 'https://okgvubkibtkgcofkdpsd.supabase.co';       // z.B. https://xxx.supabase.co
const SUPABASE_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rZ3Z1YmtpYnRrZ2NvZmtkcHNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NDIzNTcsImV4cCI6MjA4NzUxODM1N30.KBulqLw3TtQ89pWFm8KWYdPMm0UwPdnPDoD0-NystNA';   // langer Ã¶ffentlicher Key
// ============================================================

const { createClient } = supabase;
let db;
let sessions = [];
let chartInstance = null;
const COLORS = ['#C9A84C','#4ade80','#60a5fa','#f472b6','#a78bfa','#fb923c','#34d399','#e879f9','#f87171','#38bdf8'];

// Init
let isOfflineMode = false;

window.addEventListener('load', async () => {
  initTheme();
  setToday();
  updateProfitPreview();

  try {
    db = createClient(SUPABASE_URL, SUPABASE_KEY);
    // Quick connectivity test
    const { error } = await db.from('poker_sessions').select('id').limit(1);
    console.log('Supabase connect error:', error);
    if (error) throw error;

    setStatus('connected', 'VERBUNDEN');
    isOfflineMode = false;

    await loadSessions();
    loadAvatars();
    loadTournaments();
    setupRealtime();
  } catch(e) {
    console.error('Init failed:', e);
    isOfflineMode = true;
    setStatus('disconnected', 'OFFLINE (Lokal)');
    showToast('âš  Fehler: ' + (e.message || String(e)));
    // Load from localStorage if available, else demo data
    const stored = localStorage.getItem('poker_sessions_local');
    sessions = stored ? JSON.parse(stored) : getDemoData();
    renderAll();
  }
});

// â”€â”€ REALTIME + PWA RECONNECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _realtimeChannel = null;

function setupRealtime() {
  if (!db || isOfflineMode) return;
  // Remove old channel if exists
  if (_realtimeChannel) {
    db.removeChannel(_realtimeChannel);
    _realtimeChannel = null;
  }
  _realtimeChannel = db.channel('poker_all_changes')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'poker_sessions' }, () => {
      loadSessions();
    })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'poker_tournaments' }, () => {
      loadTournaments();
    })
    .subscribe((status) => {
      if (status === 'SUBSCRIBED') setStatus('connected', 'VERBUNDEN');
      if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') setStatus('connecting', 'RECONNECTINGâ€¦');
    });
}

// â”€â”€ Visibility change: re-sync when app comes back to foreground â”€â”€
document.addEventListener('visibilitychange', async () => {
  if (document.visibilityState !== 'visible' || isOfflineMode || !db) return;
  setStatus('connecting', 'AKTUALISIEREâ€¦');
  try {
    await loadSessions();
    await loadTournaments();
    setupRealtime(); // re-establish websocket
    setStatus('connected', 'VERBUNDEN');
    renderAll();
  } catch(e) {
    setStatus('disconnected', 'OFFLINE');
  }
});

function setStatus(cls, text) {
  document.getElementById('statusDot').className = 'status-dot ' + cls;
  document.getElementById('statusText').textContent = text;
}

function setToday() {
  const d = new Date();
  document.getElementById('inputDate').value = d.toISOString().split('T')[0];
}

// ---- PROFIT PREVIEW ----
function updateProfitPreview() {
  const rebuyInputs = document.querySelectorAll('.rebuy-amount-input');
  const totalRebuy = Array.from(rebuyInputs).reduce((sum, inp) => {
    const v = parseFloat(inp.value); return sum + (isNaN(v) ? 0 : v);
  }, 0);
  const bi = (parseFloat(document.getElementById('inputBuyin').value) || 0) + totalRebuy;
  const co = parseFloat(document.getElementById('inputCashout').value);
  const preview = document.getElementById('profitPreview');
  const val = document.getElementById('profitPreviewValue');
  if (!isNaN(bi) || !isNaN(co)) {
    preview.style.display = 'block';
    const profit = (isNaN(co) ? 0 : co) - (isNaN(bi) ? 0 : bi);
    val.textContent = formatEuro(profit);
    val.className = 'stat-value mt-1 ' + profitClass(profit);
  } else {
    preview.style.display = 'none';
  }
}
document.getElementById('inputBuyin').addEventListener('input', updateProfitPreview);
document.getElementById('inputCashout').addEventListener('input', updateProfitPreview);

// ---- LOAD ----
async function loadSessions() {
  const { data, error } = await db
    .from('poker_sessions')
    .select('*')
    .order('date', { ascending: true });
  if (error) { showToast('Fehler: ' + error.message); return; }
  sessions = data || [];
  sessions = sessions.map(s => ({
    ...s,
    date: typeof s.date === 'string' ? s.date : new Date(s.date).toISOString().split('T')[0],
    buy_in: parseFloat(s.buy_in) || 0,
    cash_out: parseFloat(s.cash_out) || 0,
    rebuys: parseFloat(s.rebuys) || 0,
    rebuy_count: parseInt(s.rebuy_count) || 0,
  }));
  renderAll();
}

function saveLocal() {
  try { localStorage.setItem('poker_sessions_local', JSON.stringify(sessions)); } catch(e) {}
}

// ---- ADD ----
async function addSession() {
  const date   = document.getElementById('inputDate').value;
  const player = document.getElementById('inputPlayer').value.trim();
  const buyin  = parseFloat(document.getElementById('inputBuyin').value);
  const cashout= parseFloat(document.getElementById('inputCashout').value);

  if (!date || !player || isNaN(buyin) || isNaN(cashout)) {
    showToast('âš  Bitte alle Felder ausfÃ¼llen'); return;
  }

  // Collect rebuys
  const rebuyInputs = document.querySelectorAll('.rebuy-amount-input');
  const totalRebuy = Array.from(rebuyInputs).reduce((sum, inp) => {
    const v = parseFloat(inp.value);
    return sum + (isNaN(v) ? 0 : v);
  }, 0);
  const totalBuyin = buyin + totalRebuy;

  const btn = document.getElementById('submitBtn');
  btn.innerHTML = '<span class="spinner"></span>';
  btn.disabled = true;

  const newEntry = { id: 'local_' + Date.now(), date, player_name: player, buy_in: totalBuyin, cash_out: cashout, rebuys: totalRebuy, rebuy_count: rebuyInputs.length };

  if (isOfflineMode) {
    sessions.push(newEntry);
    saveLocal();
  } else {
    const { data, error } = await db.from('poker_sessions')
      .insert([{ date, player_name: player, buy_in: totalBuyin, cash_out: cashout }])
      .select();
    if (error) {
      showToast('Fehler: ' + error.message);
      btn.innerHTML = 'â™  Eintrag speichern';
      btn.disabled = false;
      return;
    }
    if (data && data[0]) sessions.push({ ...data[0], rebuys: totalRebuy, rebuy_count: rebuyInputs.length });
    else sessions.push(newEntry);
  }

  btn.innerHTML = 'â™  Eintrag speichern';
  btn.disabled = false;

  document.getElementById('inputPlayer').value = '';
  document.getElementById('inputBuyin').value = '';
  document.getElementById('inputCashout').value = '';
  document.getElementById('rebuyRows').innerHTML = '';
  document.getElementById('profitPreview').style.display = 'none';
  const rebuyNote = totalRebuy > 0 ? ` (inkl. ${formatEuro(totalRebuy)} Rebuy)` : '';
  showToast('âœ“ Eintrag gespeichert!' + rebuyNote);
  renderAll();
  showTab('sessions');
}

// ---- DELETE single entry ----
async function deleteSession(id) {
  const s = sessions.find(s => s.id === id);
  const name = s ? s.player_name : 'diesen Eintrag';
  const confirmed = await showConfirmDialog(
    'âœ• Eintrag lÃ¶schen?',
    `MÃ¶chtest du den Eintrag von ${name} wirklich lÃ¶schen?`
  );
  if (!confirmed) return;
  if (isOfflineMode) {
    sessions = sessions.filter(s => s.id !== id);
    saveLocal();
    renderAll();
    showToast('Eintrag gelÃ¶scht');
    return;
  }
  const { error } = await db.from('poker_sessions').delete().eq('id', id);
  if (error) { showToast('Fehler: ' + error.message); return; }
  sessions = sessions.filter(s => s.id !== id);
  renderAll();
  showToast('Eintrag gelÃ¶scht');
}

// ---- DELETE entire night ----
async function deleteNight(date) {
  const playerCount = sessions.filter(s => s.date === date).length;
  if (!confirm(`Kompletten Spielabend vom ${formatDate(date)} lÃ¶schen?\n(${playerCount} EintrÃ¤ge werden entfernt)`)) return;
  if (isOfflineMode) {
    sessions = sessions.filter(s => s.date !== date);
    saveLocal();
    renderAll();
    showToast('Spielabend gelÃ¶scht');
    return;
  }
  const { error } = await db.from('poker_sessions').delete().eq('date', date);
  if (error) { showToast('Fehler: ' + error.message); return; }
  sessions = sessions.filter(s => s.date !== date);
  renderAll();
  showToast('Spielabend gelÃ¶scht');
}

// ---- RENDER ALL ----
function renderAll() {
  // Always default to most recent year when data loads
  const mostRecent = getMostRecentYear();
  if (leaderboardYear === String(new Date().getFullYear()) || !getAvailableYears().includes(leaderboardYear)) {
    leaderboardYear = mostRecent;
  }
  if (chartYear === String(new Date().getFullYear()) || !getAvailableYears().includes(chartYear)) {
    chartYear = mostRecent;
  }
  // Sync year filters to most recent year in data
  const mostRecentYr = getMostRecentYear();
  sessionsYear     = mostRecentYr;
  leaderboardYear  = mostRecentYr;
  achievementsYear = mostRecentYr;
  renderSessions();
  renderLeaderboard();
  renderChart();
  updatePlayerList();
}

// ---- SESSIONS: grouped by night ----
function renderSessions() {
  // Sync year to most recent if not valid
  const availYears = getAvailableYears();
  if (!availYears.includes(sessionsYear)) sessionsYear = getMostRecentYear();

  renderYearPills('sessionsYearPills', sessionsYear, 'setSessionsYear');
  renderQuickStats(getSessionsForYear(sessionsYear));

  const el = document.getElementById('nightsList');
  if (!el) return;

  const filtered = getSessionsForYear(sessionsYear);
  if (!filtered.length) {
    el.innerHTML = '<div class="empty-state">Noch keine Sessions â™ </div>'; return;
  }

  // Group by date
  const byDate = {};
  filtered.forEach(s => {
    if (!byDate[s.date]) byDate[s.date] = [];
    byDate[s.date].push(s);
  });

  const sortedDates = Object.keys(byDate).sort((a,b) => b.localeCompare(a));

  el.innerHTML = sortedDates.map((date, i) => {
    const players = byDate[date];
    const totalBuyin = players.reduce((a,s) => a + s.buy_in, 0);
    const totalCashout = players.reduce((a,s) => a + s.cash_out, 0);
    const bigWinner = [...players].sort((a,b) => (b.cash_out-b.buy_in)-(a.cash_out-a.buy_in))[0];
    const bigWinnerProfit = bigWinner.cash_out - bigWinner.buy_in;

    const playerRows = [...players]
      .sort((a,b) => (b.cash_out-b.buy_in) - (a.cash_out-a.buy_in))
      .map(s => {
        const profit = s.cash_out - s.buy_in;
        const pCls = profitClass(profit);
        const avatarUrl = avatarCache[s.player_name.trim()];
        const avatarEl = avatarUrl
          ? `<img src="${avatarUrl}" style="width:34px;height:34px;border-radius:50%;object-fit:cover;border:1.5px solid rgba(201,168,76,0.4);flex-shrink:0">`
          : `<div style="width:34px;height:34px;border-radius:50%;background:rgba(0,0,0,0.3);border:1.5px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;font-size:0.9rem;flex-shrink:0">ðŸ‘¤</div>`;
        return `
        <div class="player-row">
          <div style="display:flex;align-items:center;gap:10px">
            ${avatarEl}
            <div>
              <div class="font-semibold" style="font-size:1rem">${esc(s.player_name)}</div>
              <div style="color:var(--text-muted);font-size:0.8rem;margin-top:2px">
                Buy-In: ${formatEuro(s.buy_in)} &nbsp;&middot;&nbsp; Cash-Out: ${formatEuro(s.cash_out)}
                ${(s.rebuys && s.rebuys > 0) ? `&nbsp;&middot;&nbsp; <span style="color:#e8a838">ðŸ”„ Rebuy: ${formatEuro(s.rebuys)}</span>` : ''}
              </div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="font-display text-base ${pCls}">${formatEuroSign(profit)}</div>
            <button class="btn-danger" onclick="event.stopPropagation();deleteSession('${s.id}')" title="Spieler lÃ¶schen">&#x2715;</button>
          </div>
        </div>`; 
      }).join('');

    return `
    <div class="session-night-card">
      <div class="session-night-header" onclick="toggleNight('night-${i}', this.closest('.session-night-card'))" style="cursor:pointer">
        <div class="flex items-center gap-3">
          <div style="background:linear-gradient(135deg,rgba(13,43,26,0.7),rgba(201,168,76,0.12));border:1px solid rgba(201,168,76,0.35);border-radius:10px;padding:8px 12px;text-align:center;min-width:56px;box-shadow:inset 0 1px 0 rgba(201,168,76,0.2)">
            <div class="font-display text-lg" style="color:var(--gold-light);line-height:1">${date.split('-')[2]}</div>
            <div class="font-display" style="font-size:0.6rem;color:var(--text-muted);letter-spacing:0.1em">${monthShort(date)}</div>
            <div style="font-size:0.55rem;color:rgba(201,168,76,0.35);margin-top:2px">â™ </div>
          </div>
          <div>
            <div class="font-display text-sm" style="color:var(--text-primary);letter-spacing:0.06em">Spielabend</div>
            <div style="color:var(--text-muted);font-size:0.82rem;margin-top:2px">
              ${players.length} Spieler &nbsp;&middot;&nbsp; Pot: ${formatEuro(totalBuyin)}
            </div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div class="text-right">
            <div class="font-display text-xs" style="color:var(--text-muted);letter-spacing:0.06em">Top</div>
            <div class="font-display text-sm ${profitClass(bigWinnerProfit)}">${esc(bigWinner.player_name)}</div>
          </div>
          <span class="session-night-chevron">&#x25BA;</span>
        </div>
      </div>
      <div class="session-detail-panel" id="night-${i}">
        <div class="session-detail-inner">
          <button onclick="event.stopPropagation();openSettlement('${date}')"
            style="margin-bottom:14px;width:100%;background:linear-gradient(135deg,rgba(201,168,76,0.18),rgba(201,168,76,0.08));color:var(--gold-light);border:1px solid rgba(201,168,76,0.4);border-radius:8px;padding:11px;font-family:'Cinzel',serif;font-size:0.72rem;letter-spacing:0.1em;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;justify-content:center;gap:8px"
            onmouseover="this.style.background='linear-gradient(135deg,rgba(201,168,76,0.3),rgba(201,168,76,0.15))'" onmouseout="this.style.background='linear-gradient(135deg,rgba(201,168,76,0.18),rgba(201,168,76,0.08))'">
            â™  &nbsp;SCHULDENAUSGLEICH BERECHNEN
          </button>
          <div class="font-display text-xs mb-3" style="color:var(--gold);letter-spacing:0.12em">SPIELER DIESER NACHT</div>
          ${playerRows}
          <div class="pot-summary">
            <div>
              <div class="font-display text-xs" style="color:var(--text-muted);letter-spacing:0.08em">GESAMT-POT</div>
              <div class="font-display text-base" style="color:var(--gold)">${formatEuro(totalBuyin)}</div>
            </div>
            <div class="text-right">
              <div class="font-display text-xs" style="color:var(--text-muted);letter-spacing:0.08em">AUSGEZAHLT</div>
              <div class="font-display text-base" style="color:var(--text-primary)">${formatEuro(totalCashout)}</div>
            </div>
          </div>
          <!-- Photo section -->
          <div id="photo-section-${date}" style="margin-bottom:10px;margin-top:16px">
            <div id="photo-display-${date}" style="display:none;position:relative;margin-bottom:8px">
              <img id="photo-img-${date}" src="" alt="Spielabend Foto"
                onclick="event.stopPropagation();openLightbox(this.src)"
                style="width:100%;border-radius:10px;border:1px solid rgba(201,168,76,0.3);object-fit:cover;max-height:200px;display:block;cursor:zoom-in"/>
              <button onclick="event.stopPropagation();confirmRemovePhoto('${date}')"
                style="position:absolute;top:6px;right:6px;background:rgba(192,57,43,0.85);color:#fff;border:none;border-radius:50%;width:30px;height:30px;font-size:0.85rem;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.5)" title="Foto lÃ¶schen">ðŸ—‘ï¸</button>
            </div>
            <label onclick="event.stopPropagation()"
              style="display:flex;align-items:center;justify-content:center;gap:8px;width:100%;background:rgba(41,128,185,0.12);color:#5dade2;border:1px solid rgba(93,173,226,0.35);border-radius:8px;padding:11px 10px;font-family:Cinzel,serif;font-size:0.68rem;letter-spacing:0.1em;cursor:pointer;margin:0;box-sizing:border-box;transition:all 0.15s;line-height:1;vertical-align:middle"
              onmouseover="this.style.background='rgba(41,128,185,0.25)'" onmouseout="this.style.background='rgba(41,128,185,0.12)'">
              <span style="font-size:1rem;line-height:1;display:flex;align-items:center">ðŸ“·</span>
              <span style="line-height:1;display:flex;align-items:center">FOTO DES ABENDS</span>
              <input type="file" accept="image/*" style="display:none" onchange="handlePhotoUpload(event,'${date}')">
            </label>
          </div>
          <button onclick="event.stopPropagation();deleteNight('${date}')"
            style="margin-top:8px;width:100%;background:rgba(192,57,43,0.12);color:#e74c3c;border:1px solid rgba(192,57,43,0.35);border-radius:8px;padding:9px;font-family:'Cinzel',serif;font-size:0.7rem;letter-spacing:0.1em;cursor:pointer;transition:all 0.15s;"
            onmouseover="this.style.background='rgba(192,57,43,0.28)'" onmouseout="this.style.background='rgba(192,57,43,0.12)'">
            âœ• &nbsp;GANZEN ABEND LÃ–SCHEN
          </button>
        </div>
      </div>
    </div>`;
  }).join('');
  // Restore saved photos after DOM update
  setTimeout(loadPhotosForSessions, 0);
}

// â”€â”€ River card flip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function flipRiver() {
  const back  = document.getElementById('river-back');
  const front = document.getElementById('river-front');
  if (!back || !front) return;
  const isBack = back.style.display !== 'none';
  back.style.display  = isBack ? 'none' : '';
  front.style.display = isBack ? ''     : 'none';
}

// â”€â”€ Left hand flip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function flipHand() {
  const b1 = document.getElementById('hand-back-1');
  const b2 = document.getElementById('hand-back-2');
  const f1 = document.getElementById('hand-front-1');
  const f2 = document.getElementById('hand-front-2');
  if (!b1) return;
  const isBack = b1.style.display !== 'none';
  b1.style.display = isBack ? 'none' : '';
  b2.style.display = isBack ? 'none' : '';
  f1.style.display = isBack ? ''     : 'none';
  f2.style.display = isBack ? ''     : 'none';
}

function toggleNight(id, card) {
  const panel = document.getElementById(id);
  const chevron = card.querySelector('.session-night-chevron');
  const isOpen = panel.classList.contains('open');
  document.querySelectorAll('.session-detail-panel').forEach(p => p.classList.remove('open'));
  document.querySelectorAll('.session-night-chevron').forEach(c => c.classList.remove('open'));
  if (!isOpen) {
    panel.classList.add('open');
    chevron.classList.add('open');
  }
}

// â”€â”€ SCHULDENAUSGLEICH (Splitwise-Algorithmus) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcSettlement(nightSessions) {
  // Build balance map: profit = cashout - buyin
  const balances = {};
  nightSessions.forEach(s => {
    const name = s.player_name.trim();
    balances[name] = (balances[name] || 0) + (s.cash_out - s.buy_in);
  });

  // Check for imbalance: sum of all profits should be 0
  const totalDiff = Math.round(Object.values(balances).reduce((a, b) => a + b, 0) * 100) / 100;

  // If there's an imbalance, distribute it proportionally among winners
  // (winners get slightly less, as the missing chips likely came from them)
  if (Math.abs(totalDiff) > 0.01) {
    const winners = Object.entries(balances).filter(([, v]) => v > 0);
    const totalWinnings = winners.reduce((s, [, v]) => s + v, 0);
    if (totalWinnings > 0) {
      winners.forEach(([name, v]) => {
        balances[name] = Math.round((v - totalDiff * (v / totalWinnings)) * 100) / 100;
      });
    }
  }

  // Separate into creditors (positive) and debtors (negative)
  let creditors = [];
  let debtors   = [];
  Object.entries(balances).forEach(([name, amount]) => {
    const rounded = Math.round(amount * 100) / 100;
    if (rounded > 0.01)  creditors.push({ name, amount: rounded });
    if (rounded < -0.01) debtors.push({ name, amount: Math.abs(rounded) });
  });

  // Greedy minimisation: always match the largest debtor with the largest creditor
  creditors.sort((a,b) => b.amount - a.amount);
  debtors.sort((a,b) => b.amount - a.amount);

  const transfers = [];
  let ci = 0, di = 0;
  while (ci < creditors.length && di < debtors.length) {
    const c = creditors[ci];
    const d = debtors[di];
    const amount = Math.min(c.amount, d.amount);
    transfers.push({ from: d.name, to: c.name, amount: Math.round(amount * 100) / 100 });
    c.amount -= amount;
    d.amount -= amount;
    if (c.amount < 0.01) ci++;
    if (d.amount < 0.01) di++;
  }
  return { transfers, diff: totalDiff };
}

function openSettlement(date) {
  event.stopPropagation();
  const nightSessions = sessions.filter(s => s.date === date);
  const { transfers, diff } = calcSettlement(nightSessions);

  document.getElementById('settlementDate').textContent = formatDate(date);

  const body = document.getElementById('settlementBody');

  // Warning banner if there's an imbalance
  const imbalanceMsg = diff > 0.01
    ? `Gesamt-Gewinne (${formatEuro(diff)} zu viel) Ã¼bersteigen die Verluste â€” jemand hat sich beim AuszÃ¤hlen zu hoch eingetragen. Die Auszahlungen wurden proportional unter den Gewinnern gekÃ¼rzt.`
    : `Gesamt-Verluste (${formatEuro(Math.abs(diff))} zu viel) Ã¼bersteigen die Gewinne â€” jemand hat sich beim AuszÃ¤hlen zu niedrig eingetragen. Die Auszahlungen wurden proportional unter den Gewinnern gekÃ¼rzt.`;

  const imbalanceHtml = Math.abs(diff) > 0.01 ? `
    <div style="margin-bottom:14px;padding:12px 14px;border-radius:10px;background:rgba(251,146,60,0.1);border:1px solid rgba(251,146,60,0.4);display:flex;gap:10px;align-items:flex-start">
      <span style="font-size:1.1rem;flex-shrink:0">âš ï¸</span>
      <div>
        <div class="font-display" style="font-size:0.72rem;color:#fb923c;letter-spacing:0.08em;margin-bottom:3px">DIFFERENZ ERKANNT: ${diff > 0 ? '+' : ''}${formatEuro(diff)}</div>
        <div style="font-size:0.78rem;color:var(--text-muted);line-height:1.4">${imbalanceMsg}</div>
      </div>
    </div>` : '';

  if (!transfers.length) {
    body.innerHTML = imbalanceHtml + `<div style="text-align:center;padding:30px 10px;color:var(--text-muted);font-style:italic">
      Alle Spieler sind bereits ausgeglichen âœ“</div>`;
  } else {
    body.innerHTML = imbalanceHtml + transfers.map(t => `
      <div class="transfer-row">
        <div style="flex:1;min-width:0">
          <div class="font-display" style="font-size:0.8rem;color:var(--text-primary);letter-spacing:0.04em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(t.from)}</div>
          <div style="font-size:0.72rem;color:var(--text-muted);margin-top:1px">zahlt an</div>
        </div>
        <span class="transfer-arrow">â†’</span>
        <div class="transfer-amount">${formatEuro(t.amount)}</div>
        <span class="transfer-arrow">â†’</span>
        <div style="flex:1;min-width:0;text-align:right">
          <div class="font-display" style="font-size:0.8rem;color:var(--gold-light);letter-spacing:0.04em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(t.to)}</div>
          <div style="font-size:0.72rem;color:var(--text-muted);margin-top:1px">empfÃ¤ngt</div>
        </div>
      </div>`).join('') +
      `<div style="margin-top:14px;padding:12px 14px;border-radius:8px;background:rgba(201,168,76,0.07);border:1px solid rgba(201,168,76,0.18);text-align:center">
        <span class="font-display" style="font-size:0.65rem;color:var(--text-muted);letter-spacing:0.1em">
          ${transfers.length} Ãœberweisung${transfers.length !== 1 ? 'en' : ''} â€” danach sind alle quitt â™ 
        </span>
      </div>`;
  }
  document.getElementById('settlementModal').classList.add('open');
}

function closeSettlement(e) {
  if (!e || e.target === document.getElementById('settlementModal')) {
    document.getElementById('settlementModal').classList.remove('open');
  }
}

function monthShort(date) {
  const months = ['Jan','Feb','MÃ¤r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
  return months[parseInt(date.split('-')[1]) - 1];
}

function renderQuickStats(data) {
  const el = document.getElementById('quickStats');
  if (!data.length) { el.innerHTML = ''; return; }
  const totalBuyin = data.reduce((a,s) => a + s.buy_in, 0);
  const players    = new Set(data.map(s => s.player_name)).size;
  const nights     = new Set(data.map(s => s.date)).size;
  el.innerHTML = `
    <div class="stat-card">
      <div style="font-size:1.4rem;margin-bottom:4px">ðŸƒ</div>
      <div class="stat-value gold-text">${nights}</div>
      <div class="stat-label">Abende</div>
    </div>
    <div class="stat-card">
      <svg width="28" height="28" viewBox="0 0 28 28" style="margin:0 auto 4px"><circle cx="14" cy="14" r="13" fill="#C9A84C" stroke="#8A6B28" stroke-width="1.5"/><circle cx="14" cy="14" r="9" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1.5" stroke-dasharray="3 2"/><circle cx="14" cy="14" r="5" fill="rgba(0,0,0,0.3)"/></svg>
      <div class="stat-value gold-text">${players}</div>
      <div class="stat-label">Spieler</div>
    </div>
    <div class="stat-card">
      <div style="font-size:1.4rem;margin-bottom:4px">ðŸ’°</div>
      <div class="stat-value gold-text">${formatEuro(totalBuyin)}</div>
      <div class="stat-label">Pot Total</div>
    </div>
  `;
}

// ---- LEADERBOARD ----
let leaderboardSort = 'top';
let leaderboardYear = String(new Date().getFullYear());
let sessionsYear    = String(new Date().getFullYear());
let achievementsYear = String(new Date().getFullYear());
let achSortMode = 'difficulty';

function setAchFilter(mode) {
  achSortMode = mode;
  document.getElementById('achFilter-difficulty').classList.toggle('active', mode === 'difficulty');
  document.getElementById('achFilter-unlocked').classList.toggle('active', mode === 'unlocked');
  renderAchievements();
}

// ---- YEAR HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getAvailableYears() {
  const years = [...new Set(sessions.map(s => s.date.split('-')[0]))].sort().reverse();
  return years;
}

function getMostRecentYear() {
  const years = getAvailableYears();
  return years.length ? years[0] : String(new Date().getFullYear());
}

function getSessionsForYear(year) {
  return sessions.filter(s => s.date.startsWith(year));
}

function renderYearPills(containerId, currentYear, onClickFn) {
  const el = document.getElementById(containerId);
  if (!el) return;
  const years = getAvailableYears();
  // If current year no longer valid, reset to most recent
  if (!years.includes(currentYear)) {
    currentYear = years[0] || currentYear;
  }
  el.innerHTML = years.map(y => {
    const isActive = y === currentYear;
    return `<button
      class="year-pill ${isActive ? 'active' : ''}"
      onclick="${onClickFn}('${y}')"
    >${y}</button>`;
  }).join('');
}

// ---- LEADERBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLeaderboardSort(mode) {
  leaderboardSort = mode;
  document.getElementById('sortBtnTop').classList.toggle('active', mode === 'top');
  document.getElementById('sortBtnBottom').classList.toggle('active', mode === 'bottom');
  renderLeaderboard();
}

function setLeaderboardYear(year) {
  leaderboardYear = year;
  renderLeaderboard();
}

function setSessionsYear(year) {
  sessionsYear = year;
  renderSessions();
}

function setAchievementsYear(year) {
  achievementsYear = year;
  renderAchievements();
}

function renderLeaderboard() {
  renderYearPills('lbYearPills', leaderboardYear, 'setLeaderboardYear');

  const el = document.getElementById('leaderboardBody');
  if (!el) return;

  const filtered = getSessionsForYear(leaderboardYear);
  if (!filtered.length) {
    el.innerHTML = '<div class="empty-state">Keine Daten fÃ¼r dieses Jahr â™¦</div>'; return;
  }

  const playerMap = {};
  filtered.forEach(s => {
    const key = s.player_name.trim();
    if (!playerMap[key]) playerMap[key] = { sessions: 0, profit: 0, buyin: 0, cashout: 0 };
    playerMap[key].sessions++;
    playerMap[key].profit  += (s.cash_out - s.buy_in);
    playerMap[key].buyin   += s.buy_in;
    playerMap[key].cashout += s.cash_out;
  });

  const sorted = Object.entries(playerMap).sort((a,b) =>
    leaderboardSort === 'top'
      ? b[1].profit - a[1].profit
      : a[1].profit - b[1].profit
  );

  const medals      = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
  const rankClasses = ['leaderboard-rank-1','leaderboard-rank-2','leaderboard-rank-3'];
  const maxAbsProfit = Math.max(...Object.values(playerMap).map(p => Math.abs(p.profit)), 1);

  el.innerHTML = sorted.map(([name, stats], i) => {
    const cls  = leaderboardSort === 'top' ? (rankClasses[i] || '') : '';
    const pCls = profitClass(stats.profit);
    const barPct = Math.round((Math.abs(stats.profit) / maxAbsProfit) * 100);
    const barColor = stats.profit >= 0 ? '#4ade80' : '#f87171';
    const avgProfit = stats.profit / stats.sessions;
    const chipColors = ['#C9A84C','#C0C0C0','#CD7F32'];
    const chipInner  = ['100','50','25'];
    const chipBadge  = i < 3
      ? `<svg width="32" height="32" viewBox="0 0 32 32">
          <circle cx="16" cy="16" r="15" fill="${chipColors[i]}" stroke="rgba(0,0,0,0.4)" stroke-width="1.5"/>
          <circle cx="16" cy="16" r="11" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1.8" stroke-dasharray="4 3"/>
          <circle cx="16" cy="16" r="6" fill="rgba(0,0,0,0.3)"/>
          <text x="16" y="20" text-anchor="middle" font-size="6" fill="rgba(255,255,255,0.9)" font-family="Cinzel,serif" font-weight="bold">${chipInner[i]}</text>
        </svg>`
      : `<span style="font-family:Cinzel,serif;color:var(--text-muted);font-size:0.9rem">${i+1}.</span>`;
    const badge = leaderboardSort === 'top'
      ? chipBadge
      : (leaderboardSort === 'bottom' && i < 3 ? '&#128128;' : `<span style="font-family:Cinzel,serif;color:var(--text-muted)">${i+1}.</span>`);

    return `
    <div class="card-raised mb-3" style="cursor:pointer;transition:all 0.2s"
         onclick="openPlayerDetail('${esc(name)}')"
         onmouseover="this.style.borderColor='rgba(201,168,76,0.5)'"
         onmouseout="this.style.borderColor='rgba(201,168,76,0.3)'">
      <div style="padding:14px 16px">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-3">
            <span class="text-xl">${badge}</span>
            ${getAvatarHtml(name)}
            <div>
              <div class="font-display text-sm ${cls}" style="letter-spacing:0.05em">${esc(name)}</div>
              <div style="color:var(--text-muted);font-size:0.78rem;margin-top:1px">
                ${stats.sessions} Sessions &nbsp;Â·&nbsp; &#216; ${formatEuroSign(avgProfit)} / Abend
              </div>
            </div>
          </div>
          <div class="text-right">
            <div class="font-display text-lg ${pCls}">${formatEuroSign(stats.profit)}</div>
            <div style="color:var(--text-muted);font-size:0.7rem">Gesamt &nbsp;&#x25BA;</div>
          </div>
        </div>
        <div style="height:3px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden">
          <div style="height:100%;width:${barPct}%;background:${barColor};border-radius:2px;transition:width 0.4s ease"></div>
        </div>
      </div>
    </div>`;
  }).join('');
}

// ---- PLAYER DETAIL ----
function openPlayerDetail(name) {
  const playerSessions = sessions
    .filter(s => s.player_name.trim() === name)
    .sort((a,b) => b.date.localeCompare(a.date));

  const totalProfit = playerSessions.reduce((a,s) => a + (s.cash_out - s.buy_in), 0);
  const totalBuyin  = playerSessions.reduce((a,s) => a + s.buy_in, 0);
  const wins  = playerSessions.filter(s => s.cash_out > s.buy_in).length;
  const losses= playerSessions.filter(s => s.cash_out < s.buy_in).length;
  const best  = [...playerSessions].sort((a,b) => (b.cash_out-b.buy_in)-(a.cash_out-a.buy_in))[0];
  const worst = [...playerSessions].sort((a,b) => (a.cash_out-a.buy_in)-(b.cash_out-b.buy_in))[0];

  // â”€â”€ Streak calculation (chronological order) â”€â”€
  const chronological = [...playerSessions].sort((a,b) => a.date.localeCompare(b.date));
  let maxWinStreak = 0, maxLossStreak = 0;
  let curWin = 0, curLoss = 0;
  let curWinStreak = 0, curLossStreak = 0; // current active streak
  chronological.forEach((s, i) => {
    const profit = s.cash_out - s.buy_in;
    if (profit > 0) {
      curWin++; curLoss = 0;
      maxWinStreak = Math.max(maxWinStreak, curWin);
    } else if (profit < 0) {
      curLoss++; curWin = 0;
      maxLossStreak = Math.max(maxLossStreak, curLoss);
    } else {
      curWin = 0; curLoss = 0; // draw resets
    }
    // Track current streak (last session decides direction)
    if (i === chronological.length - 1) {
      curWinStreak  = profit > 0 ? curWin  : 0;
      curLossStreak = profit < 0 ? curLoss : 0;
    }
  });

  const pCls = profitClass(totalProfit);

  // Current streak indicator
  const currentStreakHtml = curWinStreak >= 2
    ? `<div style="text-align:center;margin-bottom:14px;padding:8px 14px;border-radius:8px;background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.3)">
        <span style="font-family:'Cinzel',serif;font-size:0.7rem;color:#4ade80;letter-spacing:0.1em">ðŸ”¥ AKTUELL ${curWinStreak}Ã— IN FOLGE GEWONNEN</span>
       </div>`
    : curLossStreak >= 2
    ? `<div style="text-align:center;margin-bottom:14px;padding:8px 14px;border-radius:8px;background:rgba(248,113,113,0.1);border:1px solid rgba(248,113,113,0.3)">
        <span style="font-family:'Cinzel',serif;font-size:0.7rem;color:#f87171;letter-spacing:0.1em">ðŸ’€ AKTUELL ${curLossStreak}Ã— IN FOLGE VERLOREN</span>
       </div>`
    : '';

  const statsGrid = `
  <div class="grid grid-cols-2 gap-2 mb-5">
    <div class="stat-card">
      <div class="stat-value ${pCls}">${formatEuroSign(totalProfit)}</div>
      <div class="stat-label">Gesamt-Profit</div>
    </div>
    <div class="stat-card">
      <div class="stat-value gold-text">${playerSessions.length}</div>
      <div class="stat-label">Sessions</div>
    </div>
    <div class="stat-card">
      <div class="stat-value profit-pos">${wins}</div>
      <div class="stat-label">Gewonnen</div>
    </div>
    <div class="stat-card">
      <div class="stat-value profit-neg">${losses}</div>
      <div class="stat-label">Verloren</div>
    </div>
  </div>
  ${best ? `
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
    <div class="stat-card">
      <div class="stat-label">Bester Abend</div>
      <div style="font-size:0.85rem;margin-top:4px;color:var(--text-primary)">${formatDate(best.date)}</div>
      <div class="font-display profit-pos" style="font-size:1rem;margin-top:2px">${formatEuroSign(best.cash_out-best.buy_in)}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Schlechtester</div>
      <div style="font-size:0.85rem;margin-top:4px;color:var(--text-primary)">${formatDate(worst.date)}</div>
      <div class="font-display profit-neg" style="font-size:1rem;margin-top:2px">${formatEuroSign(worst.cash_out-worst.buy_in)}</div>
    </div>
  </div>` : ''}
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px">
    <div class="stat-card">
      <div class="stat-value profit-pos">${maxWinStreak}</div>
      <div class="stat-label">ðŸ† Longest Win</div>
    </div>
    <div class="stat-card">
      <div class="stat-value profit-neg">${maxLossStreak}</div>
      <div class="stat-label">ðŸ’€ Longest Loss</div>
    </div>
  </div>`;

  const suits=['â™ ','â™¥','â™¦','â™£'];
  const sessionRows = playerSessions.map((s, idx) => {
    const profit = s.cash_out - s.buy_in;
    const pCls2 = profitClass(profit);
    return `
    <div class="player-row">
      <div style="display:flex;align-items:center;gap:8px">
        <span style="color:rgba(201,168,76,0.3);font-size:0.9rem">${suits[idx%4]}</span>
        <div>
          <div class="font-display text-xs" style="color:var(--gold-light)">${formatDate(s.date)}</div>
          <div style="color:var(--text-muted);font-size:0.8rem;margin-top:2px">
            Buy-In: ${formatEuro(s.buy_in)} &nbsp;Â·&nbsp; Cash-Out: ${formatEuro(s.cash_out)}
          </div>
        </div>
      </div>
      <div class="font-display text-base ${pCls2}">${formatEuroSign(profit)}</div>
    </div>`;
  }).join('');

  document.getElementById('playerDetailContent').innerHTML = `
    <div style="display:flex;justify-content:center;gap:6px;margin-bottom:14px">
      <svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="9" fill="#C0392B" stroke="#8B0000" stroke-width="1"/><circle cx="10" cy="10" r="6.5" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1.2" stroke-dasharray="3 2"/></svg>
      <svg width="22" height="22" viewBox="0 0 22 22"><circle cx="11" cy="11" r="10" fill="#C9A84C" stroke="#8A6B28" stroke-width="1"/><circle cx="11" cy="11" r="7" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1.5" stroke-dasharray="3 2"/></svg>
      <svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="9" fill="#2980B9" stroke="#1a5276" stroke-width="1"/><circle cx="10" cy="10" r="6.5" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1.2" stroke-dasharray="3 2"/></svg>
    </div>
    <div class="header-ornament mb-5">
      <span class="font-display text-sm" style="color:var(--gold-light);letter-spacing:0.1em">${esc(name)}</span>
    </div>
    ${currentStreakHtml}
    ${statsGrid}

    <!-- HEAD TO HEAD -->
    <div style="margin-bottom:20px;padding:14px;border-radius:10px;background:rgba(0,0,0,0.25);border:1px solid rgba(201,168,76,0.15)">
      <div class="font-display text-xs mb-3" style="color:var(--gold);letter-spacing:0.12em">âš”ï¸ HEAD TO HEAD</div>
      <select class="h2h-select" onchange="renderH2H('${esc(name)}', this.value)">
        <option value="">â€” Spieler zum Vergleich wÃ¤hlen â€”</option>
        ${[...new Set(sessions.map(s=>s.player_name))].filter(p=>p!==name).sort().map(p=>`<option value="${esc(p)}">${esc(p)}</option>`).join('')}
      </select>
      <div id="h2hResult"></div>
    </div>

    <div class="font-display text-xs mb-3" style="color:var(--gold);letter-spacing:0.12em">ALLE SESSIONS</div>
    ${sessionRows || '<div class="empty-state">Keine Sessions</div>'}
  `;

  document.getElementById('view-leaderboard').style.display = 'none';
  document.getElementById('view-player-detail').style.display = 'block';
}

// â”€â”€ PLAYER AVATARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let avatarCache = {}; // name â†’ url
let avatarUploadTarget = null;

async function loadAvatars() {
  if (isOfflineMode || !db) return;
  try {
    const { data: files } = await db.storage.from('poker-photos').list('avatars');
    if (!files) return;
    for (const file of files) {
      const playerName = decodeURIComponent(file.name.replace(/\.[^.]+$/, ''));
      const { data } = db.storage.from('poker-photos').getPublicUrl('avatars/' + file.name);
      if (data?.publicUrl) avatarCache[playerName] = data.publicUrl + '?t=' + file.updated_at;
    }
    // Re-render leaderboard with avatars
    renderLeaderboard();
    renderSessions();
  } catch(e) { console.warn('Avatar load error:', e); }
}

function getAvatarHtml(name) {
  const url = avatarCache[name];
  if (url) {
    return `<img class="player-avatar" src="${url}" alt="${esc(name)}"
      onclick="event.stopPropagation();openAvatarMenu(event,'${esc(name)}')"
      title="Foto Ã¤ndern / lÃ¶schen">`;
  }
  return `<div class="player-avatar-placeholder"
    onclick="event.stopPropagation();triggerAvatarUpload('${esc(name)}')"
    title="Foto hinzufÃ¼gen">ðŸ‘¤</div>`;
}

// â”€â”€ Avatar context menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _avatarMenuEl = null;

function openAvatarMenu(e, name) {
  closeAvatarMenu();
  avatarUploadTarget = name;

  const menu = document.createElement('div');
  menu.className = 'avatar-menu';
  menu.id = 'avatarContextMenu';
  menu.innerHTML = `
    <button class="avatar-menu-item" onclick="closeAvatarMenu();triggerAvatarUpload('${esc(name)}')">
      <span>ðŸ“·</span> Foto Ã¤ndern
    </button>
    <div class="avatar-menu-divider"></div>
    <button class="avatar-menu-item danger" onclick="closeAvatarMenu();confirmDeleteAvatar('${esc(name)}')">
      <span>ðŸ—‘ï¸</span> Foto lÃ¶schen
    </button>`;

  // Position near the click, keep within viewport
  document.body.appendChild(menu);
  _avatarMenuEl = menu;

  const rect = menu.getBoundingClientRect();
  let x = e.clientX, y = e.clientY + 8;
  if (x + rect.width > window.innerWidth - 8) x = window.innerWidth - rect.width - 8;
  if (y + rect.height > window.innerHeight - 8) y = e.clientY - rect.height - 8;
  menu.style.left = x + 'px';
  menu.style.top  = y + 'px';

  // Close on outside click
  setTimeout(() => document.addEventListener('click', closeAvatarMenu, { once: true }), 0);
}

function closeAvatarMenu() {
  if (_avatarMenuEl) { _avatarMenuEl.remove(); _avatarMenuEl = null; }
}

async function confirmDeleteAvatar(name) {
  if (!confirm(`Profilbild von ${name} wirklich lÃ¶schen?`)) return;
  await deleteAvatar(name);
}

async function deleteAvatar(name) {
  // Find file in storage (extension unknown, try common ones)
  if (isOfflineMode || !db) { showToast('âš  Nicht verbunden'); return; }
  showToast('ðŸ—‘ Foto wird gelÃ¶schtâ€¦');
  try {
    const { data: files } = await db.storage.from('poker-photos').list('avatars');
    const match = (files || []).find(f => decodeURIComponent(f.name.replace(/\.[^.]+$/, '')) === name);
    if (!match) { showToast('âš  Foto nicht gefunden'); return; }
    const { error } = await db.storage.from('poker-photos').remove([`avatars/${match.name}`]);
    if (error) throw error;
    delete avatarCache[name];
    renderLeaderboard();
    showToast('âœ“ Foto gelÃ¶scht');
  } catch(e) {
    showToast('âš  LÃ¶schen fehlgeschlagen: ' + (e.message || e));
  }
}

function triggerAvatarUpload(name) {
  avatarUploadTarget = name;
  document.getElementById('avatarFileInput').click();
}

async function handleAvatarUpload(event) {
  const file = event.target.files[0];
  event.target.value = '';
  if (!file || !avatarUploadTarget) return;
  if (file.size > 5 * 1024 * 1024) { showToast('âš  Bild zu groÃŸ (max 5 MB)'); return; }

  showToast('ðŸ‘¤ Foto wird hochgeladenâ€¦');
  const ext  = file.name.split('.').pop() || 'jpg';
  const path = `avatars/${encodeURIComponent(avatarUploadTarget)}.${ext}`;

  try {
    const { error } = await db.storage.from('poker-photos').upload(path, file, { upsert: true, contentType: file.type });
    if (error) throw error;
    const { data } = db.storage.from('poker-photos').getPublicUrl(path);
    avatarCache[avatarUploadTarget] = data.publicUrl + '?t=' + Date.now();
    renderLeaderboard();
    showToast('âœ“ Profilbild gespeichert!');
  } catch(e) {
    showToast('âš  Upload fehlgeschlagen: ' + (e.message || e));
  }
  avatarUploadTarget = null;
}

function closePlayerDetail() {
  document.getElementById('view-player-detail').style.display = 'none';
  document.getElementById('view-leaderboard').style.display = 'block';
}

function renderH2H(nameA, nameB) {
  const el = document.getElementById('h2hResult');
  if (!el || !nameB) { if (el) el.innerHTML = ''; return; }

  function calcStats(name) {
    const ss = sessions.filter(s => s.player_name.trim() === name);
    const profit = ss.reduce((a,s) => a + (s.cash_out - s.buy_in), 0);
    const wins   = ss.filter(s => s.cash_out > s.buy_in).length;
    const losses = ss.filter(s => s.cash_out < s.buy_in).length;
    const avg    = ss.length ? profit / ss.length : 0;
    const best   = ss.length ? Math.max(...ss.map(s => s.cash_out - s.buy_in)) : 0;
    const worst  = ss.length ? Math.min(...ss.map(s => s.cash_out - s.buy_in)) : 0;
    const wr     = ss.length ? Math.round((wins / ss.length) * 100) : 0;
    return { profit, wins, losses, avg, best, worst, wr, count: ss.length };
  }

  const a = calcStats(nameA);
  const b = calcStats(nameB);

  // Helper: returns CSS class based on which value is better (higher = better unless inverted)
  const cls = (va, vb, invert=false) => {
    if (va === vb) return ['', ''];
    const aWins = invert ? va < vb : va > vb;
    return aWins ? ['better', 'worse'] : ['worse', 'better'];
  };

  const rows = [
    { label: 'Sessions',       va: a.count,  vb: b.count,  fmt: v => v,                          better: cls(a.count, b.count) },
    { label: 'Profit gesamt',  va: a.profit, vb: b.profit, fmt: v => formatEuroSign(v),           better: cls(a.profit, b.profit) },
    { label: 'Ã˜ pro Abend',    va: a.avg,    vb: b.avg,    fmt: v => formatEuroSign(v),           better: cls(a.avg, b.avg) },
    { label: 'Win-Rate',       va: a.wr,     vb: b.wr,     fmt: v => v + '%',                     better: cls(a.wr, b.wr) },
    { label: 'Gewonnen',       va: a.wins,   vb: b.wins,   fmt: v => v,                           better: cls(a.wins, b.wins) },
    { label: 'Verloren',       va: a.losses, vb: b.losses, fmt: v => v,                           better: cls(a.losses, b.losses, true) },
    { label: 'Bester Abend',   va: a.best,   vb: b.best,   fmt: v => formatEuroSign(v),           better: cls(a.best, b.best) },
    { label: 'Schlechtester',  va: a.worst,  vb: b.worst,  fmt: v => formatEuroSign(v),           better: cls(a.worst, b.worst) },
  ];

  const rowsHtml = rows.map(r => `
    <div class="h2h-val ${r.better[0]}" style="text-align:right">${r.fmt(r.va)}</div>
    <div class="h2h-row-label">${r.label}</div>
    <div class="h2h-val ${r.better[1]}">${r.fmt(r.vb)}</div>
  `).join('');

  el.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:3px;margin-bottom:12px">
      <div style="font-family:'Cinzel',serif;font-size:0.72rem;color:var(--gold-light);text-align:right;padding:0 6px 6px">${esc(nameA)}</div>
      <div></div>
      <div style="font-family:'Cinzel',serif;font-size:0.72rem;color:var(--gold-light);padding:0 6px 6px">${esc(nameB)}</div>
      ${rowsHtml}
    </div>
    <div style="display:flex;justify-content:center;gap:16px;font-size:0.62rem;color:var(--text-muted);font-style:italic">
      <span style="color:#4ade80">â–  besser</span>
      <span style="color:#f87171">â–  schlechter</span>
    </div>`;
}

// ---- CHART ----
// ---- CHART FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let chartYear = String(new Date().getFullYear());
let chartType = 'cumulative';

function setChartType(type) {
  chartType = type;
  ['cumulative','winrate','rebuy'].forEach(t => {
    document.getElementById('chartType-' + t).classList.toggle('active', t === type);
  });
  // Show player filter only for cumulative
  document.getElementById('chartPlayerFilter').style.display = type === 'cumulative' ? 'block' : 'none';
  drawChart();
}

function setChartYear(year) {
  chartYear = year;
  renderChart();
}

function updateChartSelect() {
  const sel = document.getElementById('chartPlayerSelect');
  if (!sel) return;
  const filtered = getSessionsForYear(chartYear);
  const allPlayers = [...new Set(filtered.map(s => s.player_name))].sort();
  const prev = new Set([...sel.options].filter(o => o.selected).map(o => o.value));
  sel.innerHTML = allPlayers.map(p => {
    const selected = prev.size === 0 ? true : prev.has(p);
    return `<option value="${p.replace(/"/g,'&quot;')}" ${selected ? 'selected' : ''}
      style="padding:5px 8px;background:#2E2E32;color:#F0E6CC">${p}</option>`;
  }).join('');
}

function getChartSelectedPlayers() {
  const sel = document.getElementById('chartPlayerSelect');
  if (!sel) return [];
  const chosen = [...sel.options].filter(o => o.selected).map(o => o.value);
  if (chosen.length === 0) {
    [...sel.options].forEach(o => o.selected = true);
    return [...sel.options].map(o => o.value);
  }
  return chosen;
}

function onChartSelectChange() {
  const chosen = getChartSelectedPlayers();
  if (chosen.length === 0) { selectAllChartPlayers(); return; }
  drawChart();
}

function selectAllChartPlayers() {
  const sel = document.getElementById('chartPlayerSelect');
  if (!sel) return;
  [...sel.options].forEach(o => o.selected = true);
  drawChart();
}

function selectNoChartPlayers() {
  const sel = document.getElementById('chartPlayerSelect');
  if (!sel || sel.options.length === 0) return;
  [...sel.options].forEach(o => o.selected = false);
  if (sel.options[0]) sel.options[0].selected = true;
  drawChart();
}

function renderChart() {
  if (!sessions.length) return;
  renderYearPills('chartYearPills', chartYear, 'setChartYear');
  updateChartSelect();
  drawChart();
}

function drawChart() {
  if (!sessions.length) return;
  // Clean up winrate custom elements
  const winrateTable = document.getElementById('winrateTable');
  if (winrateTable) winrateTable.remove();
  const winrateNote = document.getElementById('winrateNote');
  if (winrateNote) winrateNote.remove();
  // Restore canvas visibility
  const canvas = document.getElementById('profitChart');
  if (canvas) { canvas.style.display = ''; canvas.style.height = ''; canvas.style.minHeight = ''; }
  const container = document.getElementById('chartContainer');
  if (container) { container.style.display = ''; container.style.padding = ''; container.style.border = ''; }
  // Clean up rebuy table
  const rebuyTable = document.getElementById('rebuyTable');
  if (rebuyTable) rebuyTable.remove();

  if (chartType === 'cumulative') drawCumulativeChart();
  else if (chartType === 'winrate') drawWinRateChart();
  else if (chartType === 'rebuy') drawRebuyChart();
}

function drawCumulativeChart() {
  // Use ALL sessions for cumulative (not just filtered year) so the chart
  // shows the true running total; but group by month for readability.
  const sourceData = chartYear === 'all' ? sessions : getSessionsForYear(chartYear);
  if (!sourceData.length) { if (chartInstance) { chartInstance.destroy(); chartInstance = null; } return; }

  const allPlayers     = [...new Set(sourceData.map(s => s.player_name))];
  const activePlayers  = getChartSelectedPlayers().filter(p => allPlayers.includes(p));
  const allTimePlayers = [...new Set(sessions.map(s => s.player_name))];
  const sortedByDate   = [...sourceData].sort((a,b) => a.date.localeCompare(b.date));

  // Build sorted list of unique YYYY-MM months
  const allMonths = [...new Set(sortedByDate.map(s => s.date.slice(0,7)))].sort();

  // Month label: "Jan 25"
  const monthNames = ['Jan','Feb','MÃ¤r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
  const monthLabel = m => {
    const [y, mo] = m.split('-');
    return monthNames[parseInt(mo,10)-1] + ' '' + y.slice(2);
  };

  const datasets = activePlayers.map((player) => {
    const colorIdx = allTimePlayers.indexOf(player);
    const color = COLORS[colorIdx % COLORS.length];
    let cumulative = 0;
    const data = allMonths.map(month => {
      sortedByDate
        .filter(s => s.player_name === player && s.date.slice(0,7) === month)
        .forEach(s => cumulative += (s.cash_out - s.buy_in));
      return Math.round(cumulative * 100) / 100;
    });
    // Only include players who have at least one session in this period
    const hasData = data.some((v,i) => i === 0 ? v !== 0 : v !== data[i-1]);
    if (!hasData) return null;
    return {
      label: player, data,
      borderColor: color, backgroundColor: color + '22',
      borderWidth: 2.5, pointBackgroundColor: color,
      pointRadius: 5, pointHoverRadius: 8, tension: 0.3, fill: false
    };
  }).filter(Boolean);

  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
  const ctx = document.getElementById('profitChart').getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: { labels: allMonths.map(monthLabel), datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: true, position: 'bottom', labels: { color: '#8A8070', font: { family: 'Cinzel', size: 10 }, boxWidth: 12, padding: 10 } },
        tooltip: {
          backgroundColor: '#2E2E32', borderColor: 'rgba(201,168,76,0.4)', borderWidth: 1,
          titleColor: '#C9A84C', bodyColor: '#F0E6CC',
          titleFont: { family: 'Cinzel', size: 11 },
          callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y >= 0 ? '+' : ''}${ctx.parsed.y.toFixed(2)} â‚¬` }
        }
      },
      scales: {
        x: { ticks: { color: '#8A8070', font: { size: 10 }, maxRotation: 45 }, grid: { color: 'rgba(255,255,255,0.05)' } },
        y: { ticks: { color: '#8A8070', font: { size: 10 }, callback: v => v.toFixed(0) + ' â‚¬' }, grid: { color: 'rgba(255,255,255,0.05)' }, border: { dash: [4,4] } }
      }
    }
  });
}

function drawWinRateChart() {
  const filtered = getSessionsForYear(chartYear);
  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
  if (!filtered.length) return;

  const byPlayer = {};
  filtered.forEach(s => {
    if (!byPlayer[s.player_name]) byPlayer[s.player_name] = { wins: 0, total: 0 };
    byPlayer[s.player_name].total++;
    if (s.cash_out > s.buy_in) byPlayer[s.player_name].wins++;
  });

  const K = 10;
  const allEntries = Object.values(byPlayer);
  const groupWins  = allEntries.reduce((s,v) => s + v.wins, 0);
  const groupTotal = allEntries.reduce((s,v) => s + v.total, 0);
  const prior      = groupTotal > 0 ? groupWins / groupTotal : 0.5;

  const allTimePlayers = [...new Set(sessions.map(s => s.player_name))];

  const players = Object.entries(byPlayer)
    .map(([name, v]) => {
      const realWr   = v.wins / v.total;
      const bayesWr  = (v.total * realWr + K * prior) / (v.total + K);
      const confidence = Math.min(1, v.total / 15);
      const consistencyScore = bayesWr * Math.log1p(v.total);
      const color = COLORS[allTimePlayers.indexOf(name) % COLORS.length];
      return { name, realWr, bayesWr, wins: v.wins, total: v.total, confidence, consistencyScore, color };
    })
    .sort((a,b) => b.consistencyScore - a.consistencyScore);

  // Hide canvas, use container for custom HTML
  const canvas = document.getElementById('profitChart');
  canvas.style.display = 'none';
  canvas.style.height = '0';
  canvas.style.minHeight = '0';
  document.getElementById('chartContainer').style.display = 'none';

  const existing = document.getElementById('winrateTable');
  if (existing) existing.remove();

  const confStars = c => {
    const filled = Math.round(c * 5);
    return Array.from({length:5}, (_,i) =>
      `<span style="color:${i < filled ? '#C9A84C' : 'rgba(255,255,255,0.12)'}">â˜…</span>`
    ).join('');
  };

  const rows = players.map(p => {
    const realPct  = Math.round(p.realWr * 100);
    const bayesPct = Math.round(p.bayesWr * 100);
    const confPct  = Math.round(p.confidence * 100);
    const col      = p.color;

    return `
    <div style="margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
        <div style="display:flex;align-items:center;gap:8px">
          <div style="width:10px;height:10px;border-radius:50%;background:${col};flex-shrink:0"></div>
          <span style="font-family:'Cinzel',serif;font-size:0.78rem;color:var(--text-primary)">${esc(p.name)}</span>
          <span style="font-size:0.65rem;color:var(--text-muted)">${p.wins}/${p.total}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:0.68rem;color:var(--text-muted)">${confStars(p.confidence)}</span>
          <span style="font-family:'Cinzel',serif;font-size:0.82rem;color:${col};min-width:36px;text-align:right">${bayesPct}%</span>
        </div>
      </div>
      <!-- Gewichteter Balken (voll) -->
      <div style="position:relative;height:14px;background:rgba(255,255,255,0.06);border-radius:7px;overflow:hidden;margin-bottom:3px">
        <div style="height:100%;width:${bayesPct}%;background:${col};border-radius:7px;transition:width 0.6s ease"></div>
        <span style="position:absolute;right:6px;top:50%;transform:translateY(-50%);font-size:0.55rem;color:rgba(255,255,255,0.5);font-family:'Cinzel',serif">GEWICHTET</span>
      </div>
      <!-- Echter Balken (dÃ¼nner, gestrichelt) -->
      <div style="position:relative;height:7px;background:rgba(255,255,255,0.04);border-radius:4px;overflow:hidden">
        <div style="height:100%;width:${realPct}%;background:${col}55;border-radius:4px;border-top:1px dashed ${col}88"></div>
        <span style="position:absolute;right:6px;top:50%;transform:translateY(-50%);font-size:0.5rem;color:rgba(255,255,255,0.3);font-family:'Cinzel',serif">REAL ${realPct}%</span>
      </div>
    </div>`;
  }).join('');

  const table = document.createElement('div');
  table.id = 'winrateTable';
  table.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.08)">
      <span style="font-family:'Cinzel',serif;font-size:0.62rem;color:var(--gold);letter-spacing:0.1em">SPIELER</span>
      <span style="font-family:'Cinzel',serif;font-size:0.62rem;color:var(--gold);letter-spacing:0.1em">VERLÃ„SSLICHKEIT Â· SCORE</span>
    </div>
    ${rows}
    <div style="margin-top:12px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.06);font-size:0.65rem;color:var(--text-muted);text-align:center;font-style:italic">
      Dicker Balken = gewichtete Rate Â· DÃ¼nner Balken = echte Rate Â· â˜…â˜…â˜…â˜…â˜… = VerlÃ¤sslichkeit (max. bei 15+ Sessions)<br>
      GruppenÃ¸: ${Math.round(prior*100)}%
    </div>`;
  table.style.cssText = 'margin-top:14px;padding:14px;border-radius:10px;background:rgba(0,0,0,0.2);border:1px solid rgba(201,168,76,0.15)';
  document.getElementById('chartContainer').after(table);

  const existingNote = document.getElementById('winrateNote');
  if (existingNote) existingNote.remove();
}


function drawRebuyChart() {
  const filtered = getSessionsForYear(chartYear);
  if (!filtered.length) { if (chartInstance) { chartInstance.destroy(); chartInstance = null; } return; }

  const byPlayer = {};
  filtered.forEach(s => {
    if (!byPlayer[s.player_name]) byPlayer[s.player_name] = { rebuys: 0, rebuyAmount: 0, total: 0 };
    byPlayer[s.player_name].total++;
    byPlayer[s.player_name].rebuys += (s.rebuy_count || 0);
    byPlayer[s.player_name].rebuyAmount += (s.rebuys || 0);
  });

  const players = Object.entries(byPlayer)
    .filter(([,v]) => v.rebuys > 0)
    .sort(([,a],[,b]) => b.rebuys - a.rebuys)
    .map(([name, v]) => ({ name, rebuys: v.rebuys, rebuyAmount: v.rebuyAmount, total: v.total }));

  const allTimePlayers = [...new Set(sessions.map(s => s.player_name))];
  const colors = players.map(p => COLORS[allTimePlayers.indexOf(p.name) % COLORS.length]);

  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
  const ctx = document.getElementById('profitChart').getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: players.map(p => p.name),
      datasets: [{
        label: 'Anzahl Rebuys',
        data: players.map(p => p.rebuys),
        backgroundColor: colors.map(c => c + 'BB'),
        borderColor: colors,
        borderWidth: 1.5,
        borderRadius: 6,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, indexAxis: 'y',
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#2E2E32', borderColor: 'rgba(201,168,76,0.4)', borderWidth: 1,
          titleColor: '#C9A84C', bodyColor: '#F0E6CC',
          titleFont: { family: 'Cinzel', size: 11 },
          callbacks: {
            label: ctx => {
              const p = players[ctx.dataIndex];
              return ` ${p.rebuys}Ã— Rebuy Â· ${p.rebuyAmount.toFixed(2)} â‚¬ Â· Ã˜ ${(p.rebuys/p.total).toFixed(1)}/Abend`;
            }
          }
        }
      },
      scales: {
        x: { ticks: { color: '#8A8070', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' } },
        y: { ticks: { color: '#C9A84C', font: { family: 'Cinzel', size: 9 } }, grid: { display: false } }
      }
    }
  });

  // â”€â”€ Detailtabelle unter dem Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const existing = document.getElementById('rebuyTable');
  if (existing) existing.remove();

  const table = document.createElement('div');
  table.id = 'rebuyTable';
  table.style.cssText = 'margin-top:14px;border-radius:10px;overflow:hidden;border:1px solid rgba(201,168,76,0.2)';

  const header = `
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;background:rgba(201,168,76,0.1);padding:8px 12px;gap:4px">
      <div style="font-family:'Cinzel',serif;font-size:0.6rem;color:var(--gold);letter-spacing:0.1em">SPIELER</div>
      <div style="font-family:'Cinzel',serif;font-size:0.6rem;color:var(--gold);letter-spacing:0.1em;text-align:center">REBUYS</div>
      <div style="font-family:'Cinzel',serif;font-size:0.6rem;color:var(--gold);letter-spacing:0.1em;text-align:center">BETRAG</div>
      <div style="font-family:'Cinzel',serif;font-size:0.6rem;color:var(--gold);letter-spacing:0.1em;text-align:center">Ã˜ / ABEND</div>
    </div>`;

  const rows = players.map((p, i) => {
    const color = colors[i];
    const bg = i % 2 === 0 ? 'rgba(0,0,0,0.15)' : 'rgba(0,0,0,0.05)';
    return `
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;padding:9px 12px;gap:4px;background:${bg};align-items:center">
        <div style="display:flex;align-items:center;gap:6px">
          <div style="width:8px;height:8px;border-radius:50%;background:${color};flex-shrink:0"></div>
          <span style="font-size:0.78rem;color:var(--text-primary)">${esc(p.name)}</span>
        </div>
        <div style="text-align:center;font-family:'Cinzel',serif;font-size:0.85rem;color:#f87171;font-weight:bold">${p.rebuys}Ã—</div>
        <div style="text-align:center;font-family:'Cinzel',serif;font-size:0.85rem;color:#fb923c">${p.rebuyAmount.toFixed(0)} â‚¬</div>
        <div style="text-align:center;font-size:0.78rem;color:var(--text-muted)">${(p.rebuys/p.total).toFixed(1)}</div>
      </div>`;
  }).join('');

  table.innerHTML = header + rows;
  document.getElementById('chartContainer').after(table);
}

// ---- PLAYER LIST (autocomplete) ----
function updatePlayerList() {
  const sel = document.getElementById('inputPlayer');
  if (!sel) return;
  const current = sel.value;
  const players = getRegisteredPlayers();
  sel.innerHTML = '<option value="">â€” Spieler auswÃ¤hlen â€”</option>' +
    players.map(p => `<option value="${esc(p)}" ${p === current ? 'selected' : ''}>${esc(p)}</option>`).join('');
}

function getRegisteredPlayers() {
  // Merge players from sessions + locally registered players list
  const fromSessions = [...new Set(sessions.map(s => s.player_name.trim()))];
  const stored = JSON.parse(localStorage.getItem('poker_registered_players') || '[]');
  const all = [...new Set([...stored, ...fromSessions])].sort();
  return all;
}

function saveRegisteredPlayers(players) {
  try { localStorage.setItem('poker_registered_players', JSON.stringify(players)); } catch(e) {}
}

function openAddPlayerModal() {
  document.getElementById('newPlayerName').value = '';
  document.getElementById('addPlayerModal').classList.add('open');
  setTimeout(() => document.getElementById('newPlayerName').focus(), 200);
}

function closeAddPlayerModal(e) {
  if (e && e.target !== document.getElementById('addPlayerModal')) return;
  document.getElementById('addPlayerModal').classList.remove('open');
}

function confirmAddPlayer() {
  const name = document.getElementById('newPlayerName').value.trim();
  if (!name) { showToast('âš  Bitte einen Namen eingeben'); return; }

  const existing = getRegisteredPlayers();
  if (existing.map(p => p.toLowerCase()).includes(name.toLowerCase())) {
    showToast('âš  Spieler existiert bereits');
    return;
  }

  const updated = [...existing, name].sort();
  saveRegisteredPlayers(updated);
  updatePlayerList();

  // Auto-select the new player
  const sel = document.getElementById('inputPlayer');
  sel.value = name;

  document.getElementById('addPlayerModal').classList.remove('open');
  showToast(`âœ“ ${name} angelegt!`);
}

// ---- TABS ----
function showTab(name) {
  ['form','sessions','leaderboard','chart','achievements','tournament'].forEach(t => {
    const el = document.getElementById('tab-'+t);
    if (el) el.style.display = t === name ? 'block' : 'none';
  });
  document.querySelectorAll('.tab-bar .tab-btn').forEach(btn => {
    const fn = btn.getAttribute('onclick') || '';
    const match = fn.match(/showTab\('(\w+)'\)/);
    if (match) btn.classList.toggle('active', match[1] === name);
  });
  if (name === 'chart') renderChart();
  if (name === 'achievements') renderAchievements();
  if (name === 'tournament') renderTournamentTab();
}

// ---- TOAST ----
function showToast(msg) {
  const t = document.getElementById('toast');
  const suit = msg.startsWith('âœ“') ? ' â™ ' : msg.startsWith('âš ') ? '' : ' â™¦';
  t.innerHTML = msg + `<span style="opacity:0.4;margin-left:6px">${suit}</span>`;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TURNIERMODUS â€” vollstÃ¤ndig eigenstÃ¤ndig, Supabase-backed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tournaments = [];
let activeTournament = null;
let timerInterval    = null;
let timerSecondsLeft = 0;
let currentLevel     = 0;
let timerPaused      = false;
let tournamentView   = 'home'; // 'home' | 'create' | 'live' | 'rankings' | 'history'

const DEFAULT_BLIND_STRUCTURE = [
  { sb:25,  bb:50,   duration:15 },
  { sb:50,  bb:100,   duration:15 },
  { sb:75,  bb:150,  duration:15 },
  { sb:100, bb:200,  duration:15 },
  { sb:150, bb:300,  duration:15 },
  { sb:200, bb:400,  duration:15 },
  { sb:300, bb:600,  duration:15 },
  { sb:400, bb:800, duration:15 },
  { sb:500, bb:1000, duration:15 },
  { sb:750, bb:1500, duration:15 },
];

// â”€â”€ Supabase helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTournaments() {
  if (isOfflineMode || !db) {
    tournaments = JSON.parse(localStorage.getItem('poker_tournaments') || '[]');
    return;
  }
  try {
    const { data, error } = await db.from('poker_tournaments').select('*').order('date', { ascending: false });
    if (error) throw error;
    tournaments = (data || []).map(t => ({
      ...t,
      payouts: typeof t.payouts === 'string' ? JSON.parse(t.payouts) : (t.payouts || []),
      players: typeof t.players === 'string' ? JSON.parse(t.players) : (t.players || []),
      results: typeof t.results === 'string' ? JSON.parse(t.results) : (t.results || []),
      blind_structure: typeof t.blind_structure === 'string' ? JSON.parse(t.blind_structure) : (t.blind_structure || []),
    }));
    try { localStorage.setItem('poker_tournaments', JSON.stringify(tournaments)); } catch(e) {}
  } catch(e) {
    console.warn('Tournament load error:', e);
    tournaments = JSON.parse(localStorage.getItem('poker_tournaments') || '[]');
  }
}

async function saveTournamentToSupabase(t) {
  if (isOfflineMode || !db) {
    try { localStorage.setItem('poker_tournaments', JSON.stringify(tournaments)); } catch(e) {}
    return;
  }
  const payload = {
    id: t.id,
    name: t.name,
    date: t.date,
    buyin: t.buyin,
    chips: t.chips,
    payouts: t.payouts,
    players: t.players,
    results: t.results,
    blind_structure: t.blinds || t.blind_structure || [],
  };
  const { error } = await db.from('poker_tournaments').upsert(payload, { onConflict: 'id' });
  if (error) { showToast('âš  Speichern fehlgeschlagen: ' + error.message); }
  try { localStorage.setItem('poker_tournaments', JSON.stringify(tournaments)); } catch(e) {}
}

async function deleteTournamentFromSupabase(id) {
  if (!isOfflineMode && db) {
    const { error } = await db.from('poker_tournaments').delete().eq('id', id);
    if (error) { showToast('âš  LÃ¶schen fehlgeschlagen'); return false; }
  }
  return true;
}

// â”€â”€ Tab render dispatcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTournamentTab() {
  if (activeTournament) { renderTournamentLive(); return; }
  renderTournamentHome();
}

// â”€â”€ HOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTournamentHome() {
  tournamentView = 'home';
  const el = document.getElementById('tournamentContent');

  // Sub-nav
  el.innerHTML = `
    <!-- Sub Navigation -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:18px">
      <button onclick="showCreateTournament()"
        style="padding:10px 6px;border-radius:8px;border:1px solid rgba(74,222,128,0.4);background:rgba(74,222,128,0.1);color:#4ade80;font-family:'Cinzel',serif;font-size:0.62rem;letter-spacing:0.06em;cursor:pointer">
        ðŸŽ° NEUES<br>TURNIER
      </button>
      <button onclick="renderTournamentRankings()"
        style="padding:10px 6px;border-radius:8px;border:1px solid rgba(201,168,76,0.4);background:rgba(201,168,76,0.1);color:var(--gold);font-family:'Cinzel',serif;font-size:0.62rem;letter-spacing:0.06em;cursor:pointer">
        ðŸ† TURNIER-<br>RANGLISTE
      </button>
      <button onclick="renderTournamentHistory()"
        style="padding:10px 6px;border-radius:8px;border:1px solid rgba(96,165,250,0.4);background:rgba(96,165,250,0.1);color:#60a5fa;font-family:'Cinzel',serif;font-size:0.62rem;letter-spacing:0.06em;cursor:pointer">
        ðŸ“‹ TURNIER-<br>HISTORIE
      </button>
    </div>

    <!-- Quick Stats -->
    ${renderTournamentQuickStats()}

    <!-- Recent -->
    <div class="font-display text-xs mb-3" style="color:var(--gold);letter-spacing:0.12em">ZULETZT GESPIELT</div>
    ${tournaments.length ? tournaments.slice(0,3).map(t => tournamentCardHtml(t)).join('') : '<div class="empty-state">Noch keine Turniere â™ </div>'}
  `;
}

function renderTournamentQuickStats() {
  if (!tournaments.length) return '';
  const totalTournaments = tournaments.length;
  const totalPrize = tournaments.reduce((s,t) => s + (t.payouts||[]).reduce((a,b)=>a+(b||0),0), 0);
  const allPlayers = [...new Set(tournaments.flatMap(t => (t.players||[]).map(p=>p.name)))];

  return `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:18px">
    <div style="text-align:center;padding:12px 6px;border-radius:10px;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.06)">
      <div style="font-family:'Cinzel',serif;font-size:1.4rem;color:var(--gold)">${totalTournaments}</div>
      <div style="font-size:0.6rem;color:var(--text-muted);margin-top:2px">TURNIERE</div>
    </div>
    <div style="text-align:center;padding:12px 6px;border-radius:10px;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.06)">
      <div style="font-family:'Cinzel',serif;font-size:1.4rem;color:#4ade80">${totalPrize.toFixed(0)}â‚¬</div>
      <div style="font-size:0.6rem;color:var(--text-muted);margin-top:2px">PREISGELDER</div>
    </div>
    <div style="text-align:center;padding:12px 6px;border-radius:10px;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.06)">
      <div style="font-family:'Cinzel',serif;font-size:1.4rem;color:#60a5fa">${allPlayers.length}</div>
      <div style="font-size:0.6rem;color:var(--text-muted);margin-top:2px">SPIELER</div>
    </div>
  </div>`;
}

function tournamentCardHtml(t) {
  const winner = (t.results||[])[0];
  const prize  = (t.payouts||[])[0];
  return `<div style="padding:12px;border-radius:10px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.06);margin-bottom:8px">
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div style="font-family:'Cinzel',serif;font-size:0.82rem;color:var(--gold-light)">${esc(t.name)}</div>
        <div style="font-size:0.72rem;color:var(--text-muted);margin-top:3px">${t.date} Â· ${(t.players||[]).length} Spieler Â· ${t.buyin}â‚¬ Buy-In</div>
        ${winner ? `<div style="font-size:0.72rem;color:#4ade80;margin-top:3px">ðŸ† ${esc(winner.name)}${prize ? ' Â· +'+prize+'â‚¬' : ''}</div>` : '<div style="font-size:0.72rem;color:var(--text-muted);margin-top:3px">Kein Ergebnis</div>'}
      </div>
      <button onclick="deleteTournament('${t.id}')" style="background:rgba(192,57,43,0.15);color:#e74c3c;border:1px solid rgba(192,57,43,0.3);border-radius:6px;padding:5px 8px;font-size:0.7rem;cursor:pointer;flex-shrink:0">ðŸ—‘ï¸</button>
    </div>
  </div>`;
}

// â”€â”€ RANGLISTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTournamentRankings() {
  tournamentView = 'rankings';
  const el = document.getElementById('tournamentContent');

  // Compute stats per player
  const stats = {};
  tournaments.forEach(t => {
    const playerCount = (t.players||[]).length;
    (t.results||[]).forEach((r, idx) => {
      if (!stats[r.name]) stats[r.name] = { wins:0, prize:0, tournaments:0, placements:[], percentiles:[], itm:0 };
      stats[r.name].tournaments++;
      const place = r.place || (idx+1);
      stats[r.name].placements.push(place);
      // Weighted percentile: 100% = win, 0% = last place
      // (playerCount - place) / (playerCount - 1)  â†’ clamped 0â€“100
      const pct = playerCount > 1 ? ((playerCount - place) / (playerCount - 1)) * 100 : (place === 1 ? 100 : 0);
      stats[r.name].percentiles.push(Math.max(0, pct));
      const payout = (t.payouts||[])[idx] || 0;
      stats[r.name].prize += payout;
      if (r.place === 1) stats[r.name].wins++;
      // ITM = top 3 or top 33%
      const itmCutoff = Math.max(3, Math.floor(playerCount * 0.33));
      if ((r.place||idx+1) <= itmCutoff) stats[r.name].itm++;
    });
    // Players who didn't cash still participated
    (t.players||[]).forEach(p => {
      if (!stats[p.name]) stats[p.name] = { wins:0, prize:0, tournaments:0, placements:[], percentiles:[], itm:0 };
      if (!stats[p.name].placements.length || stats[p.name].tournaments === 0) {
        stats[p.name].tournaments++;
      }
    });
  });

  const sorted = Object.entries(stats)
    .filter(([,v]) => v.tournaments > 0)
    .sort(([,a],[,b]) => {
      if (b.wins !== a.wins) return b.wins - a.wins;
      const aScore = a.percentiles.length ? a.percentiles.reduce((x,y)=>x+y,0)/a.percentiles.length : 0;
      const bScore = b.percentiles.length ? b.percentiles.reduce((x,y)=>x+y,0)/b.percentiles.length : 0;
      if (bScore !== aScore) return bScore - aScore;
      return b.prize - a.prize;
    });

  const medals = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];

  const rows = sorted.map(([name, v], i) => {
    const itmRate   = v.tournaments > 0 ? Math.round((v.itm/v.tournaments)*100) : 0;
    const medal    = i < 3 ? medals[i] : `<span style="color:var(--text-muted);font-family:'Cinzel',serif;font-size:0.8rem">${i+1}.</span>`;
    return `
      <div style="padding:12px;border-radius:10px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.06);margin-bottom:8px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
          <span style="font-size:1.1rem;flex-shrink:0">${medal}</span>
          <span style="font-family:'Cinzel',serif;font-size:0.82rem;color:var(--text-primary)">${esc(name)}</span>
          ${v.wins > 0 ? `<span style="margin-left:auto;font-family:'Cinzel',serif;font-size:0.72rem;color:#4ade80;background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.3);border-radius:20px;padding:2px 8px">${v.wins}Ã— Sieger</span>` : ''}
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;text-align:center">
          <div style="padding:6px;border-radius:6px;background:rgba(0,0,0,0.2)">
            <div style="font-family:'Cinzel',serif;font-size:0.9rem;color:var(--gold)">${v.wins}</div>
            <div style="font-size:0.55rem;color:var(--text-muted);margin-top:1px">SIEGE</div>
          </div>
          <div style="padding:6px;border-radius:6px;background:rgba(0,0,0,0.2)">
            <div style="font-family:'Cinzel',serif;font-size:0.9rem;color:#4ade80">${v.prize.toFixed(0)}â‚¬</div>
            <div style="font-size:0.55rem;color:var(--text-muted);margin-top:1px">PREISGELD</div>
          </div>
          <div style="padding:6px;border-radius:6px;background:rgba(0,0,0,0.2)">
            <div style="font-family:'Cinzel',serif;font-size:0.9rem;color:#f472b6">${itmRate}%</div>
            <div style="font-size:0.55rem;color:var(--text-muted);margin-top:1px">ITM</div>
          </div>
        </div>
      </div>`;
  }).join('');

  el.innerHTML = `
    <button onclick="renderTournamentHome()" class="back-btn" style="margin-bottom:16px">â—„ ZurÃ¼ck</button>
    <div class="font-display text-xs mb-4" style="color:var(--gold);letter-spacing:0.12em">ðŸ† TURNIER-RANGLISTE</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;padding:6px 8px;margin-bottom:6px;border-radius:6px;background:rgba(201,168,76,0.08);border:1px solid rgba(201,168,76,0.15)">
      <div style="font-family:'Cinzel',serif;font-size:0.55rem;color:var(--gold);letter-spacing:0.1em;text-align:center">SIEGE</div>
      <div style="font-family:'Cinzel',serif;font-size:0.55rem;color:var(--gold);letter-spacing:0.1em;text-align:center">PREISGELD</div>
      <div style="font-family:'Cinzel',serif;font-size:0.55rem;color:var(--gold);letter-spacing:0.1em;text-align:center">ITM</div>
    </div>
    ${rows || '<div class="empty-state">Noch keine Turnierergebnisse</div>'}`;
}

// â”€â”€ HISTORIE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTournamentHistory() {
  tournamentView = 'history';
  const el = document.getElementById('tournamentContent');

  const rows = tournaments.length
    ? tournaments.map(t => {
        const playerCount = (t.players||[]).length;
        const totalPrize  = (t.payouts||[]).reduce((a,b)=>a+(b||0),0);
        const placements  = (t.results||[]).slice(0,3);
        return `
          <div style="padding:14px;border-radius:10px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.06);margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
              <div>
                <div style="font-family:'Cinzel',serif;font-size:0.85rem;color:var(--gold-light)">${esc(t.name)}</div>
                <div style="font-size:0.72rem;color:var(--text-muted);margin-top:2px">${t.date} Â· ${playerCount} Spieler Â· ${t.buyin}â‚¬ Buy-In Â· Pot: ${(playerCount*t.buyin).toFixed(0)}â‚¬</div>
              </div>
              <button onclick="deleteTournament('${t.id}')" style="background:rgba(192,57,43,0.15);color:#e74c3c;border:1px solid rgba(192,57,43,0.3);border-radius:6px;padding:5px 8px;font-size:0.7rem;cursor:pointer;flex-shrink:0">ðŸ—‘ï¸</button>
            </div>
            ${placements.length ? `
              <div style="display:flex;flex-direction:column;gap:4px">
                ${placements.map((r,i) => {
                  const prize = (t.payouts||[])[i]||0;
                  const medal = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'][i];
                  return `<div style="display:flex;justify-content:space-between;padding:5px 8px;border-radius:6px;background:rgba(0,0,0,0.15)">
                    <span style="font-size:0.78rem">${medal} ${esc(r.name)}</span>
                    ${prize > 0 ? `<span style="font-family:'Cinzel',serif;font-size:0.75rem;color:#4ade80">+${prize}â‚¬</span>` : ''}
                  </div>`;
                }).join('')}
              </div>` : '<div style="font-size:0.72rem;color:var(--text-muted)">Kein Ergebnis eingetragen</div>'}
          </div>`;
      }).join('')
    : '<div class="empty-state">Noch keine Turniere â™ </div>';

  el.innerHTML = `
    <button onclick="renderTournamentHome()" class="back-btn" style="margin-bottom:16px">â—„ ZurÃ¼ck</button>
    <div class="font-display text-xs mb-4" style="color:var(--gold);letter-spacing:0.12em">ðŸ“‹ TURNIERHISTORIE (${tournaments.length})</div>
    ${rows}`;
}

// â”€â”€ ERSTELLEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showCreateTournament() {
  tournamentView = 'create';
  const players = [...new Set(sessions.map(s => s.player_name.trim()))].sort();
  const el = document.getElementById('tournamentContent');

  el.innerHTML = `
    <button onclick="renderTournamentHome()" class="back-btn" style="margin-bottom:16px">â—„ ZurÃ¼ck</button>
    <div class="font-display text-xs mb-3" style="color:var(--gold);letter-spacing:0.12em">ðŸŽ° TURNIER ERSTELLEN</div>

    <div style="display:grid;gap:10px;margin-bottom:16px">
      <div>
        <div class="label">Turniername</div>
        <input id="tName" type="text" placeholder="z.B. Friday Night Tournament" class="form-input" value="Poker Turnier">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <div class="label">Buy-In (â‚¬)</div>
          <input id="tBuyin" type="number" value="20" class="form-input">
        </div>
        <div>
          <div class="label">Startchips</div>
          <input id="tChips" type="number" value="5000" class="form-input">
        </div>
      </div>
    </div>

    <!-- BLIND STRUKTUR -->
    <div style="margin-bottom:12px">
      <div class="font-display text-xs mb-3" style="color:var(--gold);letter-spacing:0.12em;text-align:center">BLIND-STRUKTUR</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <button id="tPreset-turbo" onclick="applyBlindPreset('turbo')"
          style="padding:16px;border-radius:12px;border:1px solid rgba(248,113,113,0.4);background:rgba(248,113,113,0.08);color:#f87171;font-family:'Cinzel',serif;font-size:0.85rem;letter-spacing:0.1em;cursor:pointer;text-align:center;transition:all 0.2s">
          <div>âš¡ TURBO</div>
          <div style="font-size:0.62rem;color:rgba(248,113,113,0.6);margin-top:4px">12 Min Â· 10 Level Â· 4200 Chips</div>
        </button>
        <button id="tPreset-standard" onclick="applyBlindPreset('standard')"
          style="padding:16px;border-radius:12px;border:1px solid rgba(201,168,76,0.4);background:rgba(201,168,76,0.08);color:var(--gold);font-family:'Cinzel',serif;font-size:0.85rem;letter-spacing:0.1em;cursor:pointer;text-align:center;transition:all 0.2s">
          <div>â™  STANDARD</div>
          <div style="font-size:0.62rem;color:rgba(201,168,76,0.6);margin-top:4px">20 Min Â· 14 Level Â· 4800 Chips</div>
        </button>
        <button id="tPreset-deepstack" onclick="applyBlindPreset('deepstack')"
          style="padding:16px;border-radius:12px;border:1px solid rgba(96,165,250,0.4);background:rgba(96,165,250,0.08);color:#60a5fa;font-family:'Cinzel',serif;font-size:0.85rem;letter-spacing:0.1em;cursor:pointer;text-align:center;transition:all 0.2s">
          <div>ðŸ” DEEP STACK</div>
          <div style="font-size:0.62rem;color:rgba(96,165,250,0.6);margin-top:4px">30 Min Â· 12 Level Â· 5500 Chips</div>
        </button>
        <button id="tPreset-custom" onclick="applyBlindPreset('custom')"
          style="padding:16px;border-radius:12px;border:1px solid rgba(167,139,250,0.4);background:rgba(167,139,250,0.08);color:#a78bfa;font-family:'Cinzel',serif;font-size:0.85rem;letter-spacing:0.1em;cursor:pointer;text-align:center;transition:all 0.2s">
          <div>âœ CUSTOM</div>
          <div style="font-size:0.62rem;color:rgba(167,139,250,0.6);margin-top:4px">Eigene Struktur</div>
        </button>
      </div>

      <!-- Saved custom presets -->
      <div id="tSavedPresetsList" style="margin-top:10px"></div>
    </div>

    <!-- Header -->
    <div id="tBlindTableHeader" style="display:none;flex-direction:column;gap:6px;margin-bottom:8px">
      <!-- Global time setter -->
      <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;background:rgba(201,168,76,0.06);border:1px solid rgba(201,168,76,0.2)">
        <span style="font-family:'Cinzel',serif;font-size:0.72rem;color:var(--text-muted);white-space:nowrap">Alle Level:</span>
        <input id="tGlobalDuration" type="number" min="1" max="120" placeholder="Min"
          style="width:60px;background:rgba(0,0,0,0.3);border:1px solid rgba(201,168,76,0.3);border-radius:6px;color:var(--text-primary);font-family:'Crimson Text',serif;font-size:1rem;padding:5px 8px;text-align:center;outline:none">
        <span style="font-family:'Cinzel',serif;font-size:0.68rem;color:var(--text-muted)">Min</span>
        <button onclick="applyGlobalDuration()"
          style="flex:1;padding:7px 12px;border-radius:8px;border:1px solid rgba(201,168,76,0.4);background:rgba(201,168,76,0.12);color:var(--gold);font-family:'Cinzel',serif;font-size:0.68rem;cursor:pointer;white-space:nowrap">
          âœ“ FÃ¼r alle Ã¼bernehmen
        </button>
      </div>
      <!-- Column headers -->
      <div style="display:grid;grid-template-columns:32px 1fr 1fr 56px 32px;gap:4px;padding:5px 4px;border-radius:6px;background:rgba(201,168,76,0.08);border:1px solid rgba(201,168,76,0.12)">
        <div style="font-family:'Cinzel',serif;font-size:0.52rem;color:var(--gold);text-align:center">#</div>
        <div style="font-family:'Cinzel',serif;font-size:0.52rem;color:var(--gold);text-align:center">SB</div>
        <div style="font-family:'Cinzel',serif;font-size:0.52rem;color:var(--gold);text-align:center">BB</div>
        <div style="font-family:'Cinzel',serif;font-size:0.52rem;color:var(--gold);text-align:center">MIN</div>
        <div></div>
      </div>
    </div>
    <div id="tBlindList" style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px"></div>

    <div id="tBlindActions" style="display:none;flex-direction:column;gap:6px;margin-bottom:16px">
      <div style="display:flex;gap:6px">
        <button onclick="addBlindRow()"
          style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(201,168,76,0.35);background:rgba(201,168,76,0.08);color:var(--gold);font-family:'Cinzel',serif;font-size:0.65rem;cursor:pointer">
          + Level
        </button>
        <button onclick="addPauseRow()"
          style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(96,165,250,0.35);background:rgba(96,165,250,0.08);color:#60a5fa;font-family:'Cinzel',serif;font-size:0.65rem;cursor:pointer">
          â˜• Pause einfÃ¼gen
        </button>
      </div>
      <button id="tSavePresetBtn" onclick="saveCustomBlindPreset()" style="display:none;width:100%;padding:10px;border-radius:8px;border:1px solid rgba(167,139,250,0.4);background:rgba(167,139,250,0.08);color:#a78bfa;font-family:'Cinzel',serif;font-size:0.72rem;cursor:pointer;letter-spacing:0.08em">
        ðŸ’¾ Als eigenes Preset speichern
      </button>
    </div>

    <!-- AUSZAHLUNG -->
    <div class="font-display text-xs mb-2" style="color:var(--gold);letter-spacing:0.12em">AUSZAHLUNGSSTRUKTUR</div>
    <div id="tPayoutList" style="display:flex;flex-direction:column;gap:8px;margin-bottom:8px"></div>
    <div style="display:flex;gap:8px;margin-bottom:16px">
      <button onclick="addPayoutRow()"
        style="flex:1;padding:9px;border-radius:8px;border:1px solid rgba(201,168,76,0.35);background:rgba(201,168,76,0.08);color:var(--gold);font-family:'Cinzel',serif;font-size:0.7rem;cursor:pointer">
        + Platz hinzufÃ¼gen
      </button>
      <button onclick="autoFillPayouts()"
        style="flex:1;padding:9px;border-radius:8px;border:1px solid rgba(96,165,250,0.35);background:rgba(96,165,250,0.08);color:#60a5fa;font-family:'Cinzel',serif;font-size:0.7rem;cursor:pointer">
        âš¡ Auto-Berechnen
      </button>
    </div>

    <!-- SPIELER -->
    <div class="font-display text-xs mb-2" style="color:var(--gold);letter-spacing:0.12em">SPIELER AUSWÃ„HLEN</div>
    <div id="tPlayerList" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
      ${players.map(p => `
        <label style="display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:20px;border:1px solid rgba(255,255,255,0.1);background:rgba(0,0,0,0.2);cursor:pointer;font-size:0.78rem;user-select:none">
          <input type="checkbox" value="${esc(p)}" style="accent-color:var(--gold)"> ${esc(p)}
        </label>`).join('')}
    </div>
    <div style="display:flex;gap:8px;margin-bottom:16px">
      <input id="tNewPlayer" type="text" placeholder="Neuer Spielerâ€¦" class="form-input" style="flex:1"
        onkeydown="if(event.key==='Enter') addTournamentPlayer()">
      <button onclick="addTournamentPlayer()"
        style="padding:10px 14px;border-radius:8px;border:1px solid rgba(74,222,128,0.4);background:rgba(74,222,128,0.1);color:#4ade80;font-family:'Cinzel',serif;font-size:0.72rem;cursor:pointer;white-space:nowrap">
        + HinzufÃ¼gen
      </button>
    </div>

    <button onclick="startTournament()"
      style="width:100%;background:linear-gradient(135deg,rgba(74,222,128,0.2),rgba(74,222,128,0.08));color:#4ade80;border:1px solid rgba(74,222,128,0.4);border-radius:10px;padding:13px;font-family:'Cinzel',serif;font-size:0.82rem;letter-spacing:0.1em;cursor:pointer">
      â™  TURNIER STARTEN
    </button>`;

  setTimeout(() => {
    initPayoutRows();
    renderSavedCustomPresets();
  }, 0);
}

// â”€â”€ BLIND EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let blindRowCount = 0;

const BLIND_PRESETS = {
  turbo: [
    { sb:5,   bb:10,  duration:12 },
    { sb:10,  bb:25,  duration:12 },
    { sb:25,  bb:50,  duration:12 },
    { sb:50,  bb:100, duration:12 },
    { sb:75,  bb:150, duration:12 },
    { sb:100, bb:200, duration:12 },
    { sb:125, bb:250, duration:12 },
    { sb:150, bb:300, duration:12 },
    { sb:200, bb:400, duration:12 },
    { sb:250, bb:500, duration:12 },
  ],
  standard: [
    { sb:5,   bb:10,  duration:20 },
    { sb:10,  bb:25,  duration:20 },
    { sb:25,  bb:50,  duration:20 },
    { sb:35,  bb:75,  duration:20 },
    { sb:50,  bb:100, duration:20 },
    { sb:75,  bb:150, duration:20 },
    { sb:100, bb:200, duration:20 },
    { sb:125, bb:250, duration:20 },
    { sb:150, bb:300, duration:20 },
    { sb:175, bb:350, duration:20 },
    { sb:200, bb:400, duration:20 },
    { sb:225, bb:450, duration:20 },
    { sb:250, bb:500, duration:20 },
    { sb:300, bb:600, duration:20 },
  ],
  deepstack: [
    { sb:5,   bb:10,  duration:30 },
    { sb:10,  bb:25,  duration:30 },
    { sb:25,  bb:50,  duration:30 },
    { sb:35,  bb:75,  duration:30 },
    { sb:50,  bb:100, duration:30 },
    { sb:75,  bb:150, duration:30 },
    { sb:100, bb:200, duration:30 },
    { sb:150, bb:300, duration:30 },
    { sb:200, bb:400, duration:30 },
    { sb:250, bb:500, duration:30 },
    { sb:300, bb:600, duration:30 },
    { sb:350, bb:700, duration:30 },
  ],
};

function initBlindRows(preset = 'standard') {
  blindRowCount = 0;
  const list = document.getElementById('tBlindList');
  if (!list) return;
  list.innerHTML = '';
  BLIND_PRESETS[preset].forEach(b => addBlindRow(b));
}

function applyGlobalDuration() {
  const dur = parseInt(document.getElementById('tGlobalDuration')?.value);
  if (!dur || dur < 1) { showToast('âš  Bitte gÃ¼ltige Minutenanzahl eingeben'); return; }
  document.querySelectorAll('#tBlindList .blind-dur').forEach(inp => inp.value = dur);
  showToast(`âœ“ ${dur} Min fÃ¼r alle Level Ã¼bernommen`);
}

// â”€â”€ CUSTOM PRESETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadCustomBlindPresets() {
  try { return JSON.parse(localStorage.getItem('customBlindPresets') || '[]'); }
  catch { return []; }
}

function saveCustomBlindPresets(presets) {
  localStorage.setItem('customBlindPresets', JSON.stringify(presets));
}

function saveCustomBlindPreset() {
  const blinds = getBlindsFromForm();
  if (blinds.length === 0) { showToast('âš  Keine Levels zum Speichern'); return; }
  const name = prompt('Name fÃ¼r dieses Preset:');
  if (!name || !name.trim()) return;
  const presets = loadCustomBlindPresets();
  const levelCount = blinds.filter(b => !b.pause).length;
  const firstLevel = blinds.find(b => !b.pause);
  presets.push({ name: name.trim(), blinds, levelCount, sampleDur: firstLevel?.duration || 0 });
  saveCustomBlindPresets(presets);
  renderSavedCustomPresets();
  showToast(`âœ“ "${name.trim()}" gespeichert`);
}

function deleteCustomBlindPreset(idx) {
  const presets = loadCustomBlindPresets();
  presets.splice(idx, 1);
  saveCustomBlindPresets(presets);
  renderSavedCustomPresets();
  showToast('âœ“ Preset gelÃ¶scht');
}

function applyCustomBlindPreset(idx) {
  const presets = loadCustomBlindPresets();
  const p = presets[idx];
  if (!p) return;
  blindRowCount = 0;
  const list = document.getElementById('tBlindList');
  if (!list) return;
  list.innerHTML = '';
  p.blinds.forEach(b => addBlindRow(b));
  showBlindTable();
  // Deselect built-in presets, mark as custom active
  ['turbo','standard','deepstack','custom'].forEach(key => {
    const btn = document.getElementById(`tPreset-${key}`);
    if (!btn) return;
    const defaults = {
      turbo:     { bg:'rgba(248,113,113,0.08)', border:'rgba(248,113,113,0.4)' },
      standard:  { bg:'rgba(201,168,76,0.08)',  border:'rgba(201,168,76,0.4)'  },
      deepstack: { bg:'rgba(96,165,250,0.08)',   border:'rgba(96,165,250,0.4)'  },
      custom:    { bg:'rgba(167,139,250,0.08)',  border:'rgba(167,139,250,0.4)' },
    };
    btn.style.background  = defaults[key].bg;
    btn.style.borderColor = defaults[key].border;
    btn.style.boxShadow   = 'none';
  });
  showToast(`âœ“ "${p.name}" geladen`);
}

function renderSavedCustomPresets() {
  const container = document.getElementById('tSavedPresetsList');
  if (!container) return;
  const presets = loadCustomBlindPresets();
  if (presets.length === 0) { container.innerHTML = ''; return; }
  container.innerHTML = `
    <div style="font-family:'Cinzel',serif;font-size:0.62rem;color:var(--text-muted);letter-spacing:0.1em;margin-bottom:6px;margin-top:4px">GESPEICHERTE PRESETS</div>
    ${presets.map((p, i) => `
      <div style="display:flex;align-items:center;gap:8px;padding:12px 14px;border-radius:10px;border:1px solid rgba(167,139,250,0.25);background:rgba(167,139,250,0.06);margin-bottom:6px;cursor:pointer" onclick="applyCustomBlindPreset(${i})">
        <div style="flex:1">
          <div style="font-family:'Cinzel',serif;font-size:0.82rem;color:#a78bfa">${esc(p.name)}</div>
          <div style="font-size:0.65rem;color:var(--text-muted);margin-top:2px">${p.levelCount} Level${p.sampleDur ? ' Â· ' + p.sampleDur + ' Min' : ''}</div>
        </div>
        <button onclick="event.stopPropagation();deleteCustomBlindPreset(${i})"
          style="background:rgba(192,57,43,0.15);color:#e74c3c;border:1px solid rgba(192,57,43,0.3);border-radius:6px;padding:5px 8px;font-size:0.7rem;cursor:pointer">ðŸ—‘</button>
      </div>`).join('')}`;
}

function showBlindTable() {
  const header = document.getElementById('tBlindTableHeader');
  const actions = document.getElementById('tBlindActions');
  if (header) header.style.display = 'flex';
  if (actions) actions.style.display = 'flex';
}

function applyBlindPreset(preset) {
  const header = document.getElementById('tBlindTableHeader');
  const actions = document.getElementById('tBlindActions');
  const isOpen = header && header.style.display === 'flex';
  const currentPreset = header?.dataset.activePreset;

  // If same preset clicked while open â†’ collapse
  if (isOpen && currentPreset === preset) {
    header.style.display = 'none';
    if (actions) actions.style.display = 'none';
    header.dataset.activePreset = '';
    // Reset button highlight
    const defaults = {
      turbo:     { bg: 'rgba(248,113,113,0.08)', border: 'rgba(248,113,113,0.4)' },
      standard:  { bg: 'rgba(201,168,76,0.08)',  border: 'rgba(201,168,76,0.4)'  },
      deepstack: { bg: 'rgba(96,165,250,0.08)',  border: 'rgba(96,165,250,0.4)'  },
      custom:    { bg: 'rgba(167,139,250,0.08)', border: 'rgba(167,139,250,0.4)' },
    };
    const btn = document.getElementById(`tPreset-${preset}`);
    if (btn) { btn.style.background = defaults[preset].bg; btn.style.borderColor = defaults[preset].border; btn.style.boxShadow = 'none'; }
    return;
  }

  // Load levels
  if (preset === 'custom') {
    blindRowCount = 0;
    const list = document.getElementById('tBlindList');
    if (list) list.innerHTML = '';
    addBlindRow({ sb:25, bb:50, duration:15 });
    const durInput = document.getElementById('tGlobalDuration');
    if (durInput) durInput.value = '';
  } else {
    initBlindRows(preset);
    const defaultDurations = { turbo: 12, standard: 20, deepstack: 30 };
    const defaultChips     = { turbo: 4200, standard: 4800, deepstack: 5500 };
    const durInput = document.getElementById('tGlobalDuration');
    if (durInput) durInput.value = defaultDurations[preset] || 20;
    const chipsInput = document.getElementById('tChips');
    if (chipsInput) chipsInput.value = defaultChips[preset] || 5000;
  }

  showBlindTable();
  if (header) header.dataset.activePreset = preset;
  // Show save button only for custom
  const saveBtn = document.getElementById('tSavePresetBtn');
  if (saveBtn) saveBtn.style.display = preset === 'custom' ? 'block' : 'none';

  const names = { turbo:'âš¡ Turbo', standard:'â™  Standard', deepstack:'ðŸ” Deep Stack', custom:'âœ Custom' };
  const colors = {
    turbo:     { bg: 'rgba(248,113,113,0.25)', border: 'rgba(248,113,113,0.8)' },
    standard:  { bg: 'rgba(201,168,76,0.25)',  border: 'rgba(201,168,76,0.8)'  },
    deepstack: { bg: 'rgba(96,165,250,0.25)',  border: 'rgba(96,165,250,0.8)'  },
    custom:    { bg: 'rgba(167,139,250,0.25)', border: 'rgba(167,139,250,0.8)' },
  };
  const defaults = {
    turbo:     { bg: 'rgba(248,113,113,0.08)', border: 'rgba(248,113,113,0.4)' },
    standard:  { bg: 'rgba(201,168,76,0.08)',  border: 'rgba(201,168,76,0.4)'  },
    deepstack: { bg: 'rgba(96,165,250,0.08)',  border: 'rgba(96,165,250,0.4)'  },
    custom:    { bg: 'rgba(167,139,250,0.08)', border: 'rgba(167,139,250,0.4)' },
  };
  ['turbo','standard','deepstack','custom'].forEach(p => {
    const btn = document.getElementById(`tPreset-${p}`);
    if (!btn) return;
    const c = p === preset ? colors[p] : defaults[p];
    btn.style.background  = c.bg;
    btn.style.borderColor = c.border;
    btn.style.boxShadow   = p === preset ? `0 0 12px ${c.border}` : 'none';
  });
  if (preset !== 'custom') showToast(`âœ“ Preset geladen: ${names[preset]}`);
}

function addBlindRow(data = {}) {
  const list = document.getElementById('tBlindList');
  if (!list) return;
  blindRowCount++;
  const idx = blindRowCount;
  const row = document.createElement('div');
  row.id = `tBlindRow-${idx}`;
  row.dataset.type = data.pause ? 'pause' : 'level';
  if (data.pause) {
    row.style.cssText = 'display:grid;grid-template-columns:32px 1fr 56px 32px;gap:4px;align-items:center;padding:4px;border-radius:6px;background:rgba(96,165,250,0.08);border:1px solid rgba(96,165,250,0.2)';
    row.innerHTML = `
      <div style="text-align:center;font-size:0.9rem">â˜•</div>
      <div style="font-family:'Cinzel',serif;font-size:0.68rem;color:#60a5fa">PAUSE nach Level ${idx-1}</div>
      <input type="number" class="blind-pause-dur form-input" value="${data.duration||10}" min="1" style="padding:5px 6px;font-size:0.75rem;text-align:center" title="Dauer in Minuten">
      <button onclick="removeBlindRow(${idx})" style="background:rgba(192,57,43,0.15);color:#e74c3c;border:1px solid rgba(192,57,43,0.3);border-radius:5px;padding:4px 6px;font-size:0.7rem;cursor:pointer">âœ•</button>`;
  } else {
    row.style.cssText = 'display:grid;grid-template-columns:32px 1fr 1fr 56px 32px;gap:4px;align-items:center';
    row.innerHTML = `
      <div style="font-family:'Cinzel',serif;font-size:0.65rem;color:var(--text-muted);text-align:center">${idx}</div>
      <input type="number" class="blind-sb form-input" value="${data.sb||25}" min="1" style="padding:5px 6px;font-size:0.75rem;text-align:center">
      <input type="number" class="blind-bb form-input" value="${data.bb||50}" min="1" style="padding:5px 6px;font-size:0.75rem;text-align:center">
      <input type="number" class="blind-dur form-input" value="${data.duration||15}" min="1" style="padding:5px 6px;font-size:0.75rem;text-align:center">
      <button onclick="removeBlindRow(${idx})" style="background:rgba(192,57,43,0.15);color:#e74c3c;border:1px solid rgba(192,57,43,0.3);border-radius:5px;padding:4px 6px;font-size:0.7rem;cursor:pointer">âœ•</button>`;
  }
  list.appendChild(row);
}

function addPauseRow() {
  const list = document.getElementById('tBlindList');
  if (!list) return;

  // Count current non-pause rows to build options
  const rows = [...list.querySelectorAll('[id^="tBlindRow-"]')];
  const levelRows = rows.filter(r => r.dataset.type !== 'pause');
  if (levelRows.length === 0) { showToast('âš  Zuerst Levels eintragen'); return; }

  // Build a small inline selector
  const selector = document.createElement('div');
  selector.id = 'tPauseSelector';
  selector.style.cssText = 'display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;background:rgba(96,165,250,0.1);border:1px solid rgba(96,165,250,0.3);margin-bottom:4px';
  selector.innerHTML = `
    <span style="font-size:0.9rem">â˜•</span>
    <span style="font-family:'Cinzel',serif;font-size:0.68rem;color:#60a5fa;white-space:nowrap">Nach Level</span>
    <select id="tPauseAfterLevel" style="flex:1;background:rgba(0,0,0,0.3);border:1px solid rgba(96,165,250,0.3);border-radius:6px;color:var(--text-primary);font-family:'Crimson Text',serif;font-size:0.9rem;padding:4px 8px;outline:none">
      ${levelRows.map((r, i) => `<option value="${i+1}">${i+1}</option>`).join('')}
    </select>
    <span style="font-family:'Cinzel',serif;font-size:0.65rem;color:var(--text-muted);white-space:nowrap">Dauer</span>
    <input type="number" id="tPauseDuration" value="15" min="1" max="60"
      style="width:52px;background:rgba(0,0,0,0.3);border:1px solid rgba(96,165,250,0.3);border-radius:6px;color:var(--text-primary);font-family:'Crimson Text',serif;font-size:0.9rem;padding:4px 6px;text-align:center;outline:none">
    <span style="font-family:'Cinzel',serif;font-size:0.65rem;color:var(--text-muted)">Min</span>
    <button onclick="confirmPauseInsert()"
      style="padding:5px 10px;border-radius:6px;border:1px solid rgba(74,222,128,0.4);background:rgba(74,222,128,0.1);color:#4ade80;font-family:'Cinzel',serif;font-size:0.65rem;cursor:pointer;white-space:nowrap">âœ“ OK</button>
    <button onclick="document.getElementById('tPauseSelector').remove()"
      style="padding:5px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:var(--text-muted);font-size:0.7rem;cursor:pointer">âœ•</button>`;

  list.after(selector);
}

function confirmPauseInsert() {
  const afterLevel  = parseInt(document.getElementById('tPauseAfterLevel')?.value) || 1;
  const duration    = parseInt(document.getElementById('tPauseDuration')?.value) || 15;
  document.getElementById('tPauseSelector')?.remove();

  const list = document.getElementById('tBlindList');
  if (!list) return;

  // Find the afterLevel-th non-pause row and insert pause after it
  const rows = [...list.querySelectorAll('[id^="tBlindRow-"]')];
  let levelCount = 0;
  let insertAfter = null;
  for (const row of rows) {
    if (row.dataset.type !== 'pause') {
      levelCount++;
      if (levelCount === afterLevel) { insertAfter = row; break; }
    }
  }

  blindRowCount++;
  const idx = blindRowCount;
  const row = document.createElement('div');
  row.id = `tBlindRow-${idx}`;
  row.dataset.type = 'pause';
  row.style.cssText = 'display:grid;grid-template-columns:32px 1fr 56px 32px;gap:4px;align-items:center;padding:4px;border-radius:6px;background:rgba(96,165,250,0.08);border:1px solid rgba(96,165,250,0.2)';
  row.innerHTML = `
    <div style="text-align:center;font-size:0.9rem">â˜•</div>
    <div style="font-family:'Cinzel',serif;font-size:0.68rem;color:#60a5fa">PAUSE nach Level ${afterLevel}</div>
    <input type="number" class="blind-pause-dur form-input" value="${duration}" min="1" style="padding:5px 6px;font-size:0.75rem;text-align:center" title="Dauer in Minuten">
    <button onclick="removeBlindRow(${idx})" style="background:rgba(192,57,43,0.15);color:#e74c3c;border:1px solid rgba(192,57,43,0.3);border-radius:5px;padding:4px 6px;font-size:0.7rem;cursor:pointer">âœ•</button>`;

  if (insertAfter) {
    insertAfter.after(row);
  } else {
    list.appendChild(row);
  }
  showToast(`âœ“ Pause nach Level ${afterLevel} eingefÃ¼gt`);
}

function removeBlindRow(idx) {
  document.getElementById(`tBlindRow-${idx}`)?.remove();
}

function getBlindsFromForm() {
  const rows = document.querySelectorAll('[id^="tBlindRow-"]');
  const blinds = [];
  rows.forEach(row => {
    if (row.dataset.type === 'pause') {
      blinds.push({ pause: true, duration: parseInt(row.querySelector('.blind-pause-dur')?.value) || 10 });
    } else {
      blinds.push({
        sb:       parseInt(row.querySelector('.blind-sb')?.value)   || 25,
        bb:       parseInt(row.querySelector('.blind-bb')?.value)   || 50,
        ante:     parseInt(row.querySelector('.blind-ante')?.value) || 0,
        duration: parseInt(row.querySelector('.blind-dur')?.value)  || 15,
      });
    }
  });
  return blinds;
}

// â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PLACE_MEDALS = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰','4.','5.','6.','7.','8.'];
const PLACE_COLORS = ['#e8c97a','#C0C0C0','#CD7F32','#aaa','#aaa','#aaa','#aaa','#aaa'];
let payoutRowCount = 0;

function initPayoutRows() {
  payoutRowCount = 0;
  const list = document.getElementById('tPayoutList');
  if (!list) return;
  list.innerHTML = '';
  // Start with 3 rows
  addPayoutRow(); addPayoutRow(); addPayoutRow();
}

function addPayoutRow() {
  const list = document.getElementById('tPayoutList');
  if (!list) return;
  if (payoutRowCount >= 8) { showToast('âš  Maximal 8 PlÃ¤tze'); return; }
  payoutRowCount++;
  const idx   = payoutRowCount;
  const medal = PLACE_MEDALS[idx-1] || `${idx}.`;
  const color = PLACE_COLORS[idx-1] || '#aaa';
  const row   = document.createElement('div');
  row.id = `tPayRow-${idx}`;
  row.style.cssText = 'display:flex;align-items:center;gap:8px';
  row.innerHTML = `
    <span style="font-size:1rem;min-width:24px;text-align:center">${medal}</span>
    <span style="font-family:'Cinzel',serif;font-size:0.72rem;color:${color};min-width:60px">${idx}. Platz</span>
    <input id="tPay${idx}" type="number" value="0" min="0" class="form-input" style="flex:1"
      oninput="updatePayoutTotal()">
    <span style="font-family:'Cinzel',serif;font-size:0.8rem;color:var(--text-muted)">â‚¬</span>
    ${idx > 1 ? `<button onclick="removePayoutRow(${idx})"
      style="background:rgba(192,57,43,0.15);color:#e74c3c;border:1px solid rgba(192,57,43,0.3);border-radius:6px;padding:5px 8px;font-size:0.75rem;cursor:pointer;flex-shrink:0">âœ•</button>` : '<div style="width:30px"></div>'}`;
  list.appendChild(row);
  updatePayoutTotal();
}

function removePayoutRow(idx) {
  const row = document.getElementById(`tPayRow-${idx}`);
  if (row) row.remove();
  payoutRowCount = document.querySelectorAll('[id^="tPayRow-"]').length;
  updatePayoutTotal();
}

function updatePayoutTotal() {
  const total  = getPayoutsFromForm().reduce((s,v) => s+v, 0);
  const buyin  = parseFloat(document.getElementById('tBuyin')?.value) || 0;
  const players = [...document.querySelectorAll('#tPlayerList input[type=checkbox]:checked')].length;
  const pot    = buyin * players;
  let el = document.getElementById('tPayoutTotal');
  if (!el) {
    el = document.createElement('div');
    el.id = 'tPayoutTotal';
    el.style.cssText = 'font-size:0.72rem;text-align:right;margin-top:2px;margin-bottom:4px';
    document.getElementById('tPayoutList')?.after(el);
  }
  const diff = pot - total;
  const color = diff === 0 ? '#4ade80' : diff > 0 ? '#f472b6' : '#f87171';
  el.innerHTML = pot > 0
    ? `<span style="color:var(--text-muted)">Pot: <b style="color:var(--gold)">${pot.toFixed(0)}â‚¬</b> Â· Vergeben: <b style="color:${color}">${total.toFixed(0)}â‚¬</b>${diff !== 0 ? ` Â· Differenz: <b style="color:${color}">${diff > 0 ? '+' : ''}${diff.toFixed(0)}â‚¬</b>` : ' âœ“'}</span>`
    : `<span style="color:var(--text-muted)">Vergeben: <b style="color:${color}">${total.toFixed(0)}â‚¬</b></span>`;
}

function getPayoutsFromForm() {
  const payouts = [];
  document.querySelectorAll('[id^="tPay"]').forEach(inp => {
    if (inp.tagName === 'INPUT') payouts.push(parseFloat(inp.value) || 0);
  });
  return payouts;
}

function autoFillPayouts() {
  const buyin   = parseFloat(document.getElementById('tBuyin')?.value) || 20;
  const checked = [...document.querySelectorAll('#tPlayerList input[type=checkbox]:checked')];
  const n       = checked.length || 6;
  const pot     = buyin * n;
  const splits  = [[1.0],[0.65,0.35],[0.50,0.30,0.20],[0.45,0.27,0.18,0.10],[0.40,0.25,0.17,0.10,0.08]];
  const rows    = document.querySelectorAll('[id^="tPayRow-"]');
  const count   = rows.length;
  const split   = splits[Math.min(count,splits.length)-1] || splits[2];
  rows.forEach((row, i) => {
    const inp = row.querySelector('input[type=number]');
    if (inp) inp.value = i < split.length ? Math.round(pot * split[i]) : 0;
    // Show or update percentage badge
    let badge = row.querySelector('.pct-badge');
    if (!badge) {
      badge = document.createElement('span');
      badge.className = 'pct-badge';
      badge.style.cssText = 'font-family:"Cinzel",serif;font-size:0.65rem;color:var(--gold);background:rgba(201,168,76,0.12);border:1px solid rgba(201,168,76,0.25);border-radius:10px;padding:2px 6px;white-space:nowrap;flex-shrink:0';
      row.querySelector('input[type=number]').after(badge);
    }
    badge.textContent = i < split.length ? Math.round(split[i]*100) + '%' : '0%';
  });
  updatePayoutTotal();
  showToast('âš¡ BetrÃ¤ge automatisch berechnet');
}

function addTournamentPlayer() {
  const input = document.getElementById('tNewPlayer');
  const name  = input.value.trim();
  if (!name) { showToast('âš  Bitte Namen eingeben'); return; }

  const list = document.getElementById('tPlayerList');
  // Check if already exists
  const existing = [...list.querySelectorAll('input[type=checkbox]')].find(cb => cb.value.toLowerCase() === name.toLowerCase());
  if (existing) {
    existing.checked = true;
    existing.closest('label').style.borderColor = 'rgba(201,168,76,0.6)';
    showToast('âœ“ Spieler bereits vorhanden â€” ausgewÃ¤hlt');
    input.value = '';
    return;
  }

  const label = document.createElement('label');
  label.style.cssText = 'display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:20px;border:1px solid rgba(201,168,76,0.5);background:rgba(201,168,76,0.1);cursor:pointer;font-size:0.78rem;user-select:none';
  label.innerHTML = `<input type="checkbox" value="${esc(name)}" checked style="accent-color:var(--gold)"> ${esc(name)} <span style="font-size:0.6rem;color:var(--gold);margin-left:2px">NEU</span>`;
  list.appendChild(label);
  input.value = '';
  showToast(`âœ“ ${name} hinzugefÃ¼gt`);
}

function startTournament() {
  const name   = document.getElementById('tName').value.trim() || 'Turnier';
  const buyin  = parseFloat(document.getElementById('tBuyin').value) || 20;
  const chips  = parseInt(document.getElementById('tChips').value) || 5000;
  const payouts = getPayoutsFromForm();
  const blinds  = getBlindsFromForm();

  if (blinds.filter(b => !b.pause).length === 0) { showToast('âš  Mindestens 1 Level eintragen'); return; }

  const checked = [...document.querySelectorAll('#tPlayerList input[type=checkbox]:checked')];
  if (checked.length < 2) { showToast('âš  Mindestens 2 Spieler auswÃ¤hlen'); return; }

  const players = checked.map(c => ({ name: c.value, eliminated: false, place: null }));

  activeTournament = {
    id: Date.now().toString(),
    name, buyin, chips,
    date: new Date().toISOString().split('T')[0],
    players, blinds, payouts, results: [],
  };

  currentLevel     = 0;
  timerSecondsLeft = blinds[0].duration * 60;
  timerPaused      = false;
  isPauseLevel     = !!blinds[0].pause;
  startTimer();
  renderTournamentLive();
}

let isPauseLevel = false;

function startTimer() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    if (timerPaused) return;
    timerSecondsLeft--;
    updateTimerDisplay();
    if (timerSecondsLeft <= 0) {
      if (currentLevel < activeTournament.blinds.length - 1) {
        currentLevel++;
        const next = activeTournament.blinds[currentLevel];
        isPauseLevel = !!next.pause;
        timerSecondsLeft = next.duration * 60;
        if (isPauseLevel) {
          showToast('â˜• Pause! Timer lÃ¤uft.');
        } else {
          showToast('ðŸ”” NÃ¤chstes Level! Neue Blinds aktiv.');
        }
        renderTournamentLive();
      } else {
        timerSecondsLeft = 0;
        showToast('ðŸ Letzte Stufe erreicht!');
      }
    }
  }, 1000);
}

function updateTimerDisplay() {
  const el = document.getElementById('tournamentTimer');
  if (!el) return;
  const m = Math.floor(timerSecondsLeft / 60).toString().padStart(2,'0');
  const s = (timerSecondsLeft % 60).toString().padStart(2,'0');
  el.textContent = `${m}:${s}`;
  el.style.color = isPauseLevel ? '#60a5fa' : (timerSecondsLeft <= 60 ? '#f87171' : '#4ade80');
}

// â”€â”€ LIVE VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTournamentLive() {
  if (!activeTournament) return;
  const el = document.getElementById('tournamentContent');
  const t  = activeTournament;
  const blind     = t.blinds[currentLevel];
  const nextBlind = t.blinds[currentLevel + 1];
  const active    = t.players.filter(p => !p.eliminated);
  const eliminated = [...t.players.filter(p => p.eliminated)].sort((a,b)=>(a.place||99)-(b.place||99));
  isPauseLevel    = !!blind.pause;

  const m = Math.floor(timerSecondsLeft / 60).toString().padStart(2,'0');
  const s = (timerSecondsLeft % 60).toString().padStart(2,'0');
  const timerColor = isPauseLevel ? '#60a5fa' : (timerSecondsLeft <= 60 ? '#f87171' : '#4ade80');
  const timerBorder = isPauseLevel ? 'rgba(96,165,250,0.3)' : 'rgba(201,168,76,0.2)';

  // Find next non-pause blind for "next level" display
  let nextGameBlind = null;
  for (let i = currentLevel + 1; i < t.blinds.length; i++) {
    if (!t.blinds[i].pause) { nextGameBlind = t.blinds[i]; break; }
  }

  // Count real levels only (not pauses)
  const realLevelNum = t.blinds.slice(0, currentLevel + 1).filter(b => !b.pause).length;

  el.innerHTML = `
    <!-- Header info bar -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:8px 12px;border-radius:8px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.06)">
      <span style="font-family:'Cinzel',serif;font-size:0.7rem;color:var(--gold-light)">${esc(t.name)}</span>
      <span style="font-size:0.7rem;color:var(--text-muted)">${active.length} noch im Spiel</span>
    </div>

    <!-- Timer + Key Info Card -->
    <div style="border-radius:14px;background:rgba(0,0,0,0.35);border:1px solid ${timerBorder};margin-bottom:14px;overflow:hidden">

      ${isPauseLevel ? `
        <!-- PAUSE MODE -->
        <div style="text-align:center;padding:18px 16px 12px">
          <div style="font-family:'Cinzel',serif;font-size:0.6rem;color:#60a5fa;letter-spacing:0.18em;margin-bottom:6px">â˜• PAUSE</div>
          <div id="tournamentTimer" style="font-family:'Cinzel',serif;font-size:3.8rem;color:${timerColor};line-height:1;letter-spacing:0.05em">${m}:${s}</div>
          ${nextGameBlind ? `<div style="font-size:0.65rem;color:var(--text-muted);margin-top:10px">NÃ¤chste Blinds â†’ <span style="color:var(--gold)">${nextGameBlind.sb} / ${nextGameBlind.bb}</span></div>` : ''}
        </div>
      ` : `
        <!-- LEVEL MODE -->
        <!-- Timer -->
        <div style="text-align:center;padding:18px 16px 10px">
          <div style="font-family:'Cinzel',serif;font-size:0.55rem;color:var(--text-muted);letter-spacing:0.18em;margin-bottom:4px">LEVEL ${realLevelNum}</div>
          <div id="tournamentTimer" style="font-family:'Cinzel',serif;font-size:5rem;color:${timerColor};line-height:1;letter-spacing:0.05em">${m}:${s}</div>
        </div>

        <!-- Current blinds + pot -->
        <div style="display:grid;grid-template-columns:1fr 1px 1fr 1px 1fr;background:rgba(201,168,76,0.06);border-top:1px solid rgba(201,168,76,0.2)">
          <div style="text-align:center;padding:12px 6px">
            <div style="font-size:0.48rem;color:var(--text-muted);letter-spacing:0.12em;margin-bottom:3px">SMALL BLIND</div>
            <div style="font-family:'Cinzel',serif;font-size:2rem;color:var(--gold);line-height:1">${blind.sb}</div>
          </div>
          <div style="background:rgba(201,168,76,0.15)"></div>
          <div style="text-align:center;padding:12px 6px">
            <div style="font-size:0.48rem;color:var(--text-muted);letter-spacing:0.12em;margin-bottom:3px">BIG BLIND</div>
            <div style="font-family:'Cinzel',serif;font-size:2rem;color:var(--gold);line-height:1">${blind.bb}</div>
          </div>
          <div style="background:rgba(201,168,76,0.15)"></div>
          <div style="text-align:center;padding:12px 6px">
            <div style="font-size:0.48rem;color:var(--text-muted);letter-spacing:0.12em;margin-bottom:3px">POT</div>
            <div id="livePotTimer" style="font-family:'Cinzel',serif;font-size:2rem;color:#4ade80;line-height:1">${getTotalPot()}â‚¬</div>
          </div>
        </div>

        <!-- Next level â€” smaller, dimmed -->
        ${nextBlind ? `
        <div style="display:grid;grid-template-columns:1fr 1px 1fr 1px 1fr;background:rgba(255,255,255,0.02);border-top:1px solid rgba(255,255,255,0.05)">
          <div style="text-align:center;padding:7px 6px">
            <div style="font-size:0.42rem;color:rgba(255,255,255,0.25);letter-spacing:0.1em;margin-bottom:2px">${nextBlind.pause ? 'PAUSE' : 'NÃ„CHSTES SB'}</div>
            <div style="font-family:'Cinzel',serif;font-size:1.05rem;color:rgba(201,168,76,0.35);line-height:1">${nextBlind.pause ? 'â˜•' : nextBlind.sb}</div>
          </div>
          <div style="background:rgba(255,255,255,0.04)"></div>
          <div style="text-align:center;padding:7px 6px">
            <div style="font-size:0.42rem;color:rgba(255,255,255,0.25);letter-spacing:0.1em;margin-bottom:2px">${nextBlind.pause ? nextBlind.duration + ' MIN' : 'NÃ„CHSTES BB'}</div>
            <div style="font-family:'Cinzel',serif;font-size:1.05rem;color:rgba(201,168,76,0.35);line-height:1">${nextBlind.pause ? '' : nextBlind.bb}</div>
          </div>
          <div style="background:rgba(255,255,255,0.04)"></div>
          <div style="text-align:center;padding:7px 6px">
            <div style="font-size:0.42rem;color:rgba(255,255,255,0.25);letter-spacing:0.1em;margin-bottom:2px">LEVEL ${realLevelNum + 1}</div>
            <div style="font-family:'Cinzel',serif;font-size:1.05rem;color:rgba(201,168,76,0.35);line-height:1">${nextBlind.pause ? '' : nextBlind.duration + 'min'}</div>
          </div>
        </div>` : ''}
      `}

      <!-- Controls -->
      <div style="display:flex;gap:8px;justify-content:center;padding:10px 16px 14px">
        <button onclick="toggleTimer()" id="timerToggleBtn"
          style="padding:9px 22px;border-radius:8px;border:1px solid rgba(74,222,128,0.4);background:rgba(74,222,128,0.12);color:#4ade80;font-family:'Cinzel',serif;font-size:0.72rem;cursor:pointer">
          ${timerPaused ? 'â–¶ WEITER' : 'â¸ PAUSE'}
        </button>
        <button onclick="prevLevel()" ${currentLevel === 0 ? 'disabled style="opacity:0.3"' : ''}
          style="padding:9px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:var(--text-muted);font-family:'Cinzel',serif;font-size:0.8rem;cursor:pointer">â—„</button>
        <button onclick="nextLevel()" ${currentLevel >= t.blinds.length-1 ? 'disabled style="opacity:0.3"' : ''}
          style="padding:9px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:var(--text-muted);font-family:'Cinzel',serif;font-size:0.8rem;cursor:pointer">â–º</button>
      </div>
    </div>

    <!-- Active Players + Rebuys in one row -->
    <div style="margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="font-display text-xs" style="color:#4ade80;letter-spacing:0.12em">NOCH IM SPIEL (${active.length})</div>
        <div style="font-size:0.65rem;color:var(--text-muted)">Pot: <span id="livePot" style="color:var(--gold);font-family:'Cinzel',serif">${getTotalPot()}â‚¬</span></div>
      </div>
      <div id="rebuyCountsDisplay" style="display:grid;grid-template-columns:1fr 1fr;gap:5px">
        ${t.players.filter(p => !p.eliminated).map(p => {
          const r = p.rebuys || 0;
          const avatarUrl = avatarCache[p.name];
          const avatarEl = avatarUrl ? `<img src="${avatarUrl}" style="width:18px;height:18px;border-radius:50%;object-fit:cover;flex-shrink:0">` : '';
          return `<div style="display:flex;align-items:center;gap:5px;padding:6px 8px;border-radius:10px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.06)">
            ${avatarEl}
            <span style="flex:1;font-size:0.72rem;color:var(--text-primary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(p.name)}</span>
            ${r > 0 ? `<span style="font-family:'Cinzel',serif;font-size:0.65rem;color:#f472b6;background:rgba(244,114,182,0.12);border:1px solid rgba(244,114,182,0.3);border-radius:6px;padding:1px 5px;flex-shrink:0">${r}Ã—</span>
            <button onclick="addRebuy('${esc(p.name)}',-1)" style="width:18px;height:18px;border-radius:50%;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:var(--text-muted);font-size:0.7rem;cursor:pointer;line-height:1;flex-shrink:0">âˆ’</button>` : ''}
            <button onclick="addRebuy('${esc(p.name)}',1)" style="width:18px;height:18px;border-radius:50%;border:1px solid rgba(244,114,182,0.4);background:rgba(244,114,182,0.1);color:#f472b6;font-size:0.7rem;cursor:pointer;line-height:1;flex-shrink:0">+</button>
            <button onclick="eliminatePlayer('${esc(p.name)}')" style="padding:2px 6px;border-radius:5px;border:1px solid rgba(248,113,113,0.3);background:rgba(248,113,113,0.08);color:#f87171;font-size:0.62rem;cursor:pointer;flex-shrink:0">âœ•</button>
          </div>`;
        }).join('')}
      </div>
    </div>

    ${eliminated.length ? `
    <div class="font-display text-xs mb-2" style="color:#f87171;letter-spacing:0.12em">AUSGESCHIEDEN</div>
    <div style="display:flex;flex-direction:column;gap:4px;margin-bottom:14px">
      ${eliminated.map(p => {
        const medal = p.place === 1 ? 'ðŸ¥‡' : p.place === 2 ? 'ðŸ¥ˆ' : p.place === 3 ? 'ðŸ¥‰' : `${p.place}.`;
        const prize = p.place && (t.payouts||[])[p.place-1] > 0 ? ` Â· +${t.payouts[p.place-1]}â‚¬` : '';
        return `<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:8px;background:rgba(248,113,113,0.06);border:1px solid rgba(248,113,113,0.15)">
          <span style="font-size:0.85rem">${medal}</span>
          <span style="font-size:0.78rem;color:#f87171">${esc(p.name)}${prize}</span>
        </div>`;
      }).join('')}
    </div>` : ''}

    <!-- AUSZAHLUNG mit Live-Pot -->
    ${t.payouts.some(p=>p>0) ? `
    <div class="font-display text-xs mb-2" style="color:var(--gold);letter-spacing:0.12em">AUSZAHLUNG</div>
    <div id="livePayoutSummary" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px">
      <div style="text-align:center;padding:10px 8px;border-radius:10px;background:rgba(201,168,76,0.08);border:1px solid rgba(201,168,76,0.2)">
        <div style="font-size:0.55rem;color:var(--text-muted);letter-spacing:0.1em;margin-bottom:4px">GESAMTPOT</div>
        <div id="livePotBig" style="font-family:'Cinzel',serif;font-size:1.4rem;color:var(--gold);line-height:1">${getTotalPot()}â‚¬</div>
      </div>
      <div style="text-align:center;padding:10px 8px;border-radius:10px;background:rgba(74,222,128,0.06);border:1px solid rgba(74,222,128,0.15)">
        <div style="font-size:0.55rem;color:var(--text-muted);letter-spacing:0.1em;margin-bottom:4px">BUY-INS</div>
        <div style="font-family:'Cinzel',serif;font-size:1.4rem;color:#4ade80;line-height:1">${t.players.length}</div>
      </div>
      <div style="text-align:center;padding:10px 8px;border-radius:10px;background:rgba(244,114,182,0.06);border:1px solid rgba(244,114,182,0.15)">
        <div style="font-size:0.55rem;color:var(--text-muted);letter-spacing:0.1em;margin-bottom:4px">REBUYS</div>
        <div id="liveTotalRebuys" style="font-family:'Cinzel',serif;font-size:1.4rem;color:#f472b6;line-height:1">${t.players.reduce((s,p)=>s+(p.rebuys||0),0)}</div>
      </div>
    </div>
    <div id="livePayout" style="display:flex;gap:6px;margin-bottom:14px">
      ${(t.payouts||[]).map((amt, i) => amt > 0 ? `
        <div style="flex:1;text-align:center;padding:8px 4px;border-radius:8px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.06)">
          <div>${['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰','4.','5.'][i] || (i+1)+'.'}</div>
          <div style="font-family:'Cinzel',serif;font-size:0.9rem;color:var(--gold)">${amt}â‚¬</div>
        </div>` : '').join('')}
    </div>` : ''}

    <button onclick="endTournament()"
      style="width:100%;background:rgba(192,57,43,0.1);color:#e74c3c;border:1px solid rgba(192,57,43,0.35);border-radius:8px;padding:10px;font-family:'Cinzel',serif;font-size:0.72rem;letter-spacing:0.1em;cursor:pointer">
      âœ• TURNIER BEENDEN & SPEICHERN
    </button>`;
}

function getTotalPot() {
  if (!activeTournament) return 0;
  const t = activeTournament;
  const totalRebuys = t.players.reduce((s, p) => s + (p.rebuys || 0), 0);
  return (t.players.length + totalRebuys) * t.buyin;
}

function addRebuy(playerName, delta) {
  if (!activeTournament) return;
  const t = activeTournament;
  const player = t.players.find(p => p.name === playerName);
  if (!player) return;
  player.rebuys = Math.max(0, (player.rebuys || 0) + delta);

  const countsEl = document.getElementById('rebuyCountsDisplay');
  if (countsEl) {
    countsEl.innerHTML = t.players.filter(p => !p.eliminated).map(p => {
      const r = p.rebuys || 0;
      const avatarUrl = avatarCache[p.name];
      const avatarEl = avatarUrl ? `<img src="${avatarUrl}" style="width:18px;height:18px;border-radius:50%;object-fit:cover;flex-shrink:0">` : '';
      return `<div style="display:flex;align-items:center;gap:5px;padding:6px 8px;border-radius:10px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.06)">
        ${avatarEl}
        <span style="flex:1;font-size:0.72rem;color:var(--text-primary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(p.name)}</span>
        ${r > 0 ? `<span style="font-family:'Cinzel',serif;font-size:0.65rem;color:#f472b6;background:rgba(244,114,182,0.12);border:1px solid rgba(244,114,182,0.3);border-radius:6px;padding:1px 5px;flex-shrink:0">${r}Ã—</span>
        <button onclick="addRebuy('${esc(p.name)}',-1)" style="width:18px;height:18px;border-radius:50%;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:var(--text-muted);font-size:0.7rem;cursor:pointer;line-height:1;flex-shrink:0">âˆ’</button>` : ''}
        <button onclick="addRebuy('${esc(p.name)}',1)" style="width:18px;height:18px;border-radius:50%;border:1px solid rgba(244,114,182,0.4);background:rgba(244,114,182,0.1);color:#f472b6;font-size:0.7rem;cursor:pointer;line-height:1;flex-shrink:0">+</button>
        <button onclick="eliminatePlayer('${esc(p.name)}')" style="padding:2px 6px;border-radius:5px;border:1px solid rgba(248,113,113,0.3);background:rgba(248,113,113,0.08);color:#f87171;font-size:0.62rem;cursor:pointer;flex-shrink:0">âœ•</button>
      </div>`;
    }).join('');
  }

  const pot = getTotalPot();
  document.querySelectorAll('#livePot').forEach(el => el.textContent = pot + 'â‚¬');
  recalcPayoutsForPot(pot);
}

function recalcPayoutsForPot(pot) {
  if (!activeTournament || !activeTournament.payouts.some(p => p > 0)) return;
  const t = activeTournament;

  // Calculate original base pot (without rebuys) to get split ratios
  const basePot = t.players.length * t.buyin;
  const origPayouts = t.payouts;
  const origTotal   = origPayouts.reduce((s, v) => s + v, 0);
  if (origTotal === 0) return;

  // Apply same ratios to new pot
  t.payouts = origPayouts.map(p => p > 0 ? Math.round((p / origTotal) * pot) : 0);

  // Update payout display
  const payoutEl = document.getElementById('livePayout');
  if (payoutEl) {
    payoutEl.innerHTML = t.payouts.map((amt, i) => amt > 0 ? `
      <div style="flex:1;text-align:center;padding:8px 4px;border-radius:8px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.06)">
        <div>${['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰','4.','5.'][i] || (i+1)+'.'}</div>
        <div style="font-family:'Cinzel',serif;font-size:0.9rem;color:var(--gold)">${amt}â‚¬</div>
      </div>` : '').join('');
  }
  // Update pot/rebuy stat cards
  const totalRebuys = t.players.reduce((s,p) => s+(p.rebuys||0), 0);
  document.querySelectorAll('#livePotBig').forEach(el => el.textContent = pot + 'â‚¬');
  document.querySelectorAll('#liveTotalRebuys').forEach(el => el.textContent = totalRebuys);
  document.querySelectorAll('#livePot').forEach(el => el.textContent = pot + 'â‚¬');
  document.querySelectorAll('#livePotTimer').forEach(el => el.textContent = pot + 'â‚¬');
}

function toggleTimer() {
  timerPaused = !timerPaused;
  const btn = document.getElementById('timerToggleBtn');
  if (btn) btn.textContent = timerPaused ? 'â–¶ WEITER' : 'â¸ PAUSE';
}
function nextLevel() {
  if (!activeTournament || currentLevel >= activeTournament.blinds.length - 1) return;
  currentLevel++;
  timerSecondsLeft = activeTournament.blinds[currentLevel].duration * 60;
  renderTournamentLive();
}
function prevLevel() {
  if (!activeTournament || currentLevel <= 0) return;
  currentLevel--;
  timerSecondsLeft = activeTournament.blinds[currentLevel].duration * 60;
  renderTournamentLive();
}

function eliminatePlayer(name) {
  if (!activeTournament) return;
  const active = activeTournament.players.filter(p => !p.eliminated);
  const place  = active.length;
  const p = activeTournament.players.find(p => p.name === name);
  if (!p) return;
  p.eliminated = true;
  p.place = place;
  activeTournament.results.unshift({ name, place });
  showToast(`${name} ausgeschieden â€” Platz ${place}`);
  const remaining = activeTournament.players.filter(p => !p.eliminated);
  if (remaining.length === 1) {
    const winner = remaining[0];
    winner.place = 1;
    activeTournament.results.unshift({ name: winner.name, place: 1 });
    winner.eliminated = true;
    showToast(`ðŸ† ${winner.name} gewinnt das Turnier!`);
  }
  renderTournamentLive();
}

async function endTournament() {
  const confirmed = await showConfirmDialog(
    'Turnier beenden?',
    'Das Turnier wird gespeichert und der Timer gestoppt.',
    { label: 'âœ“ SPEICHERN', color: '#4ade80', border: 'rgba(74,222,128,0.5)', bg: 'rgba(74,222,128,0.15)' }
  );
  if (!confirmed) return;
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  const t = { ...activeTournament };
  tournaments.unshift(t);
  await saveTournamentToSupabase(t);
  activeTournament = null;
  currentLevel = 0;
  timerSecondsLeft = 0;
  renderTournamentHome();
  showToast('âœ“ Turnier gespeichert!');
}

async function deleteTournament(id) {
  const confirmed = await showConfirmDialog('Turnier lÃ¶schen?', 'Dieser Eintrag wird permanent entfernt.');
  if (!confirmed) return;
  const ok = await deleteTournamentFromSupabase(id);
  if (!ok) return;
  tournaments = tournaments.filter(t => t.id !== id);
  try { localStorage.setItem('poker_tournaments', JSON.stringify(tournaments)); } catch(e) {}
  if (tournamentView === 'history') renderTournamentHistory();
  else renderTournamentHome();
  showToast('âœ“ Turnier gelÃ¶scht');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REBUY FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let rebuyCounter = 0;

function addRebuyRow() {
  rebuyCounter++;
  const id = 'rebuy-' + rebuyCounter;
  const row = document.createElement('div');
  row.className = 'rebuy-row-item';
  row.id = id;
  row.innerHTML = `
    <input type="number" class="input-field rebuy-amount-input" placeholder="Rebuy-Betrag (â‚¬)"
      step="0.01" min="0" oninput="updateProfitPreview()" style="margin:0">
    <button type="button" onclick="removeRebuyRow('${id}')">âœ•</button>`;
  document.getElementById('rebuyRows').appendChild(row);
  updateProfitPreview();
}

function removeRebuyRow(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
  updateProfitPreview();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ CONFIRM DIALOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _confirmResolve = null;
function showConfirmDialog(title, text, okBtn = {}) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmText').textContent  = text;
  const btn   = document.getElementById('confirmOkBtn');
  const label = okBtn.label || 'ðŸ—‘ï¸ LÃ–SCHEN';
  const color = okBtn.color || '#e74c3c';
  const border= okBtn.border || 'rgba(192,57,43,0.5)';
  const bg    = okBtn.bg    || 'rgba(192,57,43,0.2)';
  btn.textContent = label;
  btn.style.color = color;
  btn.style.borderColor = border;
  btn.style.background  = bg;
  const el = document.getElementById('confirmDialog');
  el.style.display = 'flex';
  return new Promise(resolve => { _confirmResolve = resolve; });
}
function resolveConfirm(result) {
  document.getElementById('confirmDialog').style.display = 'none';
  if (_confirmResolve) { _confirmResolve(result); _confirmResolve = null; }
}

// â”€â”€ LIGHTBOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openLightbox(src) {
  const lb  = document.getElementById('lightbox');
  const img = document.getElementById('lightbox-img');
  img.src = src;
  lb.classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeLightbox() {
  document.getElementById('lightbox').classList.remove('open');
  document.body.style.overflow = '';
}
// Close with Escape key
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeLightbox(); });

// PHOTO FUNCTIONS (Supabase Storage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function handlePhotoUpload(event, date) {
  const file = event.target.files[0];
  if (!file) return;
  if (file.size > 10 * 1024 * 1024) {
    showToast('âš  Foto zu groÃŸ (max. 10 MB)'); return;
  }

  // Show loading state on button
  const label = event.target.closest('label');
  if (label) label.style.opacity = '0.5';
  showToast('ðŸ“· Foto wird hochgeladenâ€¦');

  if (!isOfflineMode && db) {
    try {
      // Upload to Supabase Storage bucket "poker-photos"
      const ext  = file.name.split('.').pop() || 'jpg';
      const path = `nights/${date}.${ext}`;

      const { error: upErr } = await db.storage
        .from('poker-photos')
        .upload(path, file, { upsert: true, contentType: file.type });

      if (upErr) throw upErr;

      // Get public URL
      const { data } = db.storage.from('poker-photos').getPublicUrl(path);
      const url = data.publicUrl;

      showPhotoForDate(date, url + '?t=' + Date.now()); // cache-bust
      showToast('ðŸ“· Foto gespeichert!');
    } catch(err) {
      console.error('Photo upload error:', err);
      showToast('âš  Upload fehlgeschlagen: ' + (err.message || err));
    }
  } else {
    // Offline fallback â€” localStorage as before
    const reader = new FileReader();
    reader.onload = (e) => {
      try { localStorage.setItem('poker_photo_' + date, e.target.result); } catch(e) {}
      showPhotoForDate(date, e.target.result);
      showToast('ðŸ“· Foto lokal gespeichert (Offline-Modus)');
    };
    reader.readAsDataURL(file);
  }

  if (label) label.style.opacity = '1';
}

function showPhotoForDate(date, url) {
  const display = document.getElementById('photo-display-' + date);
  const img     = document.getElementById('photo-img-' + date);
  if (display && img) {
    img.src = url;
    display.style.display = 'block';
  }
}

async function confirmRemovePhoto(date) {
  // Custom confirm dialog
  const confirmed = await showConfirmDialog(
    'ðŸ—‘ï¸ Foto lÃ¶schen?',
    'MÃ¶chtest du das Foto dieses Abends wirklich lÃ¶schen? Das kann nicht rÃ¼ckgÃ¤ngig gemacht werden.'
  );
  if (confirmed) removePhoto(date);
}

async function removePhoto(date) {
  if (!isOfflineMode && db) {
    // Try to delete all common extensions
    const exts = ['jpg','jpeg','png','webp','heic'];
    for (const ext of exts) {
      await db.storage.from('poker-photos').remove([`nights/${date}.${ext}`]).catch(()=>{});
    }
  } else {
    localStorage.removeItem('poker_photo_' + date);
  }
  const display = document.getElementById('photo-display-' + date);
  if (display) display.style.display = 'none';
  showToast('Foto entfernt');
}

async function loadPhotosForSessions() {
  if (!isOfflineMode && db) {
    // List all files in the nights/ folder
    const { data: files, error } = await db.storage.from('poker-photos').list('nights');
    if (error || !files) return;

    files.forEach(file => {
      // Filename format: 2025-03-15.jpg â†’ extract date
      const date = file.name.replace(/\.[^.]+$/, '');
      const { data } = db.storage.from('poker-photos').getPublicUrl('nights/' + file.name);
      if (data?.publicUrl) showPhotoForDate(date, data.publicUrl);
    });
  } else {
    // Offline: restore from localStorage
    const byDate = {};
    sessions.forEach(s => { byDate[s.date] = true; });
    Object.keys(byDate).forEach(date => {
      const stored = localStorage.getItem('poker_photo_' + date);
      if (stored) showPhotoForDate(date, stored);
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACHIEVEMENTS SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ACHIEVEMENTS = [
  // â”€â”€ Siege & Profit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'first_win',
    icon: 'ðŸ†',
    name: 'ERSTER SIEG',
    desc: 'Mindestens eine Session mit Gewinn abgeschlossen',
    holders: (stats) => Object.entries(stats).filter(([,p])=>p.wins>=1).map(([n])=>n),
  },
  {
    id: 'big_winner',
    icon: 'ðŸ’°',
    name: 'HIGH ROLLER',
    desc: 'Einzel-Gewinn Ã¼ber +100 â‚¬ in einer Session',
    holders: (stats, all) => [...new Set(all.filter(s=>(s.cash_out-s.buy_in)>=100).map(s=>s.player_name))],
  },
  {
    id: 'profit_king',
    icon: 'ðŸ‘‘',
    name: 'PROFIT KING',
    desc: 'Aktueller Gesamt-Profit Ã¼ber +250 â‚¬ (live)',
    live: true,  // not permanently stored â€” recalculated each time
    holders: (stats) => Object.entries(stats).filter(([,p])=>p.profit>=250).map(([n])=>n),
  },
  {
    id: 'profit_emperor',
    icon: 'ðŸ’Ž',
    name: 'PROFIT EMPEROR',
    desc: 'Aktueller Gesamt-Profit Ã¼ber +500 â‚¬ (live)',
    live: true,
    holders: (stats) => Object.entries(stats).filter(([,p])=>p.profit>=500).map(([n])=>n),
  },

  // â”€â”€ Verluste â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'bad_beat',
    icon: 'ðŸ’€',
    name: 'BAD BEAT',
    desc: 'Einzelverlust Ã¼ber -80 â‚¬ in einer Session',
    holders: (stats, all) => [...new Set(all.filter(s=>(s.cash_out-s.buy_in)<=-80).map(s=>s.player_name))],
  },
  {
    id: 'rebuy_king',
    icon: 'ðŸ”„',
    name: 'REBUY KING',
    desc: '5 eigene Sessions in Folge mit mindestens 1 Rebuy (Nicht-Teilnahme wird ignoriert)',
    holders: (stats, all) => {
      const byPlayer = {};
      all.forEach(s => { if (!byPlayer[s.player_name]) byPlayer[s.player_name] = []; byPlayer[s.player_name].push(s); });
      return Object.entries(byPlayer).filter(([, ss]) => {
        const sorted = [...ss].sort((a,b) => a.date.localeCompare(b.date));
        let streak = 0;
        for (const s of sorted) {
          if ((s.rebuy_count || 0) >= 1) { streak++; if (streak >= 5) return true; }
          else { streak = 0; }
        }
        return false;
      }).map(([n]) => n);
    },
  },

  // â”€â”€ Comeback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'comeback',
    icon: 'ðŸ”¥',
    name: 'COMEBACK KING',
    desc: 'GrÃ¶ÃŸter Verlierer einer Session â€” und in der nÃ¤chsten Session dabei der Gewinner',
    holders: (stats, all) => {
      // Group sessions by date, find the biggest loser per night
      const byDate = {};
      all.forEach(s => { if (!byDate[s.date]) byDate[s.date] = []; byDate[s.date].push(s); });
      const sortedNights = Object.keys(byDate).sort();

      // For each player, track their nights in order
      const byPlayer = {};
      all.forEach(s => { if (!byPlayer[s.player_name]) byPlayer[s.player_name] = {}; byPlayer[s.player_name][s.date] = s; });

      const result = new Set();
      for (let i = 0; i < sortedNights.length - 1; i++) {
        const night     = sortedNights[i];
        const nextNight = sortedNights[i + 1];
        const players   = byDate[night];

        // Find the biggest loser this night
        const biggestLoser = players.reduce((worst, s) => {
          const profit = s.cash_out - s.buy_in;
          if (profit >= 0) return worst;
          if (!worst || profit < (worst.cash_out - worst.buy_in)) return s;
          return worst;
        }, null);

        if (!biggestLoser) continue; // no one lost

        // Find the winner of the next night (highest profit among attendees)
        const nextPlayers = byDate[nextNight];
        const nextWinner  = nextPlayers.reduce((best, s) => {
          const profit = s.cash_out - s.buy_in;
          if (!best || profit > (best.cash_out - best.buy_in)) return s;
          return best;
        }, null);

        // Badge: if the biggest loser comes back next session and wins it
        if (nextWinner && nextWinner.player_name === biggestLoser.player_name &&
            (nextWinner.cash_out - nextWinner.buy_in) > 0) {
          result.add(biggestLoser.player_name);
        }
      }
      return [...result];
    },
  },

  // â”€â”€ Triple Session Winner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'hat_trick',
    icon: 'ðŸŽ©',
    name: 'HAT TRICK',
    desc: '3 aufeinanderfolgende Spielabende als Gewinner der jeweiligen Session abgeschlossen',
    holders: (stats, all) => {
      // Group by date, find winner of each night (highest profit, must be positive)
      const byDate = {};
      all.forEach(s => { if (!byDate[s.date]) byDate[s.date] = []; byDate[s.date].push(s); });
      const sortedNights = Object.keys(byDate).sort();

      // winner per night = player with highest profit (must be > 0)
      const nightWinners = sortedNights.map(date => {
        const players = byDate[date];
        const winner  = players.reduce((best, s) => {
          const profit = s.cash_out - s.buy_in;
          if (!best || profit > (best.cash_out - best.buy_in)) return s;
          return best;
        }, null);
        return winner && (winner.cash_out - winner.buy_in) > 0 ? winner.player_name : null;
      });

      // Find anyone who won 3 consecutive nights
      const result = new Set();
      for (let i = 0; i < nightWinners.length - 2; i++) {
        const w1 = nightWinners[i];
        const w2 = nightWinners[i + 1];
        const w3 = nightWinners[i + 2];
        if (w1 && w1 === w2 && w2 === w3) result.add(w1);
      }
      return [...result];
    },
  },

  // â”€â”€ Erfahrung (gestaffelt) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'veteran',
    icon: 'â™ ',
    name: 'VETERAN',
    desc: '10 oder mehr Sessions gespielt',
    holders: (stats) => Object.entries(stats).filter(([,p])=>p.sessions>=10).map(([n])=>n),
  },
  {
    id: 'legend',
    icon: 'ðŸƒ',
    name: 'LEGENDE',
    desc: '20 oder mehr Sessions gespielt',
    holders: (stats) => Object.entries(stats).filter(([,p])=>p.sessions>=20).map(([n])=>n),
  },

  // â”€â”€ Anwesenheit (gestaffelt) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'night_owl',
    icon: 'ðŸ¦‰',
    name: 'STAMMGAST',
    desc: '5 Spielabende in Folge dabei (Aussetzen bricht die Streak)',
    holders: (stats, all) => {
      const allNights = [...new Set(all.map(s => s.date))].sort();
      const byPlayer = {};
      all.forEach(s => {
        if (!byPlayer[s.player_name]) byPlayer[s.player_name] = new Set();
        byPlayer[s.player_name].add(s.date);
      });
      return Object.entries(byPlayer).filter(([, nights]) => {
        let streak = 0;
        for (const night of allNights) {
          if (nights.has(night)) { streak++; if (streak >= 5) return true; }
          else { streak = 0; }
        }
        return false;
      }).map(([n]) => n);
    },
  },
  {
    id: 'iron_man',
    icon: 'ðŸ”¥',
    name: 'IRON MAN',
    desc: '10 Spielabende in Folge dabei (Aussetzen bricht die Streak)',
    holders: (stats, all) => {
      const allNights = [...new Set(all.map(s => s.date))].sort();
      const byPlayer = {};
      all.forEach(s => {
        if (!byPlayer[s.player_name]) byPlayer[s.player_name] = new Set();
        byPlayer[s.player_name].add(s.date);
      });
      return Object.entries(byPlayer).filter(([, nights]) => {
        let streak = 0;
        for (const night of allNights) {
          if (nights.has(night)) { streak++; if (streak >= 10) return true; }
          else { streak = 0; }
        }
        return false;
      }).map(([n]) => n);
    },
  },

  // â”€â”€ Nit (passiv/tight Spieler) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'nit',
    icon: 'ðŸª¨',
    name: 'DER NIT',
    desc: '3 eigene Sessions in Folge nie mehr als 50% des Buy-Ins gewonnen oder verloren',
    holders: (stats, all) => {
      const byPlayer = {};
      all.forEach(s => { if (!byPlayer[s.player_name]) byPlayer[s.player_name] = []; byPlayer[s.player_name].push(s); });
      return Object.entries(byPlayer).filter(([,ss]) => {
        // Sort only THIS player's own sessions â€” missed nights are irrelevant
        const sorted = [...ss].sort((a,b)=>a.date.localeCompare(b.date));
        const isNit = s => s.buy_in > 0 && (Math.abs(s.cash_out - s.buy_in) / s.buy_in) <= 0.5;
        for (let i=0; i<sorted.length-2; i++) {
          if (isNit(sorted[i]) && isNit(sorted[i+1]) && isNit(sorted[i+2])) return true;
        }
        return false;
      }).map(([n])=>n);
    },
  },

  // â”€â”€ Consistency / Special â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'iron_wallet',
    icon: 'ðŸª¨',
    name: 'DER EISERNE',
    desc: '5 eigene Sessions in Folge ohne Rebuy (Nicht-Teilnahme wird ignoriert)',
    holders: (stats, all) => {
      const byPlayer = {};
      all.forEach(s => { if (!byPlayer[s.player_name]) byPlayer[s.player_name] = []; byPlayer[s.player_name].push(s); });
      return Object.entries(byPlayer).filter(([, ss]) => {
        const sorted = [...ss].sort((a,b) => a.date.localeCompare(b.date));
        let streak = 0;
        for (const s of sorted) {
          if (s.rebuy_count > 0) { streak = 0; } else { streak++; if (streak >= 5) return true; }
        }
        return false;
      }).map(([n]) => n);
    },
  },
  {
    id: 'unzerstoerbar',
    icon: 'ðŸ¦¾',
    name: 'DER UNZERSTÃ–RBARE',
    desc: '10 eigene Sessions in Folge ohne Rebuy (Nicht-Teilnahme wird ignoriert)',
    holders: (stats, all) => {
      const byPlayer = {};
      all.forEach(s => { if (!byPlayer[s.player_name]) byPlayer[s.player_name] = []; byPlayer[s.player_name].push(s); });
      return Object.entries(byPlayer).filter(([, ss]) => {
        const sorted = [...ss].sort((a,b) => a.date.localeCompare(b.date));
        let streak = 0;
        for (const s of sorted) {
          if (s.rebuy_count > 0) { streak = 0; } else { streak++; if (streak >= 10) return true; }
        }
        return false;
      }).map(([n]) => n);
    },
  },
  {
    id: 'daylight_robbery',
    icon: 'ðŸ’¸',
    name: 'DAYLIGHT ROBBERY',
    desc: 'Eine Session mit mindestens 3Ã— dem Buy-In als Gewinn beendet',
    holders: (stats, all) => {
      const found = new Set(all.filter(s => {
        const profit = s.cash_out - s.buy_in;
        return s.buy_in > 0 && profit >= s.buy_in * 3;
      }).map(s => s.player_name));
      return [...found];
    },
  },
  {
    id: 'punktlandung',
    icon: 'ðŸŽ¯',
    name: 'PUNKTLANDUNG',
    desc: 'Eine Session mit exakt 0,00 â‚¬ Profit beendet (Rebuys inklusive)',
    holders: (stats, all) => {
      // profit = cash_out - buy_in (buy_in already includes rebuys)
      const found = new Set(all.filter(s => {
        return s.buy_in > 0 && Math.abs(s.cash_out - s.buy_in) < 0.01;
      }).map(s => s.player_name));
      return [...found];
    },
  },

  // â”€â”€ Turnier â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'tourney_winner',
    icon: 'ðŸŽ°',
    name: 'TOURNAMENT WINNER',
    desc: 'Ein Turnier gewonnen',
    holders: (stats, all, tours) => {
      const winners = new Set();
      (tours||[]).forEach(t => {
        const w = (t.results||[]).find(r => r.place === 1);
        if (w) winners.add(w.name);
      });
      return [...winners];
    },
  },
  {
    id: 'tourney_itm5',
    icon: 'ðŸ’µ',
    name: 'IN THE MONEY',
    desc: '5Ã— in einem Turnier ins Geld gekommen (Top 3 oder Top 33%)',
    holders: (stats, all, tours) => {
      const counts = {};
      (tours||[]).forEach(t => {
        const playerCount = (t.players||[]).length;
        const itmCutoff   = Math.max(3, Math.floor(playerCount * 0.33));
        (t.results||[]).forEach(r => {
          if ((r.place||99) <= itmCutoff) {
            counts[r.name] = (counts[r.name] || 0) + 1;
          }
        });
      });
      return Object.entries(counts).filter(([,c]) => c >= 5).map(([n]) => n);
    },
  },
  {
    id: 'tourney_5wins',
    icon: 'ðŸ†',
    name: 'POKER CHAMPION',
    desc: '5 Turniere gewonnen',
    holders: (stats, all, tours) => {
      const counts = {};
      (tours||[]).forEach(t => {
        const w = (t.results||[]).find(r => r.place === 1);
        if (w) counts[w.name] = (counts[w.name] || 0) + 1;
      });
      return Object.entries(counts).filter(([,c]) => c >= 5).map(([n]) => n);
    },
  },

  // â”€â”€ Meta-Achievements (basierend auf Fortschritt) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'collector_80',
    icon: 'â­',
    name: 'BADGE COLLECTOR',
    desc: '50% aller Achievements freigeschaltet',
    meta: true,  // evaluated separately after all other badges are counted
    holders: () => [],  // filled dynamically in renderAchievements
  },
  {
    id: 'collector_100',
    icon: 'ðŸŒŸ',
    name: 'POKER GOD',
    desc: '100% aller Achievements freigeschaltet â€” absolute Legende',
    meta: true,
    holders: () => [],  // filled dynamically in renderAchievements
  },
];

function renderAchievements() {
  // Sync year
  const availYears = getAvailableYears();
  if (!availYears.includes(achievementsYear)) achievementsYear = getMostRecentYear();
  renderYearPills('achYearPills', achievementsYear, 'setAchievementsYear');

  const filteredSessions = getSessionsForYear(achievementsYear);

  if (!filteredSessions.length) {
    document.getElementById('achievementsContent').innerHTML =
      '<div class="empty-state">Noch keine Daten â€” spiel erst ein paar Runden! â™ </div>';
    return;
  }

  // Build player stats map (for selected year)
  const playerStats = {};
  filteredSessions.forEach(s => {
    const k = s.player_name.trim();
    if (!playerStats[k]) playerStats[k] = { sessions:0, profit:0, wins:0, losses:0, buyin:0 };
    playerStats[k].sessions++;
    playerStats[k].profit += (s.cash_out - s.buy_in);
    playerStats[k].buyin  += s.buy_in;
    if (s.cash_out > s.buy_in) playerStats[k].wins++;
    if (s.cash_out < s.buy_in) playerStats[k].losses++;
  });

  // Evaluate each achievement strictly from filteredSessions only â€” no cross-year persistence
  const evaluated = ACHIEVEMENTS.map(a => {
    if (a.meta) return { ...a, holders: [], unlocked: false };
    const holders = a.holders(playerStats, filteredSessions, tournaments);
    return { ...a, holders, unlocked: holders.length > 0 };
  });

  // â”€â”€ Count per-player badges (excluding meta-achievements) â”€â”€â”€â”€â”€
  const baseCount = ACHIEVEMENTS.filter(a => !a.meta).length;
  const playerBadgeCount = {};
  evaluated.forEach(a => {
    if (a.meta) return;
    a.holders.forEach(name => { playerBadgeCount[name] = (playerBadgeCount[name] || 0) + 1; });
  });

  // â”€â”€ Fill meta-achievement holders based on badge counts for this year â”€
  evaluated.forEach(a => {
    if (!a.meta) return;
    const threshold = a.id === 'collector_100' ? 100 : 50;
    const holders = Object.entries(playerBadgeCount)
      .filter(([,c]) => Math.round((c / baseCount) * 100) >= threshold)
      .map(([n]) => n);
    a.holders = holders;
    a.unlocked = holders.length > 0;
  });

  // â”€â”€ Update player filter dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const achPlayerSel = document.getElementById('achPlayerFilter');
  const selectedPlayer = achPlayerSel ? achPlayerSel.value : '';
  if (achPlayerSel) {
    const currentVal = achPlayerSel.value;
    const allPlayers = [...new Set(filteredSessions.map(s => s.player_name.trim()))].sort();
    achPlayerSel.innerHTML = '<option value="">â€” Alle Spieler â€”</option>' +
      allPlayers.map(p => `<option value="${esc(p)}" ${p === currentVal ? 'selected' : ''}>${esc(p)}</option>`).join('');
  }

  // â”€â”€ Tier definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const TIERS = [
    { level: 1, label: 'ðŸ¥‰ STUFE 1 â€” EINSTEIGER', cls: 'tier-label-1', ids: ['first_win','iron_wallet','veteran','nit','punktlandung'] },
    { level: 2, label: 'ðŸ¥ˆ STUFE 2 â€” FORTGESCHRITTEN', cls: 'tier-label-2', ids: ['comeback','night_owl','unzerstoerbar','bad_beat','daylight_robbery','tourney_winner'] },
    { level: 3, label: 'ðŸ¥‡ STUFE 3 â€” EXPERTE', cls: 'tier-label-3', ids: ['big_winner','profit_king','rebuy_king','collector_80','iron_man','legend','hat_trick','tourney_itm5'] },
    { level: 4, label: 'ðŸ’Ž STUFE 4 â€” LEGENDE', cls: 'tier-label-4', ids: ['collector_100','profit_emperor','tourney_5wins'] },
  ];

  function getTier(id) {
    for (const t of TIERS) { if (t.ids.includes(id)) return t.level; }
    return 3;
  }

  // â”€â”€ If player selected, filter achievements to show only theirs â”€
  let displayEvaluated = evaluated;
  if (selectedPlayer) {
    displayEvaluated = evaluated.map(a => ({
      ...a,
      unlocked: a.holders.includes(selectedPlayer),
      holders: a.holders.includes(selectedPlayer) ? [selectedPlayer] : [],
    }));
  }

  function badgeCardHtml(a, locked) {
    if (locked) return `<div class="badge-card locked">
      <div class="badge-lock">ðŸ”’</div>
      <div class="badge-icon">${a.icon}</div>
      <div class="badge-name">${a.name}</div>
      <div class="badge-desc">${a.desc}</div>
    </div>`;
    const holderLine = !selectedPlayer && a.holders.length
      ? `<div class="badge-holder">${a.holders.map(h=>`<span class="badge-holder-chip">${esc(h)}</span>`).join('')}</div>`
      : '';
    return `<div class="badge-card unlocked">
      <div class="badge-icon">${a.icon}</div>
      <div class="badge-name">${a.name}</div>
      <div class="badge-desc">${a.desc}</div>
      ${holderLine}
    </div>`;
  }

  const unlockedCount = displayEvaluated.filter(a=>a.unlocked).length;
  let html = selectedPlayer
    ? `<div style="margin-bottom:12px;padding:10px 14px;border-radius:8px;background:rgba(201,168,76,0.08);border:1px solid rgba(201,168,76,0.25);display:flex;align-items:center;justify-content:space-between">
        <span style="font-family:'Cinzel',serif;font-size:0.75rem;color:var(--gold-light)">ðŸ‘¤ ${esc(selectedPlayer)}</span>
        <span style="font-family:'Cinzel',serif;font-size:0.75rem;color:var(--gold)">${unlockedCount} / ${ACHIEVEMENTS.length} &nbsp;Â·&nbsp; ${Math.round((unlockedCount/ACHIEVEMENTS.length)*100)}%</span>
       </div>`
    : `<div style="margin-bottom:8px;font-size:0.72rem;color:var(--text-muted);text-align:center">
        âœ¦ ${unlockedCount} von ${ACHIEVEMENTS.length} freigeschaltet âœ¦</div>`;

  if (achSortMode === 'difficulty') {
    for (const tier of TIERS) {
      const tierAchs = displayEvaluated.filter(a => tier.ids.includes(a.id));
      if (!tierAchs.length) continue;
      html += `<div class="tier-${tier.level}" style="margin-bottom:16px">
        <div><span class="tier-label ${tier.cls}">${tier.label}</span></div>
        <div class="achievement-grid">
          ${tierAchs.map(a => badgeCardHtml(a, !a.unlocked)).join('')}
        </div>
      </div>`;
    }
  } else {
    const unlocked = displayEvaluated.filter(a => a.unlocked);
    const locked   = displayEvaluated.filter(a => !a.unlocked);
    if (unlocked.length) {
      html += `<div class="font-display text-xs mb-3" style="color:var(--gold);letter-spacing:0.12em">âœ¦ FREIGESCHALTET (${unlocked.length})</div>
      <div class="achievement-grid" style="margin-bottom:16px">
        ${unlocked.map(a => `<div class="tier-${getTier(a.id)}">${badgeCardHtml(a, false)}</div>`).join('')}
      </div>`;
    }
    if (locked.length) {
      html += `<div class="font-display text-xs mb-3" style="color:var(--text-muted);letter-spacing:0.12em">NOCH ZU FREISCHALTEN (${locked.length})</div>
      <div class="achievement-grid">
        ${locked.map(a => badgeCardHtml(a, true)).join('')}
      </div>`;
    }
  }

  // â”€â”€ Per-player progress â€” improved card layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const allPlayers = [...new Set(filteredSessions.map(s => s.player_name.trim()))].sort();
  const sortedPlayers = [...allPlayers].sort((a,b) => (playerBadgeCount[b]||0) - (playerBadgeCount[a]||0));

  const playerCards = sortedPlayers.map((name, idx) => {
    const count = playerBadgeCount[name] || 0;
    const pct   = Math.round((count / baseCount) * 100);
    const barColor = pct >= 100 ? '#e8c97a' : pct >= 80 ? '#c9a84c' : pct >= 50 ? '#60a5fa' : pct >= 25 ? '#4ade80' : 'rgba(255,255,255,0.2)';
    const medal = idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : idx === 2 ? 'ðŸ¥‰' : '';
    const tierLabel = pct >= 100 ? {t:'POKER GOD',c:'#e8c97a'} : pct >= 80 ? {t:'LEGENDE',c:'#c9a84c'} : pct >= 50 ? {t:'EXPERTE',c:'#60a5fa'} : pct >= 25 ? {t:'EINSTEIGER',c:'#4ade80'} : {t:'NEULING',c:'rgba(255,255,255,0.3)'};
    return `
      <div style="padding:12px;border-radius:10px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.06);margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="display:flex;align-items:center;gap:8px">
            <span style="font-size:1rem">${medal}</span>
            <span style="font-family:'Cinzel',serif;font-size:0.78rem;color:var(--text-primary)">${esc(name)}</span>
          </div>
          <span style="font-family:'Cinzel',serif;font-size:0.6rem;color:${tierLabel.c};background:${tierLabel.c}22;border:1px solid ${tierLabel.c}44;border-radius:20px;padding:2px 8px">${tierLabel.t}</span>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <div style="flex:1;height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden">
            <div style="height:100%;width:${pct}%;background:${barColor};border-radius:3px;transition:width 0.6s ease"></div>
          </div>
          <span style="font-family:'Cinzel',serif;font-size:0.68rem;color:var(--gold);white-space:nowrap">${count}/${baseCount} Â· ${pct}%</span>
        </div>
      </div>`;
  }).join('');

  html += `<div style="margin-top:14px;padding:14px;border-radius:8px;background:rgba(0,0,0,0.3);border:1px solid rgba(201,168,76,0.15)">
    <div class="font-display text-xs mb-4" style="color:var(--gold);letter-spacing:0.12em">ðŸ… FORTSCHRITT PRO SPIELER</div>
    ${playerCards || '<div style="color:var(--text-muted);font-size:0.75rem;text-align:center">Noch keine Daten</div>'}
    <div style="margin-top:10px;text-align:center;font-size:0.62rem;color:var(--text-muted);font-style:italic;border-top:1px solid rgba(255,255,255,0.06);padding-top:8px">
      Achievements werden pro Jahr neu berechnet â€” nur Sessions des gewÃ¤hlten Jahres zÃ¤hlen
    </div>
  </div>`;

  document.getElementById('achievementsContent').innerHTML = html;
}

// â”€â”€ THEME TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme() {
  const isLight = document.body.classList.toggle('light-mode');
  document.getElementById('themeToggle').textContent = isLight ? 'â˜€ï¸' : 'ðŸŒ™';
  try { localStorage.setItem('poker_theme', isLight ? 'light' : 'dark'); } catch(e) {}
}

function initTheme() {
  try {
    const saved = localStorage.getItem('poker_theme');
    if (saved === 'light') {
      document.body.classList.add('light-mode');
      const btn = document.getElementById('themeToggle');
      if (btn) btn.textContent = 'â˜€ï¸';
    }
  } catch(e) {}
}


// ---- HELPERS ----
function formatEuro(n) { return (+(n||0)).toFixed(2) + ' â‚¬'; }
function formatEuroSign(n) { return (n >= 0 ? '+' : '') + (+(n||0)).toFixed(2) + ' â‚¬'; }
function profitClass(n) { return n > 0 ? 'profit-pos' : n < 0 ? 'profit-neg' : 'profit-neu'; }
function formatDate(d) {
  if (!d) return '';
  const [y,m,day] = d.split('-');
  return `${day}.${m}.${y}`;
}
function esc(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function getDemoData() {
  return [
    {id:'1',date:'2025-01-05',player_name:'David',buy_in:20.0,cash_out:48.3,rebuys:0.0,rebuy_count:0},
    {id:'2',date:'2025-01-05',player_name:'Jacky',buy_in:20.0,cash_out:4.5,rebuys:0.0,rebuy_count:0},
    {id:'3',date:'2025-01-05',player_name:'Max',buy_in:20.0,cash_out:32.4,rebuys:0.0,rebuy_count:0},
    {id:'4',date:'2025-01-05',player_name:'Leo',buy_in:20.0,cash_out:12.4,rebuys:0.0,rebuy_count:0},
    {id:'5',date:'2025-01-05',player_name:'Paul',buy_in:20.0,cash_out:2.4,rebuys:0.0,rebuy_count:0},
    {id:'6',date:'2025-01-25',player_name:'David',buy_in:20.0,cash_out:24.7,rebuys:0.0,rebuy_count:0},
    {id:'7',date:'2025-01-25',player_name:'Jacky',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'8',date:'2025-01-25',player_name:'Max',buy_in:20.0,cash_out:38.8,rebuys:0.0,rebuy_count:0},
    {id:'9',date:'2025-01-25',player_name:'Eli',buy_in:20.0,cash_out:55.8,rebuys:0.0,rebuy_count:0},
    {id:'10',date:'2025-01-25',player_name:'Leo',buy_in:30.0,cash_out:15.6,rebuys:10.0,rebuy_count:0},
    {id:'11',date:'2025-01-25',player_name:'Paul',buy_in:30.0,cash_out:24.1,rebuys:10.0,rebuy_count:0},
    {id:'12',date:'2025-01-25',player_name:'Big',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'13',date:'2025-02-01',player_name:'David',buy_in:20.0,cash_out:30.4,rebuys:0.0,rebuy_count:0},
    {id:'14',date:'2025-02-01',player_name:'Jacky',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'15',date:'2025-02-01',player_name:'Eli',buy_in:20.0,cash_out:33.1,rebuys:0.0,rebuy_count:0},
    {id:'16',date:'2025-02-01',player_name:'Leo',buy_in:20.0,cash_out:25.6,rebuys:0.0,rebuy_count:0},
    {id:'17',date:'2025-02-01',player_name:'Matthias',buy_in:20.0,cash_out:10.9,rebuys:0.0,rebuy_count:0},
    {id:'18',date:'2025-02-07',player_name:'David',buy_in:20.0,cash_out:26.0,rebuys:0.0,rebuy_count:0},
    {id:'19',date:'2025-02-07',player_name:'Max',buy_in:20.0,cash_out:35.7,rebuys:0.0,rebuy_count:0},
    {id:'20',date:'2025-02-07',player_name:'Benji',buy_in:20.0,cash_out:33.8,rebuys:0.0,rebuy_count:0},
    {id:'21',date:'2025-02-07',player_name:'Hermann',buy_in:20.0,cash_out:22.5,rebuys:0.0,rebuy_count:0},
    {id:'22',date:'2025-02-07',player_name:'Fabi',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'23',date:'2025-02-23',player_name:'David',buy_in:20.0,cash_out:79.0,rebuys:0.0,rebuy_count:0},
    {id:'24',date:'2025-02-23',player_name:'Max',buy_in:20.0,cash_out:23.6,rebuys:0.0,rebuy_count:0},
    {id:'25',date:'2025-02-23',player_name:'Eli',buy_in:30.0,cash_out:15.3,rebuys:10.0,rebuy_count:0},
    {id:'26',date:'2025-02-23',player_name:'Leo',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'27',date:'2025-02-23',player_name:'Big',buy_in:20.0,cash_out:12.1,rebuys:0.0,rebuy_count:0},
    {id:'28',date:'2025-02-23',player_name:'Niki R.',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'29',date:'2025-03-01',player_name:'David',buy_in:35.0,cash_out:15.3,rebuys:15.0,rebuy_count:1},
    {id:'30',date:'2025-03-01',player_name:'Jacky',buy_in:20.0,cash_out:23.2,rebuys:0.0,rebuy_count:0},
    {id:'31',date:'2025-03-01',player_name:'Paul',buy_in:40.0,cash_out:18.5,rebuys:20.0,rebuy_count:1},
    {id:'32',date:'2025-03-01',player_name:'Benji',buy_in:20.0,cash_out:88.1,rebuys:0.0,rebuy_count:0},
    {id:'33',date:'2025-03-01',player_name:'Hermann',buy_in:30.0,cash_out:0.0,rebuys:10.0,rebuy_count:0},
    {id:'34',date:'2025-03-15',player_name:'David',buy_in:20.0,cash_out:48.0,rebuys:0.0,rebuy_count:0},
    {id:'35',date:'2025-03-15',player_name:'Jacky',buy_in:20.0,cash_out:5.0,rebuys:0.0,rebuy_count:0},
    {id:'36',date:'2025-03-15',player_name:'Benji',buy_in:45.0,cash_out:38.8,rebuys:25.0,rebuy_count:1},
    {id:'37',date:'2025-03-16',player_name:'David',buy_in:20.0,cash_out:26.3,rebuys:0.0,rebuy_count:0},
    {id:'38',date:'2025-03-16',player_name:'Max',buy_in:20.0,cash_out:41.4,rebuys:0.0,rebuy_count:0},
    {id:'39',date:'2025-03-16',player_name:'Eli',buy_in:20.0,cash_out:11.0,rebuys:0.0,rebuy_count:0},
    {id:'40',date:'2025-03-16',player_name:'Leo',buy_in:20.0,cash_out:22.3,rebuys:0.0,rebuy_count:0},
    {id:'41',date:'2025-03-16',player_name:'Paul',buy_in:30.0,cash_out:29.8,rebuys:10.0,rebuy_count:0},
    {id:'42',date:'2025-03-16',player_name:'Big',buy_in:20.0,cash_out:21.9,rebuys:0.0,rebuy_count:0},
    {id:'43',date:'2025-03-16',player_name:'Simon',buy_in:20.0,cash_out:13.2,rebuys:0.0,rebuy_count:0},
    {id:'44',date:'2025-03-23',player_name:'David',buy_in:20.0,cash_out:22.0,rebuys:0.0,rebuy_count:0},
    {id:'45',date:'2025-03-23',player_name:'Max',buy_in:30.0,cash_out:14.6,rebuys:10.0,rebuy_count:0},
    {id:'46',date:'2025-03-23',player_name:'Eli',buy_in:20.0,cash_out:22.7,rebuys:0.0,rebuy_count:0},
    {id:'47',date:'2025-03-23',player_name:'Leo',buy_in:20.0,cash_out:40.2,rebuys:0.0,rebuy_count:0},
    {id:'48',date:'2025-04-18',player_name:'David',buy_in:20.0,cash_out:34.1,rebuys:0.0,rebuy_count:0},
    {id:'49',date:'2025-04-18',player_name:'Jacky',buy_in:20.0,cash_out:13.4,rebuys:0.0,rebuy_count:0},
    {id:'50',date:'2025-04-18',player_name:'Max',buy_in:20.0,cash_out:29.3,rebuys:0.0,rebuy_count:0},
    {id:'51',date:'2025-04-18',player_name:'Eli',buy_in:20.0,cash_out:12.2,rebuys:0.0,rebuy_count:0},
    {id:'52',date:'2025-05-16',player_name:'David',buy_in:40.0,cash_out:53.5,rebuys:20.0,rebuy_count:1},
    {id:'53',date:'2025-05-16',player_name:'Paul',buy_in:20.0,cash_out:26.1,rebuys:0.0,rebuy_count:0},
    {id:'54',date:'2025-05-16',player_name:'Matthias',buy_in:20.0,cash_out:35.0,rebuys:0.0,rebuy_count:0},
    {id:'55',date:'2025-05-16',player_name:'Daniel',buy_in:20.0,cash_out:31.0,rebuys:0.0,rebuy_count:0},
    {id:'56',date:'2025-05-16',player_name:'Benji',buy_in:40.0,cash_out:23.2,rebuys:20.0,rebuy_count:1},
    {id:'57',date:'2025-05-16',player_name:'Hermann',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'58',date:'2025-05-16',player_name:'Lino',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'59',date:'2025-05-18',player_name:'David',buy_in:20.0,cash_out:15.2,rebuys:0.0,rebuy_count:0},
    {id:'60',date:'2025-05-18',player_name:'Max',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'61',date:'2025-05-18',player_name:'Leo',buy_in:20.0,cash_out:18.3,rebuys:0.0,rebuy_count:0},
    {id:'62',date:'2025-05-18',player_name:'Big',buy_in:20.0,cash_out:30.0,rebuys:0.0,rebuy_count:0},
    {id:'63',date:'2025-05-18',player_name:'Simon',buy_in:20.0,cash_out:36.4,rebuys:0.0,rebuy_count:0},
    {id:'64',date:'2025-05-26',player_name:'David',buy_in:20.0,cash_out:61.4,rebuys:0.0,rebuy_count:0},
    {id:'65',date:'2025-05-26',player_name:'Max',buy_in:30.0,cash_out:9.0,rebuys:10.0,rebuy_count:0},
    {id:'66',date:'2025-05-26',player_name:'Eli',buy_in:30.0,cash_out:0.0,rebuys:10.0,rebuy_count:0},
    {id:'67',date:'2025-05-26',player_name:'Leo',buy_in:20.0,cash_out:38.1,rebuys:0.0,rebuy_count:0},
    {id:'68',date:'2025-05-26',player_name:'Big',buy_in:20.0,cash_out:33.5,rebuys:0.0,rebuy_count:0},
    {id:'69',date:'2025-05-30',player_name:'David',buy_in:20.0,cash_out:27.2,rebuys:0.0,rebuy_count:0},
    {id:'70',date:'2025-05-30',player_name:'Max',buy_in:20.0,cash_out:41.0,rebuys:0.0,rebuy_count:0},
    {id:'71',date:'2025-05-30',player_name:'Eli',buy_in:20.0,cash_out:49.9,rebuys:0.0,rebuy_count:0},
    {id:'72',date:'2025-05-30',player_name:'Leo',buy_in:30.0,cash_out:31.6,rebuys:10.0,rebuy_count:0},
    {id:'73',date:'2025-06-01',player_name:'David',buy_in:20.0,cash_out:37.2,rebuys:0.0,rebuy_count:0},
    {id:'74',date:'2025-06-01',player_name:'Max',buy_in:40.0,cash_out:35.1,rebuys:20.0,rebuy_count:1},
    {id:'75',date:'2025-06-01',player_name:'Leo',buy_in:20.0,cash_out:20.0,rebuys:0.0,rebuy_count:0},
    {id:'76',date:'2025-06-14',player_name:'Max',buy_in:15.0,cash_out:35.6,rebuys:0.0,rebuy_count:0},
    {id:'77',date:'2025-06-14',player_name:'Leo',buy_in:15.0,cash_out:8.0,rebuys:0.0,rebuy_count:0},
    {id:'78',date:'2025-06-14',player_name:'Big',buy_in:15.0,cash_out:20.0,rebuys:0.0,rebuy_count:0},
    {id:'79',date:'2025-06-27',player_name:'David',buy_in:20.0,cash_out:36.6,rebuys:0.0,rebuy_count:0},
    {id:'80',date:'2025-06-27',player_name:'Paul',buy_in:20.0,cash_out:48.6,rebuys:0.0,rebuy_count:0},
    {id:'81',date:'2025-06-27',player_name:'Benji',buy_in:40.0,cash_out:12.2,rebuys:20.0,rebuy_count:1},
    {id:'82',date:'2025-06-27',player_name:'Lino',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'83',date:'2025-06-30',player_name:'David',buy_in:20.0,cash_out:21.3,rebuys:0.0,rebuy_count:0},
    {id:'84',date:'2025-06-30',player_name:'Max',buy_in:20.0,cash_out:32.4,rebuys:0.0,rebuy_count:0},
    {id:'85',date:'2025-06-30',player_name:'Leo',buy_in:20.0,cash_out:26.9,rebuys:0.0,rebuy_count:0},
    {id:'86',date:'2025-06-30',player_name:'Benji',buy_in:20.0,cash_out:8.9,rebuys:0.0,rebuy_count:0},
    {id:'87',date:'2025-06-30',player_name:'Hermann',buy_in:25.0,cash_out:0.0,rebuys:5.0,rebuy_count:0},
    {id:'88',date:'2025-06-30',player_name:'Niki R.',buy_in:20.0,cash_out:35.9,rebuys:0.0,rebuy_count:0},
    {id:'89',date:'2025-07-02',player_name:'David',buy_in:40.0,cash_out:0.0,rebuys:20.0,rebuy_count:1},
    {id:'90',date:'2025-07-02',player_name:'Max',buy_in:40.0,cash_out:0.0,rebuys:20.0,rebuy_count:1},
    {id:'91',date:'2025-07-02',player_name:'Leo',buy_in:20.0,cash_out:18.3,rebuys:0.0,rebuy_count:0},
    {id:'92',date:'2025-07-02',player_name:'Big',buy_in:20.0,cash_out:75.2,rebuys:0.0,rebuy_count:0},
    {id:'93',date:'2025-07-02',player_name:'Fabi',buy_in:20.0,cash_out:38.2,rebuys:0.0,rebuy_count:0},
    {id:'94',date:'2025-07-02',player_name:'Simon',buy_in:20.0,cash_out:26.3,rebuys:0.0,rebuy_count:0},
    {id:'95',date:'2025-07-04',player_name:'David',buy_in:20.0,cash_out:61.0,rebuys:0.0,rebuy_count:0},
    {id:'96',date:'2025-07-04',player_name:'Jacky',buy_in:20.0,cash_out:26.7,rebuys:0.0,rebuy_count:0},
    {id:'97',date:'2025-07-04',player_name:'Paul',buy_in:20.0,cash_out:23.2,rebuys:0.0,rebuy_count:0},
    {id:'98',date:'2025-07-04',player_name:'Matthias',buy_in:20.0,cash_out:5.4,rebuys:0.0,rebuy_count:0},
    {id:'99',date:'2025-07-04',player_name:'Benji',buy_in:20.0,cash_out:33.6,rebuys:0.0,rebuy_count:0},
    {id:'100',date:'2025-07-04',player_name:'Hermann',buy_in:30.0,cash_out:0.0,rebuys:10.0,rebuy_count:0},
    {id:'101',date:'2025-07-04',player_name:'Lino',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'102',date:'2025-07-08',player_name:'David',buy_in:20.0,cash_out:29.9,rebuys:0.0,rebuy_count:0},
    {id:'103',date:'2025-07-08',player_name:'Max',buy_in:20.0,cash_out:4.6,rebuys:0.0,rebuy_count:0},
    {id:'104',date:'2025-07-08',player_name:'Leo',buy_in:20.0,cash_out:23.8,rebuys:0.0,rebuy_count:0},
    {id:'105',date:'2025-07-08',player_name:'Paul',buy_in:20.0,cash_out:19.3,rebuys:0.0,rebuy_count:0},
    {id:'106',date:'2025-07-08',player_name:'Big',buy_in:20.0,cash_out:56.6,rebuys:0.0,rebuy_count:0},
    {id:'107',date:'2025-07-08',player_name:'Fabi',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'108',date:'2025-07-08',player_name:'Simon',buy_in:25.0,cash_out:0.0,rebuys:5.0,rebuy_count:0},
    {id:'109',date:'2025-07-18',player_name:'David',buy_in:20.0,cash_out:11.5,rebuys:0.0,rebuy_count:0},
    {id:'110',date:'2025-07-18',player_name:'Max',buy_in:20.0,cash_out:48.5,rebuys:0.0,rebuy_count:0},
    {id:'111',date:'2025-07-18',player_name:'Matthias',buy_in:20.0,cash_out:10.9,rebuys:0.0,rebuy_count:0},
    {id:'112',date:'2025-07-18',player_name:'Benji',buy_in:20.0,cash_out:15.3,rebuys:0.0,rebuy_count:0},
    {id:'113',date:'2025-07-18',player_name:'Flo',buy_in:20.0,cash_out:12.7,rebuys:0.0,rebuy_count:0},
    {id:'114',date:'2025-07-27',player_name:'David',buy_in:40.0,cash_out:33.0,rebuys:20.0,rebuy_count:1},
    {id:'115',date:'2025-07-27',player_name:'Max',buy_in:32.0,cash_out:56.1,rebuys:12.0,rebuy_count:1},
    {id:'116',date:'2025-07-27',player_name:'Leo',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'117',date:'2025-07-27',player_name:'Big',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'118',date:'2025-07-27',player_name:'Benji',buy_in:20.0,cash_out:38.3,rebuys:0.0,rebuy_count:0},
    {id:'119',date:'2025-07-27',player_name:'Simon',buy_in:30.0,cash_out:34.1,rebuys:10.0,rebuy_count:0},
    {id:'120',date:'2025-08-31',player_name:'David',buy_in:20.0,cash_out:34.8,rebuys:0.0,rebuy_count:0},
    {id:'121',date:'2025-08-31',player_name:'Jacky',buy_in:20.0,cash_out:14.8,rebuys:0.0,rebuy_count:0},
    {id:'122',date:'2025-08-31',player_name:'Eli',buy_in:20.0,cash_out:31.0,rebuys:0.0,rebuy_count:0},
    {id:'123',date:'2025-07-31',player_name:'Matthias',buy_in:20.0,cash_out:24.8,rebuys:0.0,rebuy_count:0},
    {id:'124',date:'2025-07-31',player_name:'Benji',buy_in:20.0,cash_out:15.1,rebuys:0.0,rebuy_count:0},
    {id:'125',date:'2025-07-31',player_name:'Hermann',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'126',date:'2025-08-12',player_name:'David',buy_in:40.0,cash_out:28.1,rebuys:20.0,rebuy_count:1},
    {id:'127',date:'2025-08-12',player_name:'Max',buy_in:20.0,cash_out:53.0,rebuys:0.0,rebuy_count:0},
    {id:'128',date:'2025-08-12',player_name:'Eli',buy_in:20.0,cash_out:21.4,rebuys:0.0,rebuy_count:0},
    {id:'129',date:'2025-08-12',player_name:'Leo',buy_in:20.0,cash_out:46.5,rebuys:0.0,rebuy_count:0},
    {id:'130',date:'2025-08-12',player_name:'Big',buy_in:29.0,cash_out:0.0,rebuys:9.0,rebuy_count:0},
    {id:'131',date:'2025-08-12',player_name:'Simon',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'132',date:'2025-08-15',player_name:'David',buy_in:30.0,cash_out:0.0,rebuys:10.0,rebuy_count:0},
    {id:'133',date:'2025-08-15',player_name:'Jacky',buy_in:20.0,cash_out:19.7,rebuys:0.0,rebuy_count:0},
    {id:'134',date:'2025-08-15',player_name:'Max',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'135',date:'2025-08-15',player_name:'Paul',buy_in:20.0,cash_out:43.8,rebuys:0.0,rebuy_count:0},
    {id:'136',date:'2025-08-15',player_name:'Lino',buy_in:20.0,cash_out:66.9,rebuys:0.0,rebuy_count:0},
    {id:'137',date:'2025-09-23',player_name:'David',buy_in:20.0,cash_out:27.5,rebuys:0.0,rebuy_count:0},
    {id:'138',date:'2025-09-23',player_name:'Max',buy_in:40.0,cash_out:53.0,rebuys:20.0,rebuy_count:1},
    {id:'139',date:'2025-09-23',player_name:'Leo',buy_in:20.0,cash_out:85.2,rebuys:0.0,rebuy_count:0},
    {id:'140',date:'2025-09-23',player_name:'Big',buy_in:30.0,cash_out:0.0,rebuys:10.0,rebuy_count:0},
    {id:'141',date:'2025-09-23',player_name:'Flo',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'142',date:'2025-09-23',player_name:'Simon',buy_in:31.4,cash_out:0.0,rebuys:11.4,rebuy_count:1},
    {id:'143',date:'2025-09-27',player_name:'David',buy_in:30.0,cash_out:44.3,rebuys:10.0,rebuy_count:0},
    {id:'144',date:'2025-09-27',player_name:'Max',buy_in:20.0,cash_out:22.7,rebuys:0.0,rebuy_count:0},
    {id:'145',date:'2025-09-27',player_name:'Leo',buy_in:20.0,cash_out:38.5,rebuys:0.0,rebuy_count:0},
    {id:'146',date:'2025-09-27',player_name:'Benji',buy_in:40.0,cash_out:24.5,rebuys:20.0,rebuy_count:1},
    {id:'147',date:'2025-09-27',player_name:'Lino',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'148',date:'2025-10-09',player_name:'David',buy_in:40.0,cash_out:0.0,rebuys:20.0,rebuy_count:1},
    {id:'149',date:'2025-10-09',player_name:'Max',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'150',date:'2025-10-09',player_name:'Leo',buy_in:0.0,cash_out:52.0,rebuys:0.0,rebuy_count:0},
    {id:'151',date:'2025-10-09',player_name:'Big',buy_in:60.0,cash_out:46.1,rebuys:40.0,rebuy_count:2},
    {id:'152',date:'2025-10-09',player_name:'Benji',buy_in:20.0,cash_out:61.0,rebuys:0.0,rebuy_count:0},
    {id:'153',date:'2025-10-23',player_name:'David',buy_in:40.0,cash_out:0.0,rebuys:20.0,rebuy_count:1},
    {id:'154',date:'2025-10-23',player_name:'Max',buy_in:20.0,cash_out:21.4,rebuys:0.0,rebuy_count:0},
    {id:'155',date:'2025-10-23',player_name:'Leo',buy_in:20.0,cash_out:23.9,rebuys:0.0,rebuy_count:0},
    {id:'156',date:'2025-10-23',player_name:'Daniel',buy_in:20.0,cash_out:15.3,rebuys:0.0,rebuy_count:0},
    {id:'157',date:'2025-10-23',player_name:'Friedi',buy_in:20.0,cash_out:36.0,rebuys:0.0,rebuy_count:0},
    {id:'158',date:'2025-10-23',player_name:'Simon',buy_in:20.0,cash_out:25.0,rebuys:0.0,rebuy_count:0},
    {id:'159',date:'2025-10-23',player_name:'Luis',buy_in:20.0,cash_out:23.5,rebuys:0.0,rebuy_count:0},
    {id:'160',date:'2025-11-04',player_name:'Max',buy_in:20.0,cash_out:59.5,rebuys:0.0,rebuy_count:0},
    {id:'161',date:'2025-11-04',player_name:'Leo',buy_in:20.0,cash_out:46.9,rebuys:0.0,rebuy_count:0},
    {id:'162',date:'2025-11-04',player_name:'Big',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'163',date:'2025-11-04',player_name:'Stefan',buy_in:20.0,cash_out:12.4,rebuys:0.0,rebuy_count:0},
    {id:'164',date:'2025-11-04',player_name:'Simon',buy_in:20.0,cash_out:2.0,rebuys:0.0,rebuy_count:0},
    {id:'165',date:'2025-11-04',player_name:'Lino',buy_in:40.0,cash_out:0.0,rebuys:20.0,rebuy_count:1},
    {id:'166',date:'2025-11-19',player_name:'David',buy_in:20.0,cash_out:17.7,rebuys:0.0,rebuy_count:0},
    {id:'167',date:'2025-11-19',player_name:'Max',buy_in:40.0,cash_out:0.0,rebuys:20.0,rebuy_count:1},
    {id:'168',date:'2025-11-19',player_name:'Leo',buy_in:20.0,cash_out:21.2,rebuys:0.0,rebuy_count:0},
    {id:'169',date:'2025-11-19',player_name:'Big',buy_in:20.0,cash_out:93.5,rebuys:0.0,rebuy_count:0},
    {id:'170',date:'2025-11-19',player_name:'Simon',buy_in:20.0,cash_out:27.6,rebuys:0.0,rebuy_count:0},
    {id:'171',date:'2025-12-01',player_name:'David',buy_in:20.0,cash_out:60.9,rebuys:0.0,rebuy_count:0},
    {id:'172',date:'2025-12-01',player_name:'Max',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'173',date:'2025-12-01',player_name:'Leo',buy_in:20.0,cash_out:42.3,rebuys:0.0,rebuy_count:0},
    {id:'174',date:'2025-12-01',player_name:'Big',buy_in:40.0,cash_out:0.0,rebuys:20.0,rebuy_count:1},
    {id:'175',date:'2025-12-01',player_name:'Benji',buy_in:20.0,cash_out:69.6,rebuys:0.0,rebuy_count:0},
    {id:'176',date:'2025-12-01',player_name:'Stefan',buy_in:40.0,cash_out:0.0,rebuys:20.0,rebuy_count:1},
    {id:'177',date:'2025-12-07',player_name:'David',buy_in:20.0,cash_out:12.9,rebuys:0.0,rebuy_count:0},
    {id:'178',date:'2025-12-07',player_name:'Max',buy_in:20.0,cash_out:51.9,rebuys:0.0,rebuy_count:0},
    {id:'179',date:'2025-12-07',player_name:'Leo',buy_in:40.0,cash_out:0.0,rebuys:20.0,rebuy_count:1},
    {id:'180',date:'2025-12-07',player_name:'Benji',buy_in:40.0,cash_out:53.2,rebuys:20.0,rebuy_count:1},
    {id:'181',date:'2025-12-07',player_name:'Simon',buy_in:20.0,cash_out:34.1,rebuys:0.0,rebuy_count:0},
    {id:'182',date:'2025-12-07',player_name:'Lino',buy_in:20.0,cash_out:47.7,rebuys:0.0,rebuy_count:0},
    {id:'183',date:'2025-12-18',player_name:'David',buy_in:20.0,cash_out:41.5,rebuys:0.0,rebuy_count:0},
    {id:'184',date:'2025-12-18',player_name:'Max',buy_in:20.0,cash_out:33.3,rebuys:0.0,rebuy_count:0},
    {id:'185',date:'2025-12-18',player_name:'Eli',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'186',date:'2025-12-18',player_name:'Leo',buy_in:40.0,cash_out:26.2,rebuys:20.0,rebuy_count:1},
    {id:'187',date:'2025-12-18',player_name:'Big',buy_in:20.0,cash_out:38.1,rebuys:0.0,rebuy_count:0},
    {id:'188',date:'2025-12-18',player_name:'Friedi',buy_in:40.0,cash_out:0.0,rebuys:20.0,rebuy_count:1},
    {id:'189',date:'2025-12-18',player_name:'Simon',buy_in:40.0,cash_out:44.7,rebuys:20.0,rebuy_count:1},
    {id:'190',date:'2025-12-18',player_name:'Luis',buy_in:25.0,cash_out:31.6,rebuys:5.0,rebuy_count:0},
    {id:'191',date:'2025-12-25',player_name:'David',buy_in:20.0,cash_out:55.2,rebuys:0.0,rebuy_count:0},
    {id:'192',date:'2025-12-25',player_name:'Jacky',buy_in:20.0,cash_out:23.0,rebuys:0.0,rebuy_count:0},
    {id:'193',date:'2025-12-25',player_name:'Max',buy_in:30.0,cash_out:36.3,rebuys:10.0,rebuy_count:0},
    {id:'194',date:'2025-12-25',player_name:'Leo',buy_in:20.0,cash_out:26.6,rebuys:0.0,rebuy_count:0},
    {id:'195',date:'2025-12-25',player_name:'Paul',buy_in:35.0,cash_out:39.4,rebuys:15.0,rebuy_count:1},
    {id:'196',date:'2025-12-25',player_name:'Hermann',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'197',date:'2025-12-25',player_name:'Simon',buy_in:36.0,cash_out:0.0,rebuys:16.0,rebuy_count:1},
    {id:'198',date:'2025-12-30',player_name:'David',buy_in:40.0,cash_out:10.5,rebuys:20.0,rebuy_count:1},
    {id:'199',date:'2025-12-30',player_name:'Max',buy_in:40.0,cash_out:0.0,rebuys:20.0,rebuy_count:1},
    {id:'200',date:'2025-12-30',player_name:'Paul',buy_in:40.0,cash_out:81.4,rebuys:20.0,rebuy_count:1},
    {id:'201',date:'2025-12-30',player_name:'Benji',buy_in:60.0,cash_out:0.0,rebuys:40.0,rebuy_count:2},
    {id:'202',date:'2026-01-02',player_name:'David',buy_in:20.0,cash_out:59.2,rebuys:0.0,rebuy_count:0},
    {id:'203',date:'2026-01-02',player_name:'Paul',buy_in:20.0,cash_out:48.3,rebuys:0.0,rebuy_count:0},
    {id:'204',date:'2026-01-02',player_name:'Big',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'205',date:'2026-01-02',player_name:'Simon',buy_in:40.0,cash_out:15.5,rebuys:20.0,rebuy_count:1},
    {id:'206',date:'2026-01-02',player_name:'Friedi',buy_in:60.0,cash_out:63.0,rebuys:40.0,rebuy_count:2},
    {id:'207',date:'2026-01-02',player_name:'Lino',buy_in:40.0,cash_out:0.0,rebuys:20.0,rebuy_count:1},
    {id:'208',date:'2026-01-02',player_name:'Hermann',buy_in:20.0,cash_out:36.5,rebuys:0.0,rebuy_count:0},
    {id:'209',date:'2026-01-09',player_name:'David',buy_in:20.0,cash_out:64.1,rebuys:0.0,rebuy_count:0},
    {id:'210',date:'2026-01-09',player_name:'Max',buy_in:60.0,cash_out:0.0,rebuys:40.0,rebuy_count:2},
    {id:'211',date:'2026-01-09',player_name:'Leo',buy_in:20.0,cash_out:30.0,rebuys:0.0,rebuy_count:0},
    {id:'212',date:'2026-01-09',player_name:'Paul',buy_in:60.0,cash_out:69.9,rebuys:40.0,rebuy_count:2},
    {id:'213',date:'2026-01-09',player_name:'Big',buy_in:40.0,cash_out:0.0,rebuys:20.0,rebuy_count:1},
    {id:'214',date:'2026-01-09',player_name:'Simon',buy_in:20.0,cash_out:43.0,rebuys:0.0,rebuy_count:0},
    {id:'215',date:'2026-01-09',player_name:'Luis',buy_in:20.0,cash_out:63.0,rebuys:0.0,rebuy_count:0},
    {id:'216',date:'2026-01-09',player_name:'Friedl',buy_in:60.0,cash_out:23.9,rebuys:40.0,rebuy_count:2},
    {id:'217',date:'2026-01-31',player_name:'David',buy_in:30.0,cash_out:14.1,rebuys:10.0,rebuy_count:0},
    {id:'218',date:'2026-01-31',player_name:'Leo',buy_in:20.0,cash_out:35.7,rebuys:0.0,rebuy_count:0},
    {id:'219',date:'2026-01-31',player_name:'Big',buy_in:20.0,cash_out:10.0,rebuys:0.0,rebuy_count:0},
    {id:'220',date:'2026-01-31',player_name:'Benji',buy_in:20.0,cash_out:61.6,rebuys:0.0,rebuy_count:0},
    {id:'221',date:'2026-01-31',player_name:'Simon',buy_in:20.0,cash_out:27.0,rebuys:0.0,rebuy_count:0},
    {id:'222',date:'2026-01-31',player_name:'Hermann',buy_in:40.0,cash_out:0.0,rebuys:20.0,rebuy_count:1},
    {id:'223',date:'2026-01-31',player_name:'Madrasch',buy_in:30.0,cash_out:41.1,rebuys:10.0,rebuy_count:0},
    {id:'224',date:'2026-02-12',player_name:'David',buy_in:20.0,cash_out:69.5,rebuys:0.0,rebuy_count:0},
    {id:'225',date:'2026-02-12',player_name:'Max',buy_in:80.0,cash_out:0.0,rebuys:60.0,rebuy_count:3},
    {id:'226',date:'2026-02-12',player_name:'Leo',buy_in:20.0,cash_out:74.5,rebuys:0.0,rebuy_count:0},
    {id:'227',date:'2026-02-12',player_name:'Paul',buy_in:80.0,cash_out:65.6,rebuys:60.0,rebuy_count:3},
    {id:'228',date:'2026-02-12',player_name:'Big',buy_in:20.0,cash_out:0.0,rebuys:0.0,rebuy_count:0},
    {id:'229',date:'2026-02-12',player_name:'Madrasch',buy_in:40.0,cash_out:30.0,rebuys:20.0,rebuy_count:1},
    {id:'230',date:'2026-02-12',player_name:'Tobi',buy_in:20.0,cash_out:20.0,rebuys:0.0,rebuy_count:0},
    {id:'231',date:'2026-02-15',player_name:'David',buy_in:20.0,cash_out:41.8,rebuys:0.0,rebuy_count:0},
    {id:'232',date:'2026-02-15',player_name:'Max',buy_in:50.0,cash_out:7.3,rebuys:30.0,rebuy_count:2},
    {id:'233',date:'2026-02-15',player_name:'Benji',buy_in:20.0,cash_out:94.3,rebuys:0.0,rebuy_count:0},
    {id:'234',date:'2026-02-15',player_name:'Lino',buy_in:20.0,cash_out:40.0,rebuys:0.0,rebuy_count:0},
    {id:'235',date:'2026-02-15',player_name:'Madrasch',buy_in:35.0,cash_out:41.0,rebuys:15.0,rebuy_count:1},
    {id:'236',date:'2026-02-15',player_name:'Creme',buy_in:80.0,cash_out:0.0,rebuys:60.0,rebuy_count:3},
    {id:'237',date:'2026-02-18',player_name:'Max',buy_in:50.0,cash_out:54.0,rebuys:30.0,rebuy_count:2},
    {id:'238',date:'2026-02-18',player_name:'Benji',buy_in:25.0,cash_out:45.3,rebuys:5.0,rebuy_count:0},
    {id:'239',date:'2026-02-18',player_name:'Friedi',buy_in:25.0,cash_out:85.0,rebuys:5.0,rebuy_count:0},
    {id:'240',date:'2026-02-18',player_name:'Lino',buy_in:75.0,cash_out:0.0,rebuys:55.0,rebuy_count:3},
    {id:'241',date:'2026-02-18',player_name:'Madrasch',buy_in:75.0,cash_out:40.0,rebuys:55.0,rebuy_count:3},
    {id:'242',date:'2026-02-18',player_name:'Phips',buy_in:25.0,cash_out:25.0,rebuys:5.0,rebuy_count:0},
    {id:'243',date:'2026-02-21',player_name:'David',buy_in:20.0,cash_out:20.9,rebuys:0.0,rebuy_count:0},
    {id:'244',date:'2026-02-21',player_name:'Max',buy_in:20.0,cash_out:21.2,rebuys:0.0,rebuy_count:0},
    {id:'245',date:'2026-02-21',player_name:'Hermann',buy_in:40.0,cash_out:0.0,rebuys:20.0,rebuy_count:1},
    {id:'246',date:'2026-02-21',player_name:'Luis',buy_in:40.0,cash_out:51.8,rebuys:20.0,rebuy_count:1},
    {id:'247',date:'2026-02-21',player_name:'Daniel',buy_in:20.0,cash_out:60.3,rebuys:0.0,rebuy_count:0},
    {id:'248',date:'2026-02-21',player_name:'Matthias',buy_in:20.0,cash_out:5.8,rebuys:0.0,rebuy_count:0},
    {id:'249',date:'2026-02-22',player_name:'David',buy_in:20.0,cash_out:30.0,rebuys:0.0,rebuy_count:0},
    {id:'250',date:'2026-02-22',player_name:'Big',buy_in:20.0,cash_out:63.7,rebuys:0.0,rebuy_count:0},
    {id:'251',date:'2026-02-22',player_name:'Benji',buy_in:20.0,cash_out:42.3,rebuys:0.0,rebuy_count:0},
    {id:'252',date:'2026-02-22',player_name:'Madrasch',buy_in:20.0,cash_out:65.0,rebuys:0.0,rebuy_count:0},
    {id:'253',date:'2026-02-22',player_name:'Creme',buy_in:80.0,cash_out:0.0,rebuys:60.0,rebuy_count:3},
    {id:'254',date:'2026-02-22',player_name:'Stefan',buy_in:40.0,cash_out:0.0,rebuys:20.0,rebuy_count:1},
  ];
}
</script>

<!--
============================================================
  SQL â€“ In Supabase unter SQL-Editor ausfÃ¼hren
============================================================

create table poker_sessions (
  id          uuid primary key default gen_random_uuid(),
  created_at  timestamptz default now(),
  date        date not null,
  player_name text not null,
  buy_in      numeric(10,2) not null default 0,
  cash_out    numeric(10,2) not null default 0
);

-- Row Level Security (optional, aber empfohlen):
alter table poker_sessions enable row level security;

-- Alle dÃ¼rfen lesen:
create policy "Jeder kann lesen"
  on poker_sessions for select using (true);

-- Alle dÃ¼rfen schreiben (fÃ¼r Ã¶ffentliche Nutzung unter Freunden):
create policy "Jeder kann schreiben"
  on poker_sessions for insert with check (true);

-- Alle dÃ¼rfen lÃ¶schen:
create policy "Jeder kann lÃ¶schen"
  on poker_sessions for delete using (true);

-- Realtime aktivieren:
alter publication supabase_realtime add table poker_sessions;

============================================================
-->
</body>
</html>
